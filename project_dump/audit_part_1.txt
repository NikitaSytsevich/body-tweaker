=== PROJECT STRUCTURE ===
ğŸ“‚ ./
    ğŸ“„ tsconfig.node.json
    ğŸ“„ index.html
    ğŸ“„ tailwind.config.js
    ğŸ“„ tsconfig.app.json
    ğŸ“„ prepare_audit.py
    ğŸ“„ setup-bot.js
    ğŸ“„ README.md
    ğŸ“„ .gitignore
    ğŸ“„ package.json
    ğŸ“„ .env
    ğŸ“„ tsconfig.json
    ğŸ“„ eslint.config.js
    ğŸ“„ vite.config.ts
    ğŸ“„ postcss.config.js
    ğŸ“„ generate-icons.js
    ğŸ“‚ public/
        ğŸ“„ manifest.json
        ğŸ“‚ sounds/
    ğŸ“‚ api/
        ğŸ“„ webhook.ts
    ğŸ“‚ project_dump/
    ğŸ“‚ src/
        ğŸ“„ App.tsx
        ğŸ“„ main.tsx
        ğŸ“„ App.css
        ğŸ“„ index.css
        ğŸ“‚ core/
        ğŸ“‚ app/
            ğŸ“„ WelcomeScreen.tsx
            ğŸ“„ Layout.tsx
            ğŸ“‚ modals/
                ğŸ“„ InstallGuideModal.tsx
                ğŸ“„ InfoModal.tsx
                ğŸ“„ SettingsModal.tsx
        ğŸ“‚ features/
            ğŸ“‚ breathing/
                ğŸ“„ BreathingPage.tsx
                ğŸ“‚ components/
                    ğŸ“„ BreathingCircle.tsx
                    ğŸ“„ SoundSheet.tsx
                    ğŸ“„ InfoSheet.tsx
                    ğŸ“„ VolumeSlider.tsx
                    ğŸ“„ BreathingStartModal.tsx
                    ğŸ“„ SoundMixer.tsx
                ğŸ“‚ hooks/
                    ğŸ“„ useBreathingSession.ts
                ğŸ“‚ data/
                    ğŸ“„ patterns.ts
            ğŸ“‚ fasting/
                ğŸ“„ FastingPage.tsx
                ğŸ“„ MetabolismMapPage.tsx
                ğŸ“‚ context/
                    ğŸ“„ TimerContext.tsx
                ğŸ“‚ components/
                    ğŸ“„ ProtocolDetails.tsx
                    ğŸ“„ SovietProtocolSheet.tsx
                    ğŸ“„ AnabolicState.tsx
                    ğŸ“„ TimerRing.tsx
                    ğŸ“„ ProtocolSelector.tsx
                    ğŸ“„ PhasesList.tsx
                    ğŸ“„ FastingStartModal.tsx
                    ğŸ“„ PhaseSheet.tsx
                ğŸ“‚ hooks/
                    ğŸ“„ useFastingTimer.ts
                ğŸ“‚ data/
                    ğŸ“„ schemes.ts
                    ğŸ“„ stages.ts
                    ğŸ“„ preparationSteps.ts
            ğŸ“‚ history/
                ğŸ“„ HistoryPage.tsx
                ğŸ“‚ types/
                ğŸ“‚ components/
                    ğŸ“„ RecordDetails.tsx
                ğŸ“‚ hooks/
            ğŸ“‚ biorhythm/
                ğŸ“„ BiorhythmPage.tsx
                ğŸ“‚ components/
                    ğŸ“„ StatsGrid.tsx
                    ğŸ“„ BiorhythmChart.tsx
                ğŸ“‚ hooks/
                    ğŸ“„ useBiorhythms.ts
        ğŸ“‚ utils/
            ğŸ“„ cn.ts
            ğŸ“„ storage.ts
            ğŸ“„ types.ts
            ğŸ“„ sounds.ts
        ğŸ“‚ components/
            ğŸ“‚ ui/
                ğŸ“„ DatePicker.tsx
                ğŸ“„ ConfirmModal.tsx
                ğŸ“„ ToastNotification.tsx
                ğŸ“„ Modal.tsx
                ğŸ“„ SegmentedControl.tsx
        ğŸ“‚ hooks/
            ğŸ“„ useStorage.ts
            ğŸ“„ useAddToHomeScreen.ts
        ğŸ“‚ assets/

=== FILE CONTENTS ===

====================
START FILE: tsconfig.node.json
====================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}

====================
END FILE: tsconfig.node.json
====================

====================
START FILE: index.html
====================
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    
    <!-- 1. Ğ¤Ğ°Ğ²Ğ¸ĞºĞ¾Ğ½ĞºĞ° Ğ´Ğ»Ñ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ° (SVG) -->
    <link rel="icon" type="image/svg+xml" href="/logo.svg" />
    
    <!-- 2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ²ÑŒÑĞ¿Ğ¾Ñ€Ñ‚Ğ°: Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ğ°ĞµĞ¼ Ğ·ÑƒĞ¼ (user-scalable=no) Ğ´Ğ»Ñ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸Ñ Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- 3. Ğ¦Ğ²ĞµÑ‚ Ñ‚ĞµĞ¼Ñ‹: ĞºÑ€Ğ°ÑĞ¸Ñ‚ Ğ°Ğ´Ñ€ĞµÑĞ½ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ° Ğ² Ñ†Ğ²ĞµÑ‚ Ñ„Ğ¾Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ -->
    <meta name="theme-color" content="#F2F2F7" />
    
    <!-- ================= PWA SETTINGS ================= -->

    <!-- Android: Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚ (Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ¸ĞºĞ¾Ğ½ĞºĞ¸, Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°) -->
    <link rel="manifest" href="/manifest.json" />

    <!-- iOS: Ğ˜ĞºĞ¾Ğ½ĞºĞ° Ğ´Ğ»Ñ ÑĞºÑ€Ğ°Ğ½Ğ° "Ğ”Ğ¾Ğ¼Ğ¾Ğ¹" (iPhone Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚ Ğ´Ğ»Ñ Ğ¸ĞºĞ¾Ğ½Ğ¾Ğº) -->
    <!-- Ğ¤Ğ°Ğ¹Ğ» apple-touch-icon.png Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ»ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ² Ğ¿Ğ°Ğ¿ĞºĞµ /public -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    
    <!-- iOS: Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ñ€ĞµĞ¶Ğ¸Ğ¼ "Standalone" (ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ°Ğ´Ñ€ĞµÑĞ½ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Safari Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸) -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <!-- iOS: ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ´ Ğ¸ĞºĞ¾Ğ½ĞºĞ¾Ğ¹ -->
    <meta name="apple-mobile-web-app-title" content="Body Tweaker" />
    
    <!-- iOS: Ğ¦Ğ²ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ-Ğ±Ğ°Ñ€Ğ° (default - Ğ±ĞµĞ»Ñ‹Ğ¹/Ñ‡ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ‚ĞµĞ¼Ñ‹, black-translucent - Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ñ‹Ğ¹) -->
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <!-- ================================================ -->

    <title>Body Tweaker</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

====================
END FILE: index.html
====================

====================
START FILE: tailwind.config.js
====================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      padding: {
        'safe': 'env(safe-area-inset-bottom)',
      }
    },
  },
  plugins: [],
}

====================
END FILE: tailwind.config.js
====================

====================
START FILE: tsconfig.app.json
====================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}

====================
END FILE: tsconfig.app.json
====================

====================
START FILE: prepare_audit.py
====================
import os
import fnmatch

# ================= ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ =================
# ĞŸĞ°Ğ¿ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ´Ğ»Ñ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
PROJECT_ROOT = "." 

# ĞŸĞ°Ğ¿ĞºĞ° ĞºÑƒĞ´Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ Ğ´Ğ°Ğ¼Ğ¿Ñ‹
OUTPUT_DIR = "./project_dump" 

# ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ ÑÑ‚Ñ€Ğ¾Ğº Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ-Ğ´Ğ°Ğ¼Ğ¿Ğµ (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾)
MAX_LINES_PER_PART = 5000 

# Ğ§Ñ‚Ğ¾ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ (Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸ Ğ¿Ğ°Ğ¿ĞºĞ¸) - Ğ­ĞšĞĞĞĞœĞ˜Ğœ Ğ¢ĞĞšĞ•ĞĞ«
IGNORE_PATTERNS = [
    # Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¸ Git
    ".git", ".DS_Store", ".idea", ".vscode", "__pycache__",
    
    # Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ±Ğ¸Ğ»Ğ´Ñ‹
    "node_modules", "dist", "build", "coverage", "venv", "env",
    
    # ĞœĞµĞ´Ğ¸Ğ° Ğ¸ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ğ¸ĞºĞ¸ (AI Ğ¾Ğ½Ğ¸ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ñ‹)
    "*.png", "*.jpg", "*.jpeg", "*.gif", "*.ico", "*.svg", 
    "*.mp3", "*.mp4", "*.wav", "*.pdf", "*.zip", "*.tar.gz",
    "*.pyc", "*.exe", "*.dll", "*.so",
    
    # Ğ›Ğ¾Ğº-Ñ„Ğ°Ğ¹Ğ»Ñ‹ (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¼ÑƒÑĞ¾Ñ€ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸)
    "package-lock.json", "yarn.lock", "pnpm-lock.yaml", "poetry.lock"
]

# ================= Ğ›ĞĞ“Ğ˜ĞšĞ =================

def should_ignore(path):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»/Ğ¿Ğ°Ğ¿ĞºÑƒ."""
    name = os.path.basename(path)
    for pattern in IGNORE_PATTERNS:
        if fnmatch.fnmatch(name, pattern):
            return True
    return False

def get_file_tree(start_path):
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´ĞµÑ€ĞµĞ²Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹."""
    tree_str = "=== PROJECT STRUCTURE ===\n"
    for root, dirs, files in os.walk(start_path):
        # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ°Ğ¿Ğ¾Ğº Ğ½Ğ° Ğ»ĞµÑ‚Ñƒ
        dirs[:] = [d for d in dirs if not should_ignore(os.path.join(root, d))]
        
        level = root.replace(start_path, '').count(os.sep)
        indent = '    ' * level
        tree_str += f"{indent}ğŸ“‚ {os.path.basename(root)}/\n"
        subindent = '    ' * (level + 1)
        for f in files:
            if not should_ignore(f):
                tree_str += f"{subindent}ğŸ“„ {f}\n"
    tree_str += "\n=== FILE CONTENTS ===\n"
    return tree_str

def is_text_file(file_path):
    """ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°, Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ğ¸ĞºĞ¸)."""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            f.read(1024)
        return True
    except (UnicodeDecodeError, IOError):
        return False

def main():
    if not os.path.exists(OUTPUT_DIR):
        os.makedirs(OUTPUT_DIR)

    part_num = 1
    current_lines = 0
    current_content = []
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸
    print("â³ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°...")
    structure = get_file_tree(PROJECT_ROOT)
    current_content.append(structure)
    current_lines += structure.count('\n')

    print("ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²...")
    
    for root, dirs, files in os.walk(PROJECT_ROOT):
        # Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½ĞµĞ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸
        dirs[:] = [d for d in dirs if not should_ignore(os.path.join(root, d))]
        
        for file in files:
            file_path = os.path.join(root, file)
            
            if should_ignore(file_path):
                continue
                
            if not is_text_file(file_path):
                continue

            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    
                # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°
                file_block = (
                    f"\n====================\n"
                    f"START FILE: {os.path.relpath(file_path, PROJECT_ROOT)}\n"
                    f"====================\n"
                    f"{content}\n"
                    f"====================\n"
                    f"END FILE: {os.path.relpath(file_path, PROJECT_ROOT)}\n"
                    f"====================\n"
                )
                
                block_lines = file_block.count('\n')
                
                # Ğ•ÑĞ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑÑ -> ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ
                if current_lines + block_lines > MAX_LINES_PER_PART and current_lines > 0:
                    output_filename = os.path.join(OUTPUT_DIR, f"audit_part_{part_num}.txt")
                    with open(output_filename, 'w', encoding='utf-8') as out_f:
                        out_f.write("".join(current_content))
                    
                    print(f"âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ñ„Ğ°Ğ¹Ğ»: {output_filename} ({current_lines} ÑÑ‚Ñ€Ğ¾Ğº)")
                    
                    # Ğ¡Ğ±Ñ€Ğ¾Ñ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸ĞºĞ¾Ğ²
                    part_num += 1
                    current_content = []
                    current_lines = 0

                current_content.append(file_block)
                current_lines += block_lines
                
            except Exception as e:
                print(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° {file_path}: {e}")

    # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº
    if current_content:
        output_filename = os.path.join(OUTPUT_DIR, f"audit_part_{part_num}.txt")
        with open(output_filename, 'w', encoding='utf-8') as out_f:
            out_f.write("".join(current_content))
        print(f"âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ñ„Ğ°Ğ¹Ğ»: {output_filename} ({current_lines} ÑÑ‚Ñ€Ğ¾Ğº)")

    print(f"\nğŸ‰ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ»ĞµĞ¶Ğ°Ñ‚ Ğ² Ğ¿Ğ°Ğ¿ĞºĞµ: {OUTPUT_DIR}")

if __name__ == "__main__":
    main()

====================
END FILE: prepare_audit.py
====================

====================
START FILE: setup-bot.js
====================
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ĞŸÑƒÑ‚ÑŒ: /api/webhook.ts
const dirPath = path.join(__dirname, 'api');
const filePath = path.join(dirPath, 'webhook.ts');

// ĞšĞ¾Ğ´ Ğ²ĞµĞ±Ñ…ÑƒĞºĞ°
const fileContent = `import type { VercelRequest, VercelResponse } from '@vercel/node';

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const WEB_APP_URL = process.env.WEB_APP_URL || 'https://body-tweaker.vercel.app'; 

export default async function handler(request: VercelRequest, response: VercelResponse) {
  try {
    if (request.method !== 'POST') {
      return response.status(200).send('Bot is alive!');
    }

    const body = request.body;
    console.log('Incoming update:', JSON.stringify(body));

    if (body.message && body.message.text) {
      const chatId = body.message.chat.id;
      const text = body.message.text;

      if (text === '/start') {
        await sendWelcomeMessage(chatId);
      } else {
        await sendMessage(chatId, 'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ğŸ‘‡');
      }
    }

    return response.status(200).json({ ok: true });

  } catch (error) {
    console.error('Error:', error);
    return response.status(500).json({ error: 'Internal Server Error' });
  }
}

async function sendWelcomeMessage(chatId: number) {
  const url = \`https://api.telegram.org/bot\${BOT_TOKEN}/sendPhoto\`;
  const photoUrl = \`\${WEB_APP_URL}/icon-512.png\`;

  const payload = {
    chat_id: chatId,
    photo: photoUrl,
    caption: \`ğŸ§¬ *Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Body Tweaker!*\\n\\nĞ­Ñ‚Ğ¾ Ğ²Ğ°Ñˆ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼Ğ¾Ğ¼, Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¸ Ğ±Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ°Ğ¼Ğ¸.\\n\\nĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ.\`,
    parse_mode: 'Markdown',
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Body Tweaker",
            web_app: { url: WEB_APP_URL }
          }
        ]
      ]
    }
  };

  await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

async function sendMessage(chatId: number, text: string) {
  const url = \`https://api.telegram.org/bot\${BOT_TOKEN}/sendMessage\`;
  
  const payload = {
    chat_id: chatId,
    text: text,
    reply_markup: {
        inline_keyboard: [
          [
            {
              text: "ğŸš€ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ",
              web_app: { url: WEB_APP_URL }
            }
          ]
        ]
      }
  };

  await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}`;

// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ¸ Ñ„Ğ°Ğ¹Ğ»
try {
    if (!fs.existsSync(dirPath)) {
        fs.mkdirSync(dirPath);
        console.log('ğŸ“ ĞŸĞ°Ğ¿ĞºĞ° /api ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°');
    }
    
    fs.writeFileSync(filePath, fileContent);
    console.log('âœ… Ğ¤Ğ°Ğ¹Ğ» /api/webhook.ts ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ ĞºĞ¾Ğ´Ğ¾Ğ¼');
    
} catch (err) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°:', err);
}

====================
END FILE: setup-bot.js
====================

====================
START FILE: README.md
====================
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

====================
END FILE: README.md
====================

====================
START FILE: .gitignore
====================
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

====================
END FILE: .gitignore
====================

====================
START FILE: package.json
====================
{
  "name": "body-tweaker",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@twa-dev/sdk": "^8.0.2",
    "@types/crypto-js": "^4.2.2",
    "clsx": "^2.1.1",
    "crypto-js": "^4.2.0",
    "dayjs": "^1.11.19",
    "framer-motion": "^12.26.1",
    "html2canvas": "^1.4.1",
    "lucide-react": "^0.562.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.12.0",
    "recharts": "^3.6.0",
    "tailwind-merge": "^3.4.0",
    "use-sound": "^5.0.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vercel/node": "^5.5.23",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.17",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.4.35",
    "sharp": "^0.34.5",
    "tailwindcss": "^3.4.1",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}

====================
END FILE: package.json
====================

====================
START FILE: .env
====================
VITE_STORAGE_KEY=AnyRandomStringHere123
====================
END FILE: .env
====================

====================
START FILE: tsconfig.json
====================
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}

====================
END FILE: tsconfig.json
====================

====================
START FILE: eslint.config.js
====================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])

====================
END FILE: eslint.config.js
====================

====================
START FILE: vite.config.ts
====================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})

====================
END FILE: vite.config.ts
====================

====================
START FILE: postcss.config.js
====================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

====================
END FILE: postcss.config.js
====================

====================
START FILE: generate-icons.js
====================
import sharp from 'sharp';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿ÑƒÑ‚Ğ¸ (Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ ES Modules)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const SOURCE_FILE = path.join(__dirname, 'public', 'logo.svg');
const PUBLIC_DIR = path.join(__dirname, 'public');

// Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸ĞºĞ¾Ğ½Ğ¾Ğº, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
const targets = [
  { name: 'icon-192.png', size: 192 },
  { name: 'icon-512.png', size: 512 },
  // Ğ”Ğ»Ñ iOS Ğ´ĞµĞ»Ğ°ĞµĞ¼ 180x180. 
  // ĞœÑ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ flatten, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ (iOS Ğ»ÑĞ±Ğ¸Ñ‚ Ğ½ĞµĞ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ñ‹Ğµ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸)
  // Ğ¸ Ğ·Ğ°Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ¼ Ñ„Ğ¾Ğ½Ğ° Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ğ° (#0F172A), Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ñ‡ĞµÑ€Ğ½Ñ‹Ñ… Ñ€Ğ°Ğ¼Ğ¾Ğº.
  { name: 'apple-touch-icon.png', size: 180, bg: '#0F172A' }
];

async function generate() {
  if (!fs.existsSync(SOURCE_FILE)) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ñ„Ğ°Ğ¹Ğ» public/logo.svg');
    process.exit(1);
  }

  console.log('ğŸ¨ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ĞºĞ¾Ğ½Ğ¾Ğº...');

  for (const target of targets) {
    const outputPath = path.join(PUBLIC_DIR, target.name);
    
    let pipeline = sharp(SOURCE_FILE).resize(target.size, target.size);

    // Ğ•ÑĞ»Ğ¸ ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ñ„Ğ¾Ğ½ (Ğ´Ğ»Ñ iOS), Ğ½Ğ°ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµĞ¼ ĞµĞ³Ğ¾
    if (target.bg) {
      pipeline = pipeline.flatten({ background: target.bg });
    }

    await pipeline.png().toFile(outputPath);
    console.log(`âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½: public/${target.name} (${target.size}x${target.size})`);
  }

  console.log('ğŸ‰ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ˜ĞºĞ¾Ğ½ĞºĞ¸ Ğ»ĞµĞ¶Ğ°Ñ‚ Ğ² Ğ¿Ğ°Ğ¿ĞºĞµ public.');
}

generate().catch(err => {
  console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:', err);
});

====================
END FILE: generate-icons.js
====================

====================
START FILE: public/manifest.json
====================
{
  "name": "Body Tweaker",
  "short_name": "Body Tweaker",
  "description": "Scientific Biohacking Tools",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#F2F2F7",
  "theme_color": "#F2F2F7",
  "icons": [
    {
      "src": "/icon-192.png",
      "type": "image/png",
      "sizes": "192x192"
    },
    {
      "src": "/icon-512.png",
      "type": "image/png",
      "sizes": "512x512"
    },
    {
      "src": "/icon-512.png",
      "type": "image/png",
      "sizes": "512x512",
      "purpose": "maskable"
    }
  ]
}

====================
END FILE: public/manifest.json
====================

====================
START FILE: api/webhook.ts
====================
import type { VercelRequest, VercelResponse } from '@vercel/node';

// Ğ­Ñ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Vercel
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const WEB_APP_URL = process.env.WEB_APP_URL; 

export default async function handler(request: VercelRequest, response: VercelResponse) {
  // 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ POST Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚ Ğ¢ĞµĞ»ĞµĞ³Ñ€Ğ°Ğ¼Ğ°
  if (request.method !== 'POST') {
    return response.status(200).send('Bot is active!');
  }

  try {
    const body = request.body;

    // 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    if (body.message && body.message.text) {
      const chatId = body.message.chat.id;
      const text = body.message.text;

      // 3. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
      if (text === '/start') {
        await sendWelcome(chatId);
      } else {
        // ĞĞ° Ğ»ÑĞ±Ğ¾Ğ¹ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ñ‚ĞµĞºÑÑ‚ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞ°
        await sendMessage(chatId, 'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ğŸ‘‡');
      }
    }

    // 4. Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµĞ¼ 200 OK, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¢ĞµĞ»ĞµĞ³Ñ€Ğ°Ğ¼ Ğ½Ğµ ÑĞ»Ğ°Ğ» Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ñ‹
    return response.status(200).json({ ok: true });

  } catch (error) {
    console.error('Error sending message:', error);
    return response.status(200).json({ ok: false }); // Ğ’ÑĞµ Ñ€Ğ°Ğ²Ğ½Ğ¾ 200, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ·Ğ°Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‚ÑŒ
  }
}

// --- Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ñ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¾Ğ¹ ---
async function sendWelcome(chatId: number) {
  const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`;
  
  // Ğ‘ĞµÑ€ĞµĞ¼ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ Ğ¿Ñ€ÑĞ¼Ğ¾ Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ ÑĞ°Ğ¹Ñ‚Ğ°
  const photoUrl = `${WEB_APP_URL}/icon-512.png`;

  const payload = {
    chat_id: chatId,
    photo: photoUrl,
    caption: `ğŸ§¬ *Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Body Tweaker!*\n\nĞ­Ñ‚Ğ¾ Ğ²Ğ°Ñˆ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ±Ğ¸Ğ¾Ñ…Ğ°ĞºĞ¸Ğ½Ğ³Ğ°:\n\nâ€¢ Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ\nâ€¢ Ğ”Ñ‹Ñ…Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¸\nâ€¢ Ğ‘Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ñ‹\n\nĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ.`,
    parse_mode: 'Markdown',
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ",
            web_app: { url: WEB_APP_URL } // ğŸ‘ˆ Ğ­Ñ‚Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Mini App
          }
        ]
      ]
    }
  };

  await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

// --- Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯: ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ ---
async function sendMessage(chatId: number, text: string) {
  const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
  
  const payload = {
    chat_id: chatId,
    text: text,
    reply_markup: {
        inline_keyboard: [
          [
            {
              text: "ğŸš€ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Body Tweaker",
              web_app: { url: WEB_APP_URL }
            }
          ]
        ]
      }
  };

  await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

====================
END FILE: api/webhook.ts
====================

====================
START FILE: src/App.tsx
====================
// src/App.tsx
import { useState, useEffect } from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { Layout } from './app/Layout';
import { WelcomeScreen } from './app/WelcomeScreen';
import { TimerProvider } from './features/fasting/context/TimerContext';
import { storageGet } from './utils/storage'; // ğŸ‘ˆ NEW

function App() {
  const [showWelcome, setShowWelcome] = useState<boolean | null>(null);

  useEffect(() => {
      const checkFirstRun = async () => {
          const accepted = await storageGet('has_accepted_terms');
          setShowWelcome(accepted !== 'true');
      };
      checkFirstRun();
  }, []);

  if (showWelcome === null) {
      // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ°Ğ´ĞµÑ€, Ğ½Ğ¾ Ğ±ĞµĞ»Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½ Ğ½Ğ° < 100ms Ñ‚Ğ¾Ğ¶Ğµ Ğ¾Ğº
      return null; 
  }

  if (showWelcome) {
      return <WelcomeScreen onComplete={() => setShowWelcome(false)} />;
  }

  return (
    <TimerProvider>
      <BrowserRouter>
        <Routes>
          <Route path="*" element={<Layout />} />
        </Routes>
      </BrowserRouter>
    </TimerProvider>
  );
}

export default App;

====================
END FILE: src/App.tsx
====================

====================
START FILE: src/main.tsx
====================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import './index.css'
import WebApp from '@twa-dev/sdk' // ğŸ‘ˆ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
WebApp.ready();

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ²Ğ½ĞµÑˆĞ½ĞµĞ³Ğ¾ Ğ²Ğ¸Ğ´Ğ° (Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼ Ğ½Ğ° Ğ²ĞµÑÑŒ ÑĞºÑ€Ğ°Ğ½)
WebApp.expand();

// ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ†Ğ²ĞµÑ‚ Ñ…ĞµĞ´ĞµÑ€Ğ° Ğ¿Ğ¾Ğ´ Ñ†Ğ²ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (ÑĞµÑ€Ñ‹Ğ¹ Ñ„Ğ¾Ğ½)
WebApp.setHeaderColor('#F2F2F7'); 
WebApp.setBackgroundColor('#F2F2F7');

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

====================
END FILE: src/main.tsx
====================

====================
START FILE: src/App.css
====================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}

====================
END FILE: src/App.css
====================

====================
START FILE: src/index.css
====================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    /* Ğ¦Ğ²ĞµÑ‚Ğ° iOS */
    --bg-primary: #F2F2F7;
    --bg-secondary: #FFFFFF;
    
    /* ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğµ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ñ‹ */
    margin: 0;
    padding: 0;
    
    /* ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ° (ĞºĞ°Ğº Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸) */
    -webkit-user-select: none;
    user-select: none;
    
    /* ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ "Ñ€ĞµĞ·Ğ¸Ğ½ĞºÑƒ" Ğ¿Ñ€Ğ¸ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğµ Ğ²ÑĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ */
    overscroll-behavior-y: none;
    
    /* ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ·Ğ¾Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµĞ½Ñ Ğ´Ğ¾Ğ»Ğ³Ğ¸Ğ¼ Ñ‚Ğ°Ğ¿Ğ¾Ğ¼ */
    -webkit-touch-callout: none;
  }

  body {
    @apply bg-[#F2F2F7] text-slate-900 antialiased;
    /* Ğ¤Ğ¸ĞºÑ Ğ²Ñ‹ÑĞ¾Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ¾Ğ² (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ°Ğ´Ñ€ĞµÑĞ½Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° Ğ½Ğµ Ğ¼ĞµÑˆĞ°Ğ»Ğ°) */
    height: 100dvh;
    width: 100vw;
    overflow: hidden; /* Ğ¡ĞºÑ€Ğ¾Ğ»Ğ» Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² */
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  /* Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºÑƒ Ğ¿Ñ€Ğ¸ Ñ‚Ğ°Ğ¿Ğµ Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… */
  * {
    -webkit-tap-highlight-color: transparent;
  }
}

/* Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğ±Ğ°Ñ€, Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºÑƒ */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}
.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

/* ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿ÑƒĞ»ÑŒÑĞ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ² */
@keyframes pulse-ring {
  0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
  70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
  100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}
.animate-pulse-ring {
  animation: pulse-ring 2s infinite;
}

/* ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ GPU */
.transform-gpu {
  transform: translate3d(0, 0, 0);
  backface-visibility: hidden;
  perspective: 1000px;
}

====================
END FILE: src/index.css
====================

====================
START FILE: src/app/WelcomeScreen.tsx
====================
// src/app/WelcomeScreen.tsx
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ShieldCheck, Activity, ChevronRight } from 'lucide-react';
import { storageSet } from '../utils/storage'; // ğŸ‘ˆ ĞĞ°Ñˆ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚

interface Props {
  onComplete: () => void;
}

export const WelcomeScreen = ({ onComplete }: Props) => {
  const [step, setStep] = useState(0);

  const handleNext = () => setStep(1);
  
  // ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ñ
  const handleAgree = async () => {
    await storageSet('has_accepted_terms', 'true');
    onComplete();
  };

  return (
    <div className="fixed inset-0 z-[9999] bg-[#F2F2F7] flex flex-col justify-between p-6 overflow-hidden">
      
      <AnimatePresence mode="wait">
        
        {/* STEP 1: INTRO */}
        {step === 0 && (
          <motion.div 
            key="intro"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0, x: -50 }}
            className="flex-1 flex flex-col items-center justify-center text-center space-y-8"
          >
            <div className="relative">
                {/* Ğ¢ĞµĞ½ÑŒ Ğ¿Ğ¾Ğ´ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ğ¾Ğ¼ */}
                <div className="absolute inset-4 bg-slate-900 blur-2xl opacity-20 rounded-full" />
                
                {/* Ğ›ĞĞ“ĞĞ¢Ğ˜ĞŸ */}
                <img 
                    src="/logo.svg" 
                    alt="Body Tweaker Logo" 
                    className="w-32 h-32 rounded-[2.5rem] shadow-2xl relative z-10"
                />
            </div>
            
            <div>
                <h1 className="text-4xl font-[900] text-slate-800 tracking-tight leading-tight">
                    Body<br/>Tweaker
                </h1>
                <p className="text-sm font-bold text-slate-400 mt-3 uppercase tracking-widest">
                    Scientific Biohacking
                </p>
            </div>

            <div className="max-w-xs text-sm text-slate-500 font-medium leading-relaxed">
                Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼Ğ¾Ğ¼, Ğ´Ñ‹Ñ…Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ.
            </div>

            <button 
                onClick={handleNext}
                className="w-full max-w-xs bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-transform"
            >
                ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ <ChevronRight className="w-5 h-5" />
            </button>
          </motion.div>
        )}

        {/* STEP 2: LEGAL (ĞŸĞĞ›ĞĞ«Ğ™ Ğ¢Ğ•ĞšĞ¡Ğ¢) */}
        {step === 1 && (
          <motion.div 
            key="legal"
            initial={{ opacity: 0, x: 50 }}
            animate={{ opacity: 1, x: 0 }}
            className="flex-1 flex flex-col h-full pt-10"
          >
            <div className="flex-1 overflow-y-auto pb-4 scrollbar-hide">
                <div className="flex items-center gap-3 mb-6">
                    <div className="p-3 bg-white rounded-xl shadow-sm">
                        <ShieldCheck className="w-6 h-6 text-blue-600" />
                    </div>
                    <h2 className="text-2xl font-[900] text-slate-800">
                        Ğ’Ğ°Ğ¶Ğ½Ğ¾ Ğ·Ğ½Ğ°Ñ‚ÑŒ
                    </h2>
                </div>

                <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 space-y-6 text-sm text-slate-600 leading-relaxed">
                    <p>
                        ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ <strong>Body Tweaker</strong> Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ´Ñ‹Ñ…Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ğº.
                    </p>
                    
                    <div className="p-4 bg-slate-50 rounded-xl border-l-4 border-orange-400">
                        <h3 className="font-bold text-slate-800 mb-1 flex items-center gap-2">
                            <Activity className="w-4 h-4 text-orange-500" />
                            ĞÑ‚ĞºĞ°Ğ· Ğ¾Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸
                        </h3>
                        <p className="text-xs text-slate-500">
                            ĞœÑ‹ Ğ½Ğµ ÑĞ²Ğ»ÑĞµĞ¼ÑÑ Ğ¼ĞµĞ´Ğ¸Ñ†Ğ¸Ğ½ÑĞºĞ¸Ğ¼ ÑƒÑ‡Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼. Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ½Ğµ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ Ğ²Ñ€Ğ°Ñ‡Ğ°.
                        </p>
                    </div>

                    <ul className="space-y-3 list-disc pl-4 marker:text-slate-300">
                        <li>
                            Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ñ, Ğ²Ñ‹ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚Ğµ, Ñ‡Ñ‚Ğ¾ Ñƒ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ¾Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹.
                        </li>
                        <li>
                            Ğ”Ñ‹Ñ…Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞ¹Ñ‚Ğµ Ğ¸Ñ… Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ¾Ğ±ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞµ.
                        </li>
                    </ul>

                    <p className="text-xs text-slate-400 mt-4 pt-4 border-t border-slate-100">
                        ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°Ñ Â«ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒÂ», Ğ²Ñ‹ ÑĞ¾Ğ³Ğ»Ğ°ÑˆĞ°ĞµÑ‚ĞµÑÑŒ Ñ Ğ£ÑĞ»Ğ¾Ğ²Ğ¸ÑĞ¼Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
                    </p>
                </div>
            </div>

            <div className="pt-4 shrink-0">
                <button 
                    onClick={handleAgree}
                    className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-blue-600/20 active:scale-95 transition-transform"
                >
                    ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ
                </button>
                <button 
                    onClick={() => setStep(0)}
                    className="w-full py-3 text-slate-400 font-bold text-xs uppercase tracking-wide mt-2 hover:text-slate-600"
                >
                    ĞĞ°Ğ·Ğ°Ğ´
                </button>
            </div>
          </motion.div>
        )}

      </AnimatePresence>
    </div>
  );
};

====================
END FILE: src/app/WelcomeScreen.tsx
====================

====================
START FILE: src/app/Layout.tsx
====================
// src/app/Layout.tsx
import { useState, useRef, useEffect, memo } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { Map, Timer, Wind, History, Settings } from 'lucide-react';
import { motion, AnimatePresence, useSpring, useMotionValue, useTransform } from 'framer-motion';
import type { Variants } from 'framer-motion';
import { cn } from '../utils/cn';
import { SettingsModal } from './modals/SettingsModal';
import { InfoModal } from './modals/InfoModal';
import { storageGet, storageSet } from '../utils/storage'; // ğŸ‘ˆ NEW
import WebApp from '@twa-dev/sdk';

import { MetabolismMapPage } from '../features/fasting/MetabolismMapPage';
import { FastingPage } from '../features/fasting/FastingPage';
import { BreathingPage } from '../features/breathing/BreathingPage';
import { HistoryPage } from '../features/history/HistoryPage';

import { useFastingTimerContext } from '../features/fasting/context/TimerContext';
import { ToastNotification } from '../components/ui/ToastNotification';

const PageView = memo(({ isActive, children }: { isActive: boolean, children: React.ReactNode }) => {
    return (
        <div 
          className={cn(
              "w-full h-full absolute inset-0 overflow-y-auto overflow-x-hidden scrollbar-hide", 
              "pb-32 px-4 pt-2",
              isActive ? "z-10 opacity-100 pointer-events-auto" : "-z-10 opacity-0 pointer-events-none"
          )}
          style={{ visibility: isActive ? 'visible' : 'hidden' }}
        >
            {children}
        </div>
    );
});

export const Layout = () => {
  const location = useLocation();
  const navigate = useNavigate();
  
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [isInfoOpen, setIsInfoOpen] = useState(false);

  const { notification, closeNotification, setPhaseToOpen } = useFastingTimerContext();

  const navRef = useRef<HTMLDivElement>(null);
  const [isDragging, setIsDragging] = useState(false);
  
  const xPercent = useMotionValue(0);
  const springPercent = useSpring(xPercent, { 
      stiffness: isDragging ? 2000 : 500, 
      damping: isDragging ? 50 : 40 
  });

  const navItems = [
    { id: 'map', path: '/', icon: Map },
    { id: 'timer', path: '/timer', icon: Timer },
    { id: 'breath', path: '/breathing', icon: Wind },
    { id: 'history', path: '/history', icon: History },
  ];

  const activeIndex = navItems.findIndex(i => i.path === location.pathname);
  const safeActiveIndex = activeIndex === -1 ? 0 : activeIndex;

  useEffect(() => {
    if (!isDragging) {
        xPercent.set(safeActiveIndex * 25);
    }
  }, [safeActiveIndex, isDragging]);

  // Init & User Name Check
  useEffect(() => {
    try {
        WebApp.ready(); 
        WebApp.expand();
        WebApp.setHeaderColor('#F2F2F7'); 
        WebApp.setBackgroundColor('#F2F2F7');
        
        const checkUser = async () => {
            if (WebApp.initDataUnsafe?.user) {
                const existingName = await storageGet('user_name');
                if (!existingName) {
                    await storageSet('user_name', WebApp.initDataUnsafe.user.first_name);
                }
            }
        };
        checkUser();

    } catch (e) { /* ignore */ }
  }, []);

  const handleNotificationClick = () => {
      if (notification?.phaseId) {
          setPhaseToOpen(notification.phaseId);
          navigate('/');
      }
  };

  useEffect(() => {
    const handleMove = (e: PointerEvent) => {
      if (!isDragging || !navRef.current) return;
      const rect = navRef.current.getBoundingClientRect();
      const contentWidth = rect.width - 16;
      if (contentWidth <= 0) return;
      let relativeX = e.clientX - rect.left - 8 - (contentWidth / 8); 
      let percent = (relativeX / contentWidth) * 100;
      xPercent.set(percent);
    };

    const handleUp = (e: PointerEvent) => {
      if (!isDragging || !navRef.current) return;
      setIsDragging(false);
      const rect = navRef.current.getBoundingClientRect();
      const contentWidth = rect.width - 16;
      const itemWidth = contentWidth / 4;
      const relativeX = e.clientX - rect.left - 8;
      let index = Math.floor(relativeX / itemWidth);
      index = Math.max(0, Math.min(index, 3));
      const targetPath = navItems[index].path;
      
      if (targetPath !== location.pathname) {
        if (navigator.vibrate) navigator.vibrate(15);
        navigate(targetPath);
      } else {
        xPercent.set(index * 25);
      }
    };

    if (isDragging) {
        window.addEventListener('pointermove', handleMove);
        window.addEventListener('pointerup', handleUp);
        window.addEventListener('pointercancel', handleUp);
    }
    return () => {
        window.removeEventListener('pointermove', handleMove);
        window.removeEventListener('pointerup', handleUp);
        window.removeEventListener('pointercancel', handleUp);
    };
  }, [isDragging, location.pathname, navigate]);

  const leftStyle = useTransform(springPercent, (v) => `calc(${v}% + 8px)`);

  return (
    <div className="bg-[#F2F2F7] flex justify-center font-sans text-slate-900 h-[100dvh] w-screen overflow-hidden fixed inset-0">
      
      <div className="w-full max-w-md bg-[#F2F2F7] h-full relative flex flex-col shadow-2xl overflow-hidden">
        
        <header className="px-6 pt-safe pb-4 bg-[#F2F2F7]/90 backdrop-blur-xl sticky top-0 z-30 flex justify-between items-center transition-all shrink-0">
          <div onClick={() => setIsInfoOpen(true)} className="cursor-pointer active:opacity-60 transition-opacity pt-2">
            <h1 className="text-2xl font-[850] tracking-tight text-slate-900">Body Tweaker</h1>
            <p className="text-[10px] font-bold text-slate-400 tracking-widest uppercase mt-0.5">Scientific Biohacking</p>
          </div>
          <motion.button whileTap={{ scale: 0.9 }} onClick={() => setIsSettingsOpen(true)} className="mt-2 p-2.5 text-slate-400 hover:text-slate-600 bg-white rounded-full shadow-sm border border-slate-100">
            <Settings className="w-5 h-5" />
          </motion.button>
        </header>

        <main className="flex-1 relative w-full overflow-hidden">
            <PageView isActive={location.pathname === '/' || location.pathname === ''}>
                <MetabolismMapPage />
            </PageView>
            <PageView isActive={location.pathname === '/timer'}>
                <FastingPage />
            </PageView>
            <PageView isActive={location.pathname === '/breathing'}>
                <BreathingPage />
            </PageView>
            <PageView isActive={location.pathname === '/history'}>
                <HistoryPage />
            </PageView>
        </main>

        <div className="fixed bottom-8 left-0 right-0 z-40 flex justify-center pointer-events-none">
          <motion.nav 
            ref={navRef}
            animate={{ scale: isDragging ? 0.98 : 1, y: isDragging ? 2 : 0 }}
            transition={{ type: "spring", stiffness: 400, damping: 25 }}
            style={{ touchAction: 'none' }}
            onPointerDown={(e) => {
                e.preventDefault();
                setIsDragging(true);
                const rect = e.currentTarget.getBoundingClientRect();
                const contentWidth = rect.width - 16;
                let relativeX = e.clientX - rect.left - 8 - (contentWidth / 8); 
                let percent = (relativeX / contentWidth) * 100;
                xPercent.set(percent);
            }}
            className="pointer-events-auto bg-white/90 backdrop-blur-2xl border border-white/40 shadow-[0_20px_40px_-10px_rgba(0,0,0,0.15)] rounded-[2.5rem] px-2 py-2 flex items-center mx-4 max-w-sm w-full relative h-20 cursor-grab active:cursor-grabbing select-none"
          >
            <motion.div
                className="absolute top-2 bottom-2 bg-white shadow-[0_4px_15px_-3px_rgba(0,0,0,0.1)] rounded-[2rem] border border-slate-100 z-0 pointer-events-none"
                style={{
                    left: leftStyle, 
                    width: 'calc(25% - 16px)', 
                    scale: isDragging ? 1.05 : 1
                }}
            />
            {navItems.map((item) => {
              const isActive = location.pathname === item.path;
              const getIconAnimation = (): Variants | Record<string, unknown> => {
                  if (!isActive) return {};
                  switch (item.id) {
                      case 'map': return { scaleX: [1, 1.2, 0.9, 1], transition: { duration: 0.6 } };
                      case 'timer': return { rotate: [0, 360], transition: { duration: 0.8, ease: "backOut" } };
                      case 'breath': return { x: [0, 5, -5, 0], rotate: [0, 10, -10, 0], transition: { duration: 0.6 } };
                      case 'history': return { rotate: [0, -20, 360, 360], transition: { duration: 1, times: [0, 0.2, 0.8, 1] } };
                      default: return { scale: 1.2, y: -4 };
                  }
              };
              
              return (
                <div key={item.id} className="relative flex-1 flex flex-col items-center justify-center h-full z-10 pointer-events-none">
                  <motion.div animate={isActive ? { ...getIconAnimation(), y: -4, scale: 1.1 } : { y: 0, scale: 1, rotate: 0 }}>
                    <item.icon className={cn("w-6 h-6 transition-colors duration-200", isActive ? "text-blue-600 fill-blue-600/10" : "text-slate-400")} strokeWidth={isActive ? 2.5 : 2} />
                  </motion.div>
                  <AnimatePresence>
                    {isActive && (
                      <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} exit={{ scale: 0 }} className="w-1 h-1 bg-blue-600 rounded-full absolute bottom-3" />
                    )}
                  </AnimatePresence>
                </div>
              );
            })}
          </motion.nav>
        </div>

        <ToastNotification 
            isVisible={!!notification} 
            title={notification?.title || ""} 
            message={notification?.message || ""} 
            onClose={closeNotification} 
            onPress={handleNotificationClick}
        />

        {isSettingsOpen && <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} />}
        {isInfoOpen && <InfoModal isOpen={isInfoOpen} onClose={() => setIsInfoOpen(false)} />}

      </div>
    </div>
  );
};

====================
END FILE: src/app/Layout.tsx
====================

====================
START FILE: src/app/modals/InstallGuideModal.tsx
====================
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { Share, PlusSquare, Smartphone } from 'lucide-react';

interface Props {
  isOpen: boolean;
  onClose: () => void;
}

export const InstallGuideModal = ({ isOpen, onClose }: Props) => {
  const content = (
    <AnimatePresence>
      {isOpen && (
        <>
          <motion.div
            initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100]"
          />

          <motion.div
            initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }}
            transition={{ type: "spring", damping: 25, stiffness: 300 }}
            className="fixed bottom-0 left-0 right-0 z-[101] bg-[#F2F2F7] rounded-t-[2.5rem] p-6 pb-10 shadow-2xl max-w-md mx-auto"
          >
            <div className="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6" />
            
            <div className="text-center mb-8">
                <div className="w-16 h-16 bg-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/30">
                    <Smartphone className="w-8 h-8 text-white" />
                </div>
                <h2 className="text-2xl font-[900] text-slate-800 leading-tight">
                    Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
                </h2>
                <p className="text-sm text-slate-500 mt-2 px-4">
                    Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Body Tweaker Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ±ĞµĞ· Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ğ°.
                </p>
            </div>

            <div className="space-y-4 bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div className="flex items-center gap-4">
                    <div className="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center shrink-0">
                        <span className="font-bold text-slate-400">1</span>
                    </div>
                    <div className="text-sm font-medium text-slate-700 flex items-center gap-2">
                        ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ <Share className="w-4 h-4 text-blue-500" /> <b>ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ</b>
                    </div>
                </div>
                <div className="w-full h-px bg-slate-50" />
                <div className="flex items-center gap-4">
                     <div className="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center shrink-0">
                        <span className="font-bold text-slate-400">2</span>
                    </div>
                    <div className="text-sm font-medium text-slate-700 flex items-center gap-2">
                        Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ <PlusSquare className="w-4 h-4 text-slate-400" /> <b>ĞĞ° ÑĞºÑ€Ğ°Ğ½ Â«Ğ”Ğ¾Ğ¼Ğ¾Ğ¹Â»</b>
                    </div>
                </div>
            </div>

            <button 
                onClick={onClose}
                className="w-full mt-6 py-4 bg-slate-900 text-white rounded-2xl font-bold active:scale-95 transition-transform"
            >
                ĞŸĞ¾Ğ½ÑÑ‚Ğ½Ğ¾
            </button>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};

====================
END FILE: src/app/modals/InstallGuideModal.tsx
====================

====================
START FILE: src/app/modals/InfoModal.tsx
====================
import { motion } from 'framer-motion';
import { Send, User, X, Code, CheckCircle2, Stethoscope } from 'lucide-react';
import { cn } from '../../utils/cn';
import WebApp from '@twa-dev/sdk';

interface Props {
  isOpen: boolean;
  onClose: () => void;
}

export const InfoModal = ({ isOpen, onClose }: Props) => {
  if (!isOpen) return null;

  const currentUser = WebApp.initDataUnsafe?.user;

  const team = [
    {
      role: "Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº",
      name: "@nikita_sytsevich",
      link: "https://t.me/nikita_sytsevich",
      icon: Code,
      color: "bg-blue-50 text-blue-600",
      border: "border-blue-100"
    },
    {
      role: "QA & Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
      name: "@inntheeairr",
      link: "https://t.me/inntheeairr",
      icon: CheckCircle2,
      color: "bg-purple-50 text-purple-600",
      border: "border-purple-100"
    },
    {
      role: "Ğ’ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹ Ñ€ĞµĞ°Ğ±Ğ¸Ğ»Ğ¸Ñ‚Ğ¾Ğ»Ğ¾Ğ³",
      name: "@bubnovzavaliebalo",
      link: "https://t.me/bubnovzavaliebalo",
      icon: Stethoscope,
      color: "bg-emerald-50 text-emerald-600",
      border: "border-emerald-100"
    }
  ];

  return (
    <>
      <motion.div
        initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
        onClick={onClose}
        className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50"
      />

      <motion.div
        initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }}
        transition={{ type: "spring", damping: 25, stiffness: 300 }}
        className="fixed bottom-0 left-0 right-0 z-50 bg-[#F2F2F7] rounded-t-[2.5rem] h-[85vh] shadow-2xl flex flex-col overflow-hidden max-w-md mx-auto"
      >
        <div className="w-full flex justify-center pt-3 pb-2 bg-[#F2F2F7] shrink-0" onClick={onClose}>
          <div className="w-12 h-1.5 bg-gray-300 rounded-full" />
        </div>

        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-200/50 hover:bg-gray-200 rounded-full transition-colors z-50">
            <X className="w-5 h-5 text-gray-500" />
        </button>

        <div className="flex-1 overflow-y-auto pb-safe px-6 pt-2">
            
            {/* Ğ¥Ğ•Ğ”Ğ•Ğ  */}
            <div className="flex items-center justify-between mb-8 mt-4 bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                <div className="flex items-center gap-4">
                    {/* ğŸ‘‡ Ğ›ĞĞ“ĞĞ¢Ğ˜ĞŸ */}
                    <img 
                        src="/logo.svg" 
                        alt="Logo" 
                        className="w-14 h-14 rounded-2xl shadow-md border border-slate-100"
                    />
                    <div>
                        <h2 className="text-xl font-[900] text-slate-800 tracking-tight leading-none">
                            Body Tweaker
                        </h2>
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                            Ğ’ĞµÑ€ÑĞ¸Ñ 2.0
                        </p>
                    </div>
                </div>

                <div className="relative">
                    {currentUser?.photo_url ? (
                        <img 
                            src={currentUser.photo_url} 
                            alt="User" 
                            className="w-10 h-10 rounded-full border-2 border-slate-50 shadow-sm"
                        />
                    ) : (
                        <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center border-2 border-slate-50">
                            <User className="w-5 h-5 text-slate-400" />
                        </div>
                    )}
                    <div className="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-white rounded-full" />
                </div>
            </div>

            {/* Ğ¡ĞŸĞ˜Ğ¡ĞĞš ĞšĞĞœĞĞĞ”Ğ« */}
            <div className="space-y-3 pb-10">
                <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-2 mb-2">
                    ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
                </h3>
                
                {team.map((member) => (
                    <a
                        key={member.name}
                        href={member.link}
                        target="_blank"
                        rel="noopener noreferrer"
                        className={cn(
                            "flex items-center gap-4 p-4 rounded-2xl border transition-all active:scale-98 bg-white shadow-sm",
                            member.border
                        )}
                    >
                        <div className={cn("w-12 h-12 rounded-xl flex items-center justify-center shrink-0", member.color)}>
                            <member.icon className="w-6 h-6" />
                        </div>

                        <div className="flex-1 min-w-0 pr-2">
                            <p className="text-[10px] font-bold uppercase tracking-wide text-slate-400 mb-0.5">
                                {member.role}
                            </p>
                            <p className="text-sm font-bold text-slate-700 truncate">
                                {member.name}
                            </p>
                        </div>

                        <div className="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-300">
                            <Send className="w-4 h-4" />
                        </div>
                    </a>
                ))}
            </div>

            <div className="text-center pb-8 opacity-50">
                <p className="text-[10px] text-slate-400 font-mono">
                    Built with â¤ï¸ for Biohackers
                </p>
            </div>

        </div>
      </motion.div>
    </>
  );
};

====================
END FILE: src/app/modals/InfoModal.tsx
====================

====================
START FILE: src/app/modals/SettingsModal.tsx
====================
// src/app/modals/SettingsModal.tsx
import { useState } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { Bell, Trash2, ShieldCheck, Download, Upload, X, Loader2, Smartphone } from 'lucide-react';
import { cn } from '../../utils/cn';

// Ğ¥ÑƒĞºĞ¸ Ğ¸ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
import { useStorage } from '../../hooks/useStorage';
import { useAddToHomeScreen } from '../../hooks/useAddToHomeScreen';
import { 
  storageGet, 
  storageRemove, 
  storageGetJSON, 
  storageSetJSON, 
  storageSet 
} from '../../utils/storage';
import type { NotificationSettings } from '../../utils/types';
import WebApp from '@twa-dev/sdk';

// ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
import { ConfirmModal } from '../../components/ui/ConfirmModal';
import { ToastNotification } from '../../components/ui/ToastNotification';
import { InstallGuideModal } from './InstallGuideModal';

interface Props {
  isOpen: boolean;
  onClose: () => void;
}

export const SettingsModal = ({ isOpen, onClose }: Props) => {
  const user = WebApp.initDataUnsafe?.user;
  
  // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ UI
  const [showResetConfirm, setShowResetConfirm] = useState(false);
  const [showExportToast, setShowExportToast] = useState(false);
  const [showInstallGuide, setShowInstallGuide] = useState(false);
  const [toastMessage, setToastMessage] = useState({ title: '', message: '' });
  const [isProcessing, setIsProcessing] = useState(false);

  // 1. ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (Cloud)
  const { 
    value: notifications, 
    setValue: setNotifications, 
    isLoading: isSettingsLoading 
  } = useStorage<NotificationSettings>('user_settings', { fasting: true });

  // 2. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° PWA (Browser & Telegram)
  const { deferredPrompt, isIOS, isStandalone, promptInstall } = useAddToHomeScreen();
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ° Ğ² Telegram (v8.0+)
  const isTelegramNativeInstallSupported = WebApp.isVersionAtLeast('8.0');

  // Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸:
  // (Telegram Native Ğ˜Ğ›Ğ˜ iOS Ğ˜Ğ›Ğ˜ Android Prompt) Ğ˜ (ĞĞµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾)
  const canInstall = !isStandalone && (isTelegramNativeInstallSupported || isIOS || !!deferredPrompt);

  // --- HANDLERS ---

  const toggleNotification = (e: React.MouseEvent) => {
      e.stopPropagation();
      setNotifications((prev) => ({ ...prev, fasting: !prev.fasting }));
  };

  const handleInstallClick = () => {
      // 1. ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: ĞĞ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Telegram
      if (isTelegramNativeInstallSupported) {
          WebApp.addToHomeScreen();
          return;
      }

      // 2. Ğ¤Ğ¾Ğ»Ğ±ÑĞºĞ¸ Ğ´Ğ»Ñ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ¾Ğ²
      if (isIOS) {
          setShowInstallGuide(true);
      } else if (deferredPrompt) {
          promptInstall();
      } else {
          // Ğ•ÑĞ»Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾ Ğ² ÑÑ‚Ğ°Ñ€Ğ¾Ğ¼ Telegram Ğ¸Ğ»Ğ¸ Desktop
          alert('Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ² Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°Ñ… Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Telegram.');
      }
  };

  const handleReset = () => setShowResetConfirm(true);

  const confirmReset = async () => {
      setIsProcessing(true);
      try {
          await Promise.all([
              storageRemove('history_fasting'),
              storageRemove('user_settings'),
              storageRemove('fasting_startTime'),
              storageRemove('fasting_scheme'),
              storageRemove('user_name'),
              storageRemove('has_accepted_terms')
          ]);
          window.location.reload();
      } catch (e) {
          console.error("Reset failed", e);
          setIsProcessing(false);
      }
  };

  const handleExport = async () => {
      setIsProcessing(true);
      try {
          const [history, settings, startTime, scheme, userName, terms] = await Promise.all([
              storageGetJSON('history_fasting', []),
              storageGetJSON('user_settings', { fasting: true }),
              storageGet('fasting_startTime'),
              storageGet('fasting_scheme'),
              storageGet('user_name'),
              storageGet('has_accepted_terms')
          ]);

          const backupData = {
              version: 1,
              date: new Date().toISOString(),
              data: {
                  history_fasting: history,
                  user_settings: settings,
                  fasting_startTime: startTime,
                  fasting_scheme: scheme,
                  user_name: userName,
                  has_accepted_terms: terms
              }
          };
          
          const jsonString = JSON.stringify(backupData, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          
          const link = document.createElement('a');
          link.href = url;
          link.download = `bodytweaker_backup_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          setToastMessage({ title: 'Ğ‘ÑĞºĞ°Ğ¿ ÑĞ¾Ğ·Ğ´Ğ°Ğ½', message: 'Ğ¤Ğ°Ğ¹Ğ» Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ' });
          setShowExportToast(true);
      } catch (e) {
          console.error("Export failed", e);
          setToastMessage({ title: 'ĞÑˆĞ¸Ğ±ĞºĞ°', message: 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ±ÑĞºĞ°Ğ¿' });
          setShowExportToast(true);
      } finally {
          setIsProcessing(false);
      }
  };

  const handleImport = (event: React.ChangeEvent<HTMLInputElement>) => {
      const file = event.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
          setIsProcessing(true);
          try {
              const content = e.target?.result as string;
              const parsed = JSON.parse(content);

              if (!parsed.data) throw new Error('Invalid backup format');
              const { data } = parsed;

              const promises = [];
              if (data.history_fasting) promises.push(storageSetJSON('history_fasting', data.history_fasting));
              if (data.user_settings) promises.push(storageSetJSON('user_settings', data.user_settings));
              if (data.fasting_startTime) promises.push(storageSet('fasting_startTime', data.fasting_startTime));
              if (data.fasting_scheme) promises.push(storageSet('fasting_scheme', data.fasting_scheme));
              if (data.user_name) promises.push(storageSet('user_name', data.user_name));
              if (data.has_accepted_terms) promises.push(storageSet('has_accepted_terms', data.has_accepted_terms));
              
              await Promise.all(promises);

              alert('Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹! ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾.');
              window.location.reload();
          } catch (error) {
              console.error(error);
              alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ±ÑĞºĞ°Ğ¿Ğ°');
          } finally {
              setIsProcessing(false);
          }
      };
      reader.readAsText(file);
      event.target.value = ''; 
  };

  // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  const firstName = user?.first_name || 'Ğ“Ğ¾ÑÑ‚ÑŒ';
  const lastName = user?.last_name || '';
  const username = user?.username ? `@${user.username}` : 'Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ';
  const photoUrl = user?.photo_url;
  const initials = (firstName[0] + (lastName[0] || '')).toUpperCase();

  if (!isOpen) return null;

  const content = (
    <AnimatePresence>
      {/* Backdrop */}
      <motion.div
        initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
        onClick={onClose}
        className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50"
      />

      {/* Modal Sheet */}
      <motion.div
        initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }}
        transition={{ type: "spring", damping: 25, stiffness: 300 }}
        className="fixed bottom-0 left-0 right-0 z-50 bg-[#F2F2F7] rounded-t-[2.5rem] h-[85vh] shadow-2xl flex flex-col overflow-hidden max-w-md mx-auto"
      >
        {/* Handle */}
        <div className="w-full flex justify-center pt-3 pb-2 bg-[#F2F2F7] shrink-0 cursor-pointer" onClick={onClose}>
          <div className="w-12 h-1.5 bg-gray-300 rounded-full" />
        </div>

        {/* Close Button */}
        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-200/50 hover:bg-gray-200 rounded-full transition-colors z-50">
            <X className="w-5 h-5 text-gray-500" />
        </button>

        {/* Content Container */}
        <div className="flex-1 overflow-y-auto pb-safe px-6 pt-2 overscroll-contain">
            
            <div className="mb-8 mt-2">
                <h2 className="text-3xl font-[900] text-slate-800 leading-tight">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</h2>
                <p className="text-sm font-medium text-slate-400 mt-1">ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ</p>
            </div>

            <div className="space-y-6 pb-6">
                
                {/* ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬ */}
                <section>
                    <div className="bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm relative overflow-hidden">
                        <div className="flex items-center gap-4 relative z-10">
                             <div className="relative shrink-0">
                                {photoUrl ? (
                                    <img src={photoUrl} alt={firstName} className="w-16 h-16 rounded-full border-4 border-slate-50 shadow-sm" />
                                ) : (
                                    <div className="w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center border-4 border-slate-50 shadow-sm text-blue-600 font-black text-xl tracking-wider">
                                        {initials}
                                    </div>
                                )}
                            </div>
                            <div className="min-w-0">
                                <h3 className="font-[900] text-lg text-slate-800 leading-tight truncate">{firstName} {lastName}</h3>
                                <p className="text-sm font-medium text-slate-400 truncate">{username}</p>
                            </div>
                        </div>
                    </div>
                </section>

                {/* ĞŸĞ Ğ˜Ğ›ĞĞ–Ğ•ĞĞ˜Ğ• */}
                <section>
                    <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ</h4>
                    <div className="bg-white border border-slate-100 rounded-2xl overflow-hidden shadow-sm">
                        
                        {/* ĞšĞĞĞŸĞšĞ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ˜ */}
                        {canInstall && (
                             <button 
                                onClick={handleInstallClick}
                                className="w-full flex items-center justify-between p-4 cursor-pointer active:bg-slate-50 transition-colors border-b border-slate-50"
                             >
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-slate-800 rounded-lg text-white">
                                        <Smartphone className="w-4 h-4" />
                                    </div>
                                    <div className="text-left">
                                        <span className="text-sm font-bold text-slate-800 block leading-tight">
                                            Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
                                        </span>
                                        <span className="text-[10px] text-slate-400 font-medium">
                                            Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½
                                        </span>
                                    </div>
                                </div>
                                <div className="bg-slate-100 px-3 py-1.5 rounded-lg">
                                    <span className="text-[10px] font-bold text-slate-500 uppercase">
                                        {isTelegramNativeInstallSupported ? 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ' : (isIOS ? 'Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ' : 'Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ')}
                                    </span>
                                </div>
                             </button>
                        )}

                        {/* Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ¯ */}
                        <div className="flex items-center justify-between p-4">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-50 rounded-lg text-blue-500">
                                    <Bell className="w-4 h-4" />
                                </div>
                                <span className="text-sm font-medium text-slate-700">Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ°</span>
                            </div>
                            
                            {isSettingsLoading ? (
                                <Loader2 className="w-5 h-5 animate-spin text-slate-300" />
                            ) : (
                                <button 
                                    type="button"
                                    onClick={toggleNotification}
                                    className={cn("w-12 h-7 rounded-full relative transition-colors duration-300", notifications.fasting ? "bg-slate-800" : "bg-slate-200")}
                                >
                                    <div className={cn("w-5 h-5 bg-white rounded-full absolute top-1 transition-transform duration-300 shadow-sm", notifications.fasting ? "left-6" : "left-1")} />
                                </button>
                            )}
                        </div>

                    </div>
                </section>

                {/* Ğ”ĞĞĞĞ«Ğ• */}
                <section>
                    <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ</h4>
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={handleExport} disabled={isProcessing} className="flex items-center justify-center gap-2 p-4 bg-white border border-slate-100 rounded-2xl hover:bg-slate-50 transition-colors shadow-sm active:scale-95 disabled:opacity-50">
                            {isProcessing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Download className="w-4 h-4 text-slate-400" />}
                            <span className="text-xs font-bold text-slate-600">Ğ‘ÑĞºĞ°Ğ¿</span>
                        </button>
                        
                        <label className={cn("flex items-center justify-center gap-2 p-4 bg-white border border-slate-100 rounded-2xl hover:bg-slate-50 transition-colors shadow-sm cursor-pointer active:scale-95", isProcessing && "opacity-50 pointer-events-none")}>
                            <input 
                                type="file" 
                                accept=".json"
                                onChange={handleImport}
                                className="hidden"
                                disabled={isProcessing}
                            />
                            {isProcessing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Upload className="w-4 h-4 text-slate-400" />}
                            <span className="text-xs font-bold text-slate-600">Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚</span>
                        </label>
                    </div>
                </section>

                {/* Ğ¤Ğ£Ğ¢Ğ•Ğ  (Ğ¦ĞµĞ½Ñ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹) */}
                <div className="flex flex-col items-center gap-4 mt-8 pb-8">
                    <button onClick={handleReset} className="w-full flex items-center justify-center gap-2 p-4 text-red-500 bg-red-50/50 hover:bg-red-50 rounded-2xl border border-red-100/50 transition-colors text-sm font-bold active:scale-98">
                        {isProcessing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4" />}
                        Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
                    </button>
                    
                    <div className="inline-flex items-center gap-1.5 px-3 py-1 bg-slate-50 rounded-full border border-slate-100">
                        <ShieldCheck className="w-3 h-3 text-slate-400" />
                        <span className="text-[10px] font-medium text-slate-400">Ver 2.0.1 (Cloud)</span>
                    </div>
                </div>

            </div>
        </div>
      </motion.div>

      {/* ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾ĞºĞ½Ğ° (Ğ²Ğ½Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ ÑˆÑ‚Ğ¾Ñ€ĞºĞ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ z-index) */}
      <ConfirmModal
        isOpen={showResetConfirm}
        onClose={() => setShowResetConfirm(false)}
        onConfirm={confirmReset}
        title="Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"
        message="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ°?"
        confirmText="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"
        cancelText="ĞÑ‚Ğ¼ĞµĞ½Ğ°"
        variant="danger"
      />

      <ToastNotification
        isVisible={showExportToast}
        title={toastMessage.title}
        message={toastMessage.message}
        onClose={() => setShowExportToast(false)}
      />

      <InstallGuideModal 
        isOpen={showInstallGuide} 
        onClose={() => setShowInstallGuide(false)} 
      />
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};

====================
END FILE: src/app/modals/SettingsModal.tsx
====================

====================
START FILE: src/features/breathing/BreathingPage.tsx
====================
import { useState, useEffect, useRef } from 'react';
import { BREATH_LEVELS } from './data/patterns';
import { useBreathingSession } from './hooks/useBreathingSession';
import { BreathingCircle } from './components/BreathingCircle';
import { Info, ChevronRight, ChevronLeft, Volume2, Loader2, Timer, CheckCircle2 } from 'lucide-react';
import { cn } from '../../utils/cn';
import { InfoSheet } from './components/InfoSheet';
import { SoundSheet } from './components/SoundSheet';
import { BreathingStartModal } from './components/BreathingStartModal';
import { soundManager } from '../../utils/sounds';
import { motion, AnimatePresence } from 'framer-motion';

const DURATION_OPTIONS = [5, 10, 15, 20, 30, 0];

export const BreathingPage = () => {
  const [levelIndex, setLevelIndex] = useState(0);
  const [showInfo, setShowInfo] = useState(false);
  const [showSound, setShowSound] = useState(false);
  const [showPrepModal, setShowPrepModal] = useState(false);

  const [duration, setDuration] = useState(10);
  const [isAudioReady, setIsAudioReady] = useState(false);
  
  const [musicEnabled, setMusicEnabled] = useState(soundManager.isMusicEnabled);
  const [sfxEnabled, setSfxEnabled] = useState(soundManager.isSfxEnabled);
  const [currentTrack, setCurrentTrack] = useState(soundManager.getCurrentTrackId());
  const [musicVol, setMusicVol] = useState(soundManager.musicVolume);
  const [sfxVol, setSfxVol] = useState(soundManager.sfxVolume);

  const prepTimerRef = useRef<number | null>(null);

  const level = BREATH_LEVELS[levelIndex];
  const { phase, phaseTimeLeft, totalTimeLeft, startSession, stopSession } = useBreathingSession(level, duration);

  useEffect(() => {
      const timer = setTimeout(() => setIsAudioReady(true), 500);
      return () => clearTimeout(timer);
  }, []);

  // ğŸ‘‡ Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞ’Ğ¢Ğ-Ğ¡Ğ¢ĞĞ Ğ¢Ğ
  useEffect(() => {
      if (showPrepModal) {
          prepTimerRef.current = window.setTimeout(() => {
              setShowPrepModal(false);
              startSession(); // Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ°
          }, 5500);
      }
      return () => {
          if (prepTimerRef.current) clearTimeout(prepTimerRef.current);
      };
  }, [showPrepModal, startSession]);

  const handleToggleMusic = () => {
      const newState = !musicEnabled;
      setMusicEnabled(newState);
      soundManager.setMusicEnabled(newState);
  };
  const handleToggleSfx = () => {
      const newState = !sfxEnabled;
      setSfxEnabled(newState);
      soundManager.setSfxEnabled(newState);
  };
  const handleSelectTrack = (id: string) => {
      soundManager.setTrack(id);
      setCurrentTrack(id);
  };
  const handleChangeMusicVol = (val: number) => {
      soundManager.setMusicVolume(val);
      setMusicVol(val);
  };
  const handleChangeSfxVol = (val: number) => {
      soundManager.setSfxVolume(val);
      setSfxVol(val);
  };

  const getTotalDuration = () => {
    if (phase === 'inhale') return level.inhale;
    if (phase === 'hold') return level.hold;
    if (phase === 'exhale') return level.exhale;
    return 0;
  };

  const handleToggle = () => {
    if (!isAudioReady) return;
    
    if (phase !== 'idle' && phase !== 'finished') {
        // Ğ¡Ñ‚Ğ¾Ğ¿
        stopSession();
        setShowPrepModal(false);
        if (prepTimerRef.current) clearTimeout(prepTimerRef.current);
    } else {
        // Ğ¡Ñ‚Ğ°Ñ€Ñ‚ (Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºÑƒ)
        soundManager.unlock(); 
        setShowPrepModal(true);
    }
  };

  const formatTotalTime = (s: number) => {
      if (duration === 0) return "âˆ";
      const m = Math.floor(s / 60);
      const sec = s % 60;
      return `${m}:${sec.toString().padStart(2, '0')}`;
  };

  const isRunning = phase !== 'idle' && phase !== 'finished';

  return (
    <div className="min-h-full flex flex-col pb-6 relative z-0">
        
        {/* ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ° Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸ (Ğ‘Ğ•Ğ— onComplete) */}
        <BreathingStartModal 
            isOpen={showPrepModal} 
            onClose={() => {
                setShowPrepModal(false);
                if (prepTimerRef.current) clearTimeout(prepTimerRef.current);
            }} 
        />

        <div className="bg-white rounded-[3rem] shadow-sm shadow-slate-200/50 relative overflow-hidden flex-1 flex flex-col z-10 border border-white/60">
            
            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')] opacity-[0.03] pointer-events-none" />

            {/* HEADER */}
            <div className="px-8 pt-8 pb-4 flex justify-between items-start relative z-20 shrink-0">
                <div className="flex-1 min-w-0 pr-2">
                    <h1 className="text-3xl font-[900] text-slate-800 leading-tight">
                        ĞŸÑ€Ğ°Ğ½Ğ°ÑĞ¼Ğ°
                    </h1>
                    <div className="flex items-center gap-2 mt-1">
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            Ğ“Ğ¸Ğ¿Ğ¾Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ğ¸Ñ
                        </span>
                        {isRunning && (
                            <span className="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md font-mono flex items-center gap-1 animate-in fade-in">
                                <Timer className="w-3 h-3" />
                                {formatTotalTime(totalTimeLeft)}
                            </span>
                        )}
                    </div>
                </div>
                
                <div className="flex gap-2 relative">
                    <button onClick={() => setShowSound(true)} className="p-2 text-slate-300 hover:text-blue-500 transition-colors">
                        <Volume2 className="w-6 h-6" />
                    </button>
                    <button onClick={() => setShowInfo(true)} className="p-2 text-slate-300 hover:text-blue-500 transition-colors">
                        <Info className="w-6 h-6" />
                    </button>
                </div>
            </div>

            {/* CIRCLE & STATUS */}
            <div className="flex-1 flex flex-col items-center justify-center relative z-10 py-6">
                
                <div 
                    onClick={handleToggle} 
                    className={cn(
                        "cursor-pointer relative transform-gpu transition-all duration-500",
                        !isAudioReady && "opacity-50 pointer-events-none",
                        isRunning ? "scale-110" : "hover:scale-105 active:scale-95"
                    )}
                >
                    {!isAudioReady ? (
                        <div className="w-64 h-64 flex flex-col items-center justify-center bg-slate-50 rounded-full border border-slate-100">
                            <Loader2 className="w-8 h-8 text-slate-300 animate-spin mb-2" />
                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</span>
                        </div>
                    ) : phase === 'finished' ? (
                        <div className="w-64 h-64 flex flex-col items-center justify-center bg-white rounded-full border-4 border-green-50 shadow-sm animate-in zoom-in duration-300">
                            <CheckCircle2 className="w-16 h-16 text-green-500 mb-2" />
                            <span className="text-xl font-bold text-slate-700">ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾!</span>
                            <button onClick={(e) => { e.stopPropagation(); stopSession(); }} className="mt-4 text-xs font-bold text-slate-400 uppercase tracking-widest bg-slate-50 px-4 py-2 rounded-xl hover:bg-slate-100">
                                Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ
                            </button>
                        </div>
                    ) : (
                        <div className="relative flex items-center justify-center scale-110">
                            <BreathingCircle 
                                phase={phase} 
                                timeLeft={phaseTimeLeft} 
                                totalDuration={getTotalDuration()} 
                            />
                            
                            {!isRunning && !showPrepModal && (
                                <div className="absolute inset-0 flex items-center justify-center z-20 pointer-events-none">
                                    <span className="text-sm font-black text-slate-300 uppercase tracking-[0.2em] ml-1 animate-pulse">
                                        Ğ¡Ğ¢ĞĞ Ğ¢
                                    </span>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                {/* PATTERN INFO */}
                <div className="w-full px-10 mt-12 flex justify-between items-center text-center max-w-sm">
                    <div className={cn("transition-all duration-500", phase === 'inhale' ? "scale-110 opacity-100" : "opacity-30 blur-[0.5px]")}>
                        <span className="text-[9px] font-bold text-slate-400 uppercase block mb-1">Ğ’Ğ´Ğ¾Ñ…</span>
                        <span className={cn("text-2xl font-black tabular-nums", phase === 'inhale' ? "text-cyan-600" : "text-slate-300")}>{level.inhale}</span>
                    </div>
                    <div className={cn("transition-all duration-500", phase === 'hold' ? "scale-110 opacity-100" : "opacity-30 blur-[0.5px]")}>
                        <span className="text-[9px] font-bold text-slate-400 uppercase block mb-1">Ğ—Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ°</span>
                        <span className={cn("text-3xl font-black leading-none tabular-nums", phase === 'hold' ? "text-violet-600" : "text-slate-300")}>{level.hold}</span>
                    </div>
                    <div className={cn("transition-all duration-500", phase === 'exhale' ? "scale-110 opacity-100" : "opacity-30 blur-[0.5px]")}>
                        <span className="text-[9px] font-bold text-slate-400 uppercase block mb-1">Ğ’Ñ‹Ğ´Ğ¾Ñ…</span>
                        <span className={cn("text-3xl font-black leading-none tabular-nums", phase === 'exhale' ? "text-blue-600" : "text-slate-300")}>{level.exhale}</span>
                    </div>
                </div>
            </div>

            {/* CONTROLS */}
            <AnimatePresence>
                {!isRunning && (
                    <motion.div 
                        initial={{ height: 'auto', opacity: 1 }}
                        exit={{ height: 0, opacity: 0 }}
                        className="px-6 pb-8 pt-4 space-y-6 bg-white/50 backdrop-blur-sm rounded-b-[3rem] overflow-hidden"
                    >
                        <div className="space-y-2">
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1">Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ</p>
                            <div className="flex items-center gap-2 overflow-x-auto scrollbar-hide pb-2 -mx-6 px-6">
                                {DURATION_OPTIONS.map((opt) => (
                                    <button
                                        key={opt}
                                        onClick={() => setDuration(opt)}
                                        className={cn(
                                            "shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all border touch-manipulation",
                                            duration === opt 
                                                ? "bg-slate-800 text-white border-slate-800 shadow-md" 
                                                : "bg-slate-50 text-slate-400 border-slate-100 hover:bg-slate-100"
                                        )}
                                    >
                                        {opt === 0 ? "âˆ" : `${opt}Ğ¼`}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex items-center justify-between bg-slate-50 p-2 rounded-[1.5rem] border border-slate-100">
                            <button 
                                disabled={levelIndex === 0}
                                onClick={() => setLevelIndex(i => i - 1)}
                                className="p-3 hover:bg-slate-50 rounded-xl disabled:opacity-30 transition-colors touch-manipulation"
                            >
                                <ChevronLeft className="w-5 h-5 text-slate-400" />
                            </button>
                            <div className="text-center w-32">
                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-0.5">
                                    Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ
                                </span>
                                <span className="text-xl font-black text-slate-800 leading-none">
                                    {level.id}
                                </span>
                            </div>
                            <button 
                                disabled={levelIndex === BREATH_LEVELS.length - 1}
                                onClick={() => setLevelIndex(i => i + 1)}
                                className="p-3 hover:bg-slate-50 rounded-xl disabled:opacity-30 transition-colors touch-manipulation"
                            >
                                <ChevronRight className="w-5 h-5 text-slate-400" />
                            </button>
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>

        </div>

        {/* MODALS */}
        {showInfo && <InfoSheet onClose={() => setShowInfo(false)} />}
        {showSound && (
            <SoundSheet 
                onClose={() => setShowSound(false)}
                musicEnabled={musicEnabled}
                sfxEnabled={sfxEnabled}
                currentTrackId={currentTrack}
                musicVolume={musicVol}
                sfxVolume={sfxVol}
                onToggleMusic={handleToggleMusic}
                onToggleSfx={handleToggleSfx}
                onSelectTrack={handleSelectTrack}
                onChangeMusicVolume={handleChangeMusicVol}
                onChangeSfxVolume={handleChangeSfxVol}
            />
        )}

    </div>
  );
};

====================
END FILE: src/features/breathing/BreathingPage.tsx
====================

====================
START FILE: src/features/breathing/components/BreathingCircle.tsx
====================
import { motion } from 'framer-motion';
import { cn } from '../../../utils/cn'; // 3 Ñ‚Ğ¾Ñ‡ĞºĞ¸
import type { Phase } from '../hooks/useBreathingSession'; // 1 Ñ‚Ğ¾Ñ‡ĞºĞ°

interface Props {
  phase: Phase;
  timeLeft: number;
  totalDuration: number; 
}

type ConfigType = {
  [key in Phase]: { text: string; color: string; scale: number };
};

export const BreathingCircle = ({ phase, timeLeft, totalDuration }: Props) => {
  
  const config: ConfigType = {
    idle: { text: "", color: "bg-slate-50 border-4 border-white shadow-inner", scale: 1 },
    inhale: { text: "Ğ’Ğ´Ğ¾Ñ…", color: "bg-cyan-100 text-cyan-600", scale: 1.5 },
    hold: { text: "Ğ—Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ°", color: "bg-violet-100 text-violet-600", scale: 1.5 },
    exhale: { text: "Ğ’Ñ‹Ğ´Ğ¾Ñ…", color: "bg-blue-100 text-blue-600", scale: 1 },
    finished: { text: "Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾", color: "bg-green-100 text-green-600", scale: 1 },
  };

  const current = config[phase];

  return (
    <div className="relative w-64 h-64 flex items-center justify-center">
      
      {phase !== 'finished' && phase !== 'idle' && (
        <motion.div
            animate={{ 
                scale: current.scale,
                backgroundColor: phase === 'hold' ? '#ede9fe' : phase === 'inhale' ? '#cffafe' : '#dbeafe'
            }}
            transition={{ 
                duration: totalDuration > 0 ? totalDuration : 0.5, 
                ease: "linear" 
            }}
            className="absolute inset-0 rounded-full opacity-50 blur-2xl"
        />
      )}

      <motion.div
        animate={{ scale: current.scale }}
        transition={{ duration: totalDuration > 0 ? totalDuration : 0.5, ease: "linear" }}
        className={cn(
            "w-32 h-32 rounded-full flex flex-col items-center justify-center shadow-lg relative z-10 transition-colors duration-500",
            current.color
        )}
      >
        {phase !== 'idle' && (
            <>
                <span className="text-sm font-bold uppercase tracking-widest">{current.text}</span>
                {phase !== 'finished' && (
                    <motion.span 
                        key={timeLeft}
                        initial={{ opacity: 0, y: 5 }}
                        animate={{ opacity: 1, y: 0 }}
                        className="text-2xl font-mono font-black mt-1"
                    >
                        {timeLeft}
                    </motion.span>
                )}
            </>
        )}
      </motion.div>

    </div>
  );
};

====================
END FILE: src/features/breathing/components/BreathingCircle.tsx
====================

====================
START FILE: src/features/breathing/components/SoundSheet.tsx
====================
import { createPortal } from 'react-dom'; // ğŸ‘ˆ
import { motion, AnimatePresence } from 'framer-motion';
import { X, Music, Flame, Wind, CloudRain, Star, Volume2, VolumeX } from 'lucide-react';
import { cn } from '../../../utils/cn';
import { AMBIENT_TRACKS } from '../../../utils/sounds';
import { VolumeSlider } from './VolumeSlider';

interface Props {
  onClose: () => void;
  musicEnabled: boolean;
  sfxEnabled: boolean;
  currentTrackId: string;
  musicVolume: number;
  sfxVolume: number;
  onToggleMusic: () => void;
  onToggleSfx: () => void;
  onSelectTrack: (id: string) => void;
  onChangeMusicVolume: (val: number) => void;
  onChangeSfxVolume: (val: number) => void;
}

const icons = {
    fire: Flame,
    wind: Wind,
    rain: CloudRain,
    space: Star
};

export const SoundSheet = ({ 
    onClose, musicEnabled, sfxEnabled, currentTrackId, musicVolume, sfxVolume,
    onToggleMusic, onToggleSfx, onSelectTrack, onChangeMusicVolume, onChangeSfxVolume 
}: Props) => {
  
  const content = (
    <AnimatePresence>
      <>
        {/* Ğ—Ğ°Ñ‚ĞµĞ¼Ğ½ĞµĞ½Ğ¸Ğµ */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          onClick={onClose}
          className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[100]"
        />

        {/* Ğ¨Ñ‚Ğ¾Ñ€ĞºĞ° */}
        <motion.div
          initial={{ y: "100%" }}
          animate={{ y: 0 }}
          exit={{ y: "100%" }}
          transition={{ type: "spring", damping: 25, stiffness: 300 }}
          className="fixed bottom-0 left-0 right-0 z-[101] bg-[#F2F2F7] rounded-t-[2.5rem] shadow-2xl flex flex-col overflow-hidden max-w-md mx-auto h-[85vh]"
        >
          <div className="w-full flex justify-center pt-3 pb-2 bg-[#F2F2F7] shrink-0" onClick={onClose}>
            <div className="w-12 h-1.5 bg-gray-300 rounded-full" />
          </div>

          <div className="flex justify-between items-center px-8 pt-2 pb-6">
              <h3 className="text-2xl font-[900] text-slate-800">ĞÑƒĞ´Ğ¸Ğ¾ÑÑ„ĞµÑ€Ğ°</h3>
              <button onClick={onClose} className="p-2 bg-gray-200/50 text-gray-500 rounded-full hover:bg-gray-300 transition-colors">
                  <X className="w-5 h-5" />
              </button>
          </div>

          <div className="flex-1 overflow-y-auto px-4 pb-10 space-y-4">
              
              {/* ĞœÑƒĞ·Ñ‹ĞºĞ° */}
              <div className="bg-white rounded-[2rem] p-1 shadow-sm border border-white">
                  <div 
                      onClick={onToggleMusic}
                      className="flex items-center justify-between p-4 cursor-pointer active:opacity-70 transition-opacity"
                  >
                      <div className="flex items-center gap-4">
                          <div className={cn("w-12 h-12 rounded-2xl flex items-center justify-center transition-colors", musicEnabled ? "bg-violet-100 text-violet-600" : "bg-slate-100 text-slate-400")}>
                              <Music className="w-6 h-6" />
                          </div>
                          <div>
                              <h4 className="font-bold text-lg text-slate-800 leading-none">ĞÑ‚Ğ¼Ğ¾ÑÑ„ĞµÑ€Ğ°</h4>
                              <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wide mt-1">Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ²ÑƒĞº</p>
                          </div>
                      </div>
                      <div className={cn("w-12 h-7 rounded-full relative transition-colors duration-300", musicEnabled ? "bg-violet-500" : "bg-slate-200")}>
                          <div className={cn("w-5 h-5 bg-white rounded-full absolute top-1 transition-all shadow-md", musicEnabled ? "left-6" : "left-1")} />
                      </div>
                  </div>

                  <AnimatePresence>
                      {musicEnabled && (
                          <motion.div 
                              initial={{ height: 0, opacity: 0 }} 
                              animate={{ height: "auto", opacity: 1 }} 
                              exit={{ height: 0, opacity: 0 }}
                              className="overflow-hidden"
                          >
                              <div className="p-4 pt-0">
                                  <div className="grid grid-cols-2 gap-2 mb-6">
                                      {AMBIENT_TRACKS.map((track) => {
                                          const Icon = icons[track.icon];
                                          const isSelected = currentTrackId === track.id;
                                          return (
                                              <button
                                                  key={track.id}
                                                  onClick={() => onSelectTrack(track.id)}
                                                  className={cn(
                                                      "flex items-center gap-3 p-3 rounded-2xl transition-all border text-left",
                                                      isSelected 
                                                          ? "bg-slate-800 border-slate-800 text-white shadow-lg" 
                                                          : "bg-slate-50 border-slate-50 text-slate-500 hover:bg-slate-100"
                                                  )}
                                              >
                                                  <div className={cn("p-1.5 rounded-lg", isSelected ? "bg-white/20" : "bg-white")}>
                                                      <Icon className="w-4 h-4" />
                                                  </div>
                                                  <span className="text-xs font-bold">{track.name}</span>
                                              </button>
                                          );
                                      })}
                                  </div>

                                  <VolumeSlider 
                                      value={musicVolume} 
                                      onChange={onChangeMusicVolume} 
                                      colorClass="bg-violet-500" 
                                  />
                              </div>
                          </motion.div>
                      )}
                  </AnimatePresence>
              </div>

              {/* Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ */}
              <div className="bg-white rounded-[2rem] p-1 shadow-sm border border-white">
                  <div 
                      onClick={onToggleSfx}
                      className="flex items-center justify-between p-4 cursor-pointer active:opacity-70 transition-opacity"
                  >
                      <div className="flex items-center gap-4">
                          <div className={cn("w-12 h-12 rounded-2xl flex items-center justify-center transition-colors", sfxEnabled ? "bg-blue-100 text-blue-600" : "bg-slate-100 text-slate-400")}>
                              {sfxEnabled ? <Volume2 className="w-6 h-6" /> : <VolumeX className="w-6 h-6" />}
                          </div>
                          <div>
                              <h4 className="font-bold text-lg text-slate-800 leading-none">Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ñ‹</h4>
                              <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wide mt-1">Ğ’Ğ´Ğ¾Ñ… / Ğ’Ñ‹Ğ´Ğ¾Ñ…</p>
                          </div>
                      </div>
                      <div className={cn("w-12 h-7 rounded-full relative transition-colors duration-300", sfxEnabled ? "bg-blue-500" : "bg-slate-200")}>
                          <div className={cn("w-5 h-5 bg-white rounded-full absolute top-1 transition-all shadow-md", sfxEnabled ? "left-6" : "left-1")} />
                      </div>
                  </div>

                  <AnimatePresence>
                      {sfxEnabled && (
                          <motion.div 
                              initial={{ height: 0, opacity: 0 }} 
                              animate={{ height: "auto", opacity: 1 }} 
                              exit={{ height: 0, opacity: 0 }}
                              className="overflow-hidden"
                          >
                              <div className="p-4 pt-0">
                                  <VolumeSlider 
                                      value={sfxVolume} 
                                      onChange={onChangeSfxVolume} 
                                      colorClass="bg-blue-500" 
                                  />
                              </div>
                          </motion.div>
                      )}
                  </AnimatePresence>
              </div>

          </div>
        </motion.div>
      </>
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};

====================
END FILE: src/features/breathing/components/SoundSheet.tsx
====================

====================
START FILE: src/features/breathing/components/InfoSheet.tsx
====================
import { createPortal } from 'react-dom'; // ğŸ‘ˆ
import { motion, AnimatePresence } from 'framer-motion';
import { X, Sparkles, AlertTriangle, Mountain, Wind, Brain } from 'lucide-react';

interface Props {
  onClose: () => void;
}

export const InfoSheet = ({ onClose }: Props) => {
  const content = (
    <AnimatePresence>
      <>
        {/* Ğ—Ğ°Ñ‚ĞµĞ¼Ğ½ĞµĞ½Ğ¸Ğµ */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          onClick={onClose}
          className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[100]"
        />

        {/* Ğ¨Ñ‚Ğ¾Ñ€ĞºĞ° */}
        <motion.div
          initial={{ y: "100%" }}
          animate={{ y: 0 }}
          exit={{ y: "100%" }}
          transition={{ type: "spring", damping: 25, stiffness: 300 }}
          className="fixed bottom-0 left-0 right-0 z-[101] bg-[#F2F2F7] rounded-t-[2.5rem] h-[85vh] shadow-2xl flex flex-col overflow-hidden max-w-md mx-auto"
        >
          {/* Ğ¥ĞµĞ½Ğ´Ğ» */}
          <div className="w-full flex justify-center pt-3 pb-2 bg-[#F2F2F7] shrink-0" onClick={onClose}>
            <div className="w-12 h-1.5 bg-gray-300 rounded-full" />
          </div>

          <button 
              onClick={onClose}
              className="absolute top-4 right-4 p-2 bg-gray-200/50 hover:bg-gray-200 rounded-full transition-colors z-50"
          >
              <X className="w-5 h-5 text-gray-500" />
          </button>

          <div className="flex-1 overflow-y-auto pb-safe px-4 pt-2">
            
            <div className="text-center mb-8 px-4">
              <div className="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-3 shadow-lg bg-blue-50 text-blue-600">
                  <Wind className="w-8 h-8" />
              </div>
              <h2 className="text-2xl font-black text-slate-900 leading-tight">
                  Ğ ĞŸÑ€Ğ°ĞºÑ‚Ğ¸ĞºĞµ
              </h2>
              <p className="text-sm font-medium text-gray-400 mt-1 uppercase tracking-wide">
                  Ğ“Ğ¸Ğ¿Ğ¾Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ğ¸Ñ
              </p>
            </div>

            <div className="space-y-4 pb-10">
              <div className="bg-white rounded-2xl p-5 shadow-sm">
                  <div className="flex items-center gap-2 mb-3 border-b border-gray-100 pb-2">
                      <Sparkles className="w-5 h-5 text-emerald-500" />
                      <h3 className="font-bold text-slate-800">ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°</h3>
                  </div>
                  <ul className="space-y-2">
                      <li className="flex gap-3 text-sm text-slate-600">
                          <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 mt-1.5 shrink-0" />
                          ĞĞ¾Ğ·Ğ´Ñ€Ğ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¼Ğ¸.
                      </li>
                      <li className="flex gap-3 text-sm text-slate-600">
                          <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 mt-1.5 shrink-0" />
                          Ğ–ĞµĞ»ÑƒĞ´Ğ¾Ğº Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.
                      </li>
                      <li className="flex gap-3 text-sm text-slate-600">
                          <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 mt-1.5 shrink-0" />
                          Ğ Ğ°ÑÑĞ»Ğ°Ğ±ÑŒÑ‚Ğµ Ğ²ÑĞµ Ğ¼Ñ‹ÑˆÑ†Ñ‹ Ñ‚ĞµĞ»Ğ°.
                      </li>
                  </ul>
              </div>

              <div className="bg-rose-50 rounded-2xl p-5 border border-rose-100">
                  <div className="flex items-center gap-2 mb-2 text-rose-600">
                      <AlertTriangle className="w-5 h-5" />
                      <h3 className="font-bold">Ğ’Ğ°Ğ¶Ğ½Ğ¾</h3>
                  </div>
                  <p className="text-xs text-rose-800 leading-relaxed opacity-90">
                      ĞĞµ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°Ğ¹Ñ‚ĞµÑÑŒ, ĞµÑĞ»Ğ¸ Ğ²Ñ‹ Ğ¿Ñ€Ğ¾ÑÑ‚ÑƒĞ¶ĞµĞ½Ñ‹. ĞŸÑ€Ğ°ĞºÑ‚Ğ¸ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ½Ğ¾ÑĞ¸Ñ‚ÑŒ Ñ€Ğ°Ğ´Ğ¾ÑÑ‚ÑŒ.
                  </p>
              </div>

              <div className="bg-white rounded-2xl p-5 shadow-sm">
                  <div className="flex items-center gap-2 mb-3 border-b border-gray-100 pb-2">
                      <Brain className="w-5 h-5 text-violet-500" />
                      <h3 className="font-bold text-slate-800">ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¼Ğ¾Ğ·Ğ³Ğ°</h3>
                  </div>
                  <p className="text-sm text-slate-600 leading-relaxed">
                      Ğ¢ĞµÑ…Ğ½Ğ¸ĞºĞ° Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ñ‚ ÑƒĞ¼ Ğº ÑƒĞ¼Ğ¸Ñ€Ğ¾Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¸Ñ.
                  </p>
              </div>

              <div className="bg-gradient-to-br from-blue-50 to-white rounded-2xl p-5 border border-blue-100 shadow-sm">
                  <div className="flex items-center gap-2 mb-3">
                      <Mountain className="w-5 h-5 text-blue-600" />
                      <h3 className="font-bold text-blue-900">Ğ­Ñ„Ñ„ĞµĞºÑ‚ Ğ“Ğ¾Ñ€</h3>
                  </div>
                  <p className="text-sm text-slate-600 leading-relaxed mb-3">
                      Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ Ğ»ĞµĞ³ĞºĞ°Ñ Ğ³Ğ¸Ğ¿Ğ¾ĞºÑĞ¸Ñ, Ğ²ĞºĞ»ÑÑ‡Ğ°ÑÑ‰Ğ°Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼Ğ°.
                  </p>
              </div>
            </div>
          </div>
        </motion.div>
      </>
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};

====================
END FILE: src/features/breathing/components/InfoSheet.tsx
====================

====================
START FILE: src/features/breathing/components/VolumeSlider.tsx
====================
import { useRef } from 'react';
import { motion, useMotionValue } from 'framer-motion';
import { Volume2, Volume1, VolumeX } from 'lucide-react';
import { cn } from '../../../utils/cn';

interface Props {
  value: number;
  onChange: (val: number) => void;
  colorClass: string;
}

export const VolumeSlider = ({ value, onChange, colorClass }: Props) => {
  const ref = useRef<HTMLDivElement>(null);
  const progressMV = useMotionValue(value);

  const updateValue = (clientX: number) => {
    if (!ref.current) return;

    const rect = ref.current.getBoundingClientRect();
    const x = clientX - rect.left;
    let newValue = x / rect.width;
    newValue = Math.max(0, Math.min(1, newValue));

    progressMV.set(newValue);
    onChange(newValue);
  };

  const handlePointerDown = (e: React.PointerEvent) => {
    e.preventDefault();
    updateValue(e.clientX);

    const onMove = (e: PointerEvent) => updateValue(e.clientX);
    const onUp = () => {
      window.removeEventListener('pointermove', onMove);
      window.removeEventListener('pointerup', onUp);
    };

    window.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', onUp);
  };

  const Icon =
    value === 0 ? VolumeX : value < 0.5 ? Volume1 : Volume2;

  return (
    <div
      ref={ref}
      onPointerDown={handlePointerDown}
      className="relative h-14 w-full rounded-2xl bg-slate-100 overflow-hidden cursor-pointer touch-none select-none"
    >
      {/* ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ (GPU only) */}
      <motion.div
        className={cn(
          'absolute inset-0 origin-left',
          colorClass
        )}
        style={{
          scaleX: progressMV,
          willChange: 'transform',
        }}
      />

      {/* ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ */}
      <div className="absolute inset-0 z-10 flex items-center justify-between px-4 pointer-events-none">
        <Icon
          className={cn(
            'w-5 h-5 transition-colors',
            value > 0.1 ? 'text-white' : 'text-slate-400'
          )}
        />

        <span
          className={cn(
            'text-xs font-black font-mono tracking-widest transition-colors',
            value > 0.9 ? 'text-white/80' : 'text-slate-400'
          )}
        >
          {Math.round(value * 100)}%
        </span>
      </div>
    </div>
  );
};

====================
END FILE: src/features/breathing/components/VolumeSlider.tsx
====================

====================
START FILE: src/features/breathing/components/BreathingStartModal.tsx
====================
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Wind } from 'lucide-react';
import { useEffect, useState } from 'react';

interface Props {
  isOpen: boolean;
  onClose: () => void;
}

export const BreathingStartModal = ({ isOpen, onClose }: Props) => {
  const [count, setCount] = useState(5);

  useEffect(() => {
    if (isOpen) {
        setCount(5);
        const timer = setInterval(() => {
            setCount((c) => (c > 1 ? c - 1 : 1));
        }, 1000);
        return () => clearInterval(timer);
    }
  }, [isOpen]);

  const content = (
    <AnimatePresence>
      {isOpen && (
        <>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/60 backdrop-blur-md z-[10000]"
          />

          <div className="fixed inset-0 z-[10001] flex items-center justify-center p-6 pointer-events-none">
              <motion.div
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.9 }}
                transition={{ type: "spring", damping: 25, stiffness: 300 }}
                className="w-full max-w-xs bg-white rounded-[3rem] shadow-2xl p-8 relative pointer-events-auto"
              >
                  <button 
                    onClick={onClose}
                    className="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-500 transition-colors z-20"
                  >
                    <X className="w-6 h-6" />
                  </button>

                  <div className="flex flex-col items-center text-center pt-6">
                    
                    {/* ĞĞ½Ğ¸Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºÑ€ÑƒĞ³ Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ¼ */}
                    <div className="relative w-40 h-40 flex items-center justify-center mb-10">
                        <motion.div 
                            animate={{ scale: [1, 1.3, 1], opacity: [0.3, 0.6, 0.3] }}
                            transition={{ duration: 5, ease: "easeInOut", repeat: Infinity }}
                            className="absolute inset-0 bg-indigo-200 rounded-full blur-2xl"
                        />
                        
                        <motion.div 
                            animate={{ scale: [1, 1.05, 1] }}
                            transition={{ duration: 5, ease: "easeInOut", repeat: Infinity }}
                            className="w-28 h-28 bg-white rounded-full shadow-lg flex items-center justify-center relative z-10 border-4 border-indigo-50"
                        >
                            <motion.span 
                                key={count} 
                                initial={{ opacity: 0, scale: 0.5 }}
                                animate={{ opacity: 1, scale: 1 }}
                                className="text-5xl font-[900] text-indigo-500 tabular-nums"
                            >
                                {count}
                            </motion.span>
                            
                            <svg className="absolute inset-[-4px] w-[calc(100%+8px)] h-[calc(100%+8px)] -rotate-90 pointer-events-none overflow-visible">
                                <motion.circle 
                                    cx="50%" cy="50%" r="48%" fill="none" 
                                    stroke="#6366f1" strokeWidth="4" strokeLinecap="round"
                                    initial={{ pathLength: 0 }}
                                    animate={{ pathLength: 1 }}
                                    transition={{ duration: 5.5, ease: "linear" }}
                                />
                            </svg>
                        </motion.div>
                    </div>
                    
                    <div className="flex flex-col items-center gap-2">
                        <div className="p-3 bg-indigo-50 rounded-2xl text-indigo-500 mb-2">
                            <Wind className="w-6 h-6 animate-pulse" />
                        </div>
                        <p className="text-base font-bold text-slate-600 leading-relaxed max-w-[220px]">
                            Ğ—Ğ°Ğ¹Ğ¼Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ. <br/>
                            Ğ Ğ°ÑÑĞ»Ğ°Ğ±ÑŒÑ‚Ğµ Ñ‚ĞµĞ»Ğ¾.
                        </p>
                    </div>

                  </div>
              </motion.div>
          </div>
        </>
      )}
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};

====================
END FILE: src/features/breathing/components/BreathingStartModal.tsx
====================

====================
START FILE: src/features/breathing/components/SoundMixer.tsx
====================
import { motion } from 'framer-motion';
import { Music, Bell, Flame, Wind, CloudRain, Star } from 'lucide-react';
import { cn } from '../../../utils/cn';
import { AMBIENT_TRACKS } from '../../../utils/sounds';

interface Props {
  musicEnabled: boolean;
  sfxEnabled: boolean;
  currentTrackId: string;
  onToggleMusic: () => void;
  onToggleSfx: () => void;
  onSelectTrack: (id: string) => void;
  onClose: () => void;
}

// ĞœĞ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ Ğ¸ĞºĞ¾Ğ½Ğ¾Ğº
const icons = {
    fire: Flame,
    wind: Wind,
    rain: CloudRain,
    space: Star
};

export const SoundMixer = ({ 
    musicEnabled, sfxEnabled, currentTrackId, 
    onToggleMusic, onToggleSfx, onSelectTrack, onClose 
}: Props) => {
  return (
    <>
      <div className="fixed inset-0 z-40" onClick={onClose} />

      <motion.div
        initial={{ opacity: 0, scale: 0.9, y: 10 }}
        animate={{ opacity: 1, scale: 1, y: 0 }}
        exit={{ opacity: 0, scale: 0.9, y: 10 }}
        className="absolute top-16 right-0 z-50 bg-white/95 backdrop-blur-xl border border-white/50 p-4 rounded-[1.5rem] shadow-xl w-64 origin-top-right"
      >
        
        {/* 1. Ğ“Ğ›ĞĞ’ĞĞ«Ğ• ĞŸĞ•Ğ Ğ•ĞšĞ›Ğ®Ğ§ĞĞ¢Ğ•Ğ›Ğ˜ */}
        <div className="flex gap-2 mb-4">
            <button 
                onClick={onToggleMusic}
                className={cn(
                    "flex-1 flex flex-col items-center justify-center p-3 rounded-xl border transition-all",
                    musicEnabled ? "bg-violet-50 border-violet-100" : "bg-slate-50 border-transparent opacity-60"
                )}
            >
                <Music className={cn("w-5 h-5 mb-1", musicEnabled ? "text-violet-600" : "text-slate-400")} />
                <span className="text-[9px] font-bold uppercase tracking-wide text-slate-500">ĞœÑƒĞ·Ñ‹ĞºĞ°</span>
            </button>

            <button 
                onClick={onToggleSfx}
                className={cn(
                    "flex-1 flex flex-col items-center justify-center p-3 rounded-xl border transition-all",
                    sfxEnabled ? "bg-blue-50 border-blue-100" : "bg-slate-50 border-transparent opacity-60"
                )}
            >
                <Bell className={cn("w-5 h-5 mb-1", sfxEnabled ? "text-blue-600" : "text-slate-400")} />
                <span className="text-[9px] font-bold uppercase tracking-wide text-slate-500">Ğ—Ğ²ÑƒĞºĞ¸</span>
            </button>
        </div>

        {/* 2. Ğ’Ğ«Ğ‘ĞĞ  ĞĞ¢ĞœĞĞ¡Ğ¤Ğ•Ğ Ğ« (Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ¼ÑƒĞ·Ñ‹ĞºĞ° Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ°) */}
        {musicEnabled && (
            <div className="space-y-2 animate-in fade-in slide-in-from-top-2">
                <h4 className="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">
                    ĞÑ‚Ğ¼Ğ¾ÑÑ„ĞµÑ€Ğ°
                </h4>
                
                <div className="grid grid-cols-4 gap-2">
                    {AMBIENT_TRACKS.map((track) => {
                        const Icon = icons[track.icon];
                        const isSelected = currentTrackId === track.id;
                        
                        return (
                            <button
                                key={track.id}
                                onClick={() => onSelectTrack(track.id)}
                                className={cn(
                                    "flex flex-col items-center justify-center p-2 rounded-xl transition-all border",
                                    isSelected 
                                        ? "bg-slate-800 text-white border-slate-800 shadow-md scale-105" 
                                        : "bg-white border-slate-100 text-slate-400 hover:bg-slate-50"
                                )}
                            >
                                <Icon className="w-4 h-4 mb-1" />
                                <span className="text-[8px] font-bold truncate w-full text-center">
                                    {track.name}
                                </span>
                            </button>
                        );
                    })}
                </div>
            </div>
        )}

      </motion.div>
    </>
  );
};

====================
END FILE: src/features/breathing/components/SoundMixer.tsx
====================

====================
START FILE: src/features/breathing/hooks/useBreathingSession.ts
====================
// src/features/breathing/hooks/useBreathingSession.ts
import { useState, useEffect, useRef, useCallback } from 'react';
import type { BreathLevel } from '../data/patterns';
import dayjs from 'dayjs';
import { soundManager } from '../../../utils/sounds';
import { storageUpdateHistory } from '../../../utils/storage'; // ğŸ‘ˆ NEW
import type { HistoryRecord } from '../../../utils/types';

const MIN_SESSION_DURATION_SECONDS = 15;
const TIMER_INTERVAL_MS = 250;

export type Phase = 'idle' | 'inhale' | 'hold' | 'exhale' | 'finished';

export const useBreathingSession = (level: BreathLevel, sessionDurationMinutes: number) => {
  const [phase, setPhase] = useState<Phase>('idle');
  const [phaseTimeLeft, setPhaseTimeLeft] = useState(0);
  const [totalTimeLeft, setTotalTimeLeft] = useState(0);
  const [cycles, setCycles] = useState(0);

  const state = useRef({
    status: 'idle' as Phase,
    startTime: null as number | null,     
    phaseEndTime: 0,                      
    sessionEndTime: 0,                    
    isInfinite: false,
    timerId: null as number | null
  });

  const nextPhase = useCallback(() => {
    const current = state.current.status;
    let next: Phase = 'idle';
    let duration = 0;

    if (current === 'inhale') {
      next = 'hold';
      duration = level.hold;
      soundManager.playHold();
    } else if (current === 'hold') {
      next = 'exhale';
      duration = level.exhale;
      soundManager.playExhale();
    } else if (current === 'exhale') {
      next = 'inhale';
      duration = level.inhale;
      setCycles(c => c + 1);
      soundManager.playInhale();
    }

    const now = Date.now();
    state.current.status = next;
    state.current.phaseEndTime = now + (duration * 1000); 
    
    setPhase(next);
    setPhaseTimeLeft(duration);
    
    if (navigator.vibrate) navigator.vibrate(50);
  }, [level]);

  const stopEngine = useCallback(() => {
    if (state.current.timerId) {
      clearInterval(state.current.timerId);
      state.current.timerId = null;
    }
  }, []);

  // Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ•
  const saveToHistory = useCallback((endTimeStr: string, durationSec: number) => {
    if (durationSec < MIN_SESSION_DURATION_SECONDS) return; 

    const record: HistoryRecord = {
      id: Date.now().toString(),
      type: 'breathing',
      scheme: `Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ${level.id} (${level.inhale}-${level.hold}-${level.exhale})`,
      startTime: dayjs(state.current.startTime || Date.now()).toISOString(),
      endTime: endTimeStr,
      durationSeconds: durationSec
    };

    // ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ (fire and forget)
    storageUpdateHistory('history_fasting', record);
  }, [level]);

  const finishSession = useCallback(() => {
    stopEngine();
    
    soundManager.playFinish(); 
    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

    if (state.current.startTime) {
      const now = Date.now();
      const duration = Math.floor((now - state.current.startTime) / 1000);
      saveToHistory(dayjs(now).toISOString(), duration);
    }

    setPhase('finished');
    state.current.status = 'finished';
  }, [stopEngine, saveToHistory]);

  const tick = useCallback(() => {
    const now = Date.now();
    const s = state.current;

    if (!s.isInfinite && s.sessionEndTime > 0) {
      const remaining = Math.ceil((s.sessionEndTime - now) / 1000);
      if (remaining <= 0) {
        finishSession();
        return;
      }
      setTotalTimeLeft(remaining);
    }

    const phaseRemaining = Math.ceil((s.phaseEndTime - now) / 1000);
    if (phaseRemaining <= 0) {
      nextPhase();
    } else {
      setPhaseTimeLeft(phaseRemaining);
    }
  }, [nextPhase, finishSession]);

  const stopSession = useCallback(() => {
    if (state.current.startTime && state.current.status !== 'idle' && state.current.status !== 'finished') {
      const now = Date.now();
      const duration = Math.floor((now - state.current.startTime) / 1000);
      saveToHistory(dayjs(now).toISOString(), duration);
    }

    stopEngine();
    soundManager.stopSession(); 
    
    state.current.status = 'idle';
    setPhase('idle');
  }, [stopEngine, saveToHistory]);

  const startSession = useCallback(() => {
    stopEngine();
    soundManager.unlock();
    soundManager.startSession(); 
    soundManager.playInhale();   

    const now = Date.now();
    state.current.startTime = now;
    state.current.status = 'inhale';
    state.current.phaseEndTime = now + (level.inhale * 1000);
    state.current.isInfinite = sessionDurationMinutes === 0;
    
    if (sessionDurationMinutes > 0) {
      state.current.sessionEndTime = now + (sessionDurationMinutes * 60 * 1000);
      setTotalTimeLeft(sessionDurationMinutes * 60);
    } else {
      state.current.sessionEndTime = 0;
      setTotalTimeLeft(0);
    }

    setPhase('inhale');
    setPhaseTimeLeft(level.inhale);
    setCycles(0);

    state.current.timerId = window.setInterval(tick, TIMER_INTERVAL_MS);
  }, [level, sessionDurationMinutes, tick, stopEngine]);

  useEffect(() => {
    return () => {
      // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ·Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸
      if (state.current.status !== 'idle' && state.current.status !== 'finished') {
        const now = Date.now();
        const start = state.current.startTime || now;
        const duration = Math.floor((now - start) / 1000);
        
        if (duration > MIN_SESSION_DURATION_SECONDS) {
             const rec: HistoryRecord = {
                id: Date.now().toString(),
                type: 'breathing',
                scheme: `Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ${level.id}`, 
                startTime: dayjs(start).toISOString(),
                endTime: dayjs(now).toISOString(),
                durationSeconds: duration
             };
             // Fire and forget
             storageUpdateHistory('history_fasting', rec);
        }
      }
      stopEngine();
      soundManager.stopAll(); 
    };
  }, [level, stopEngine]); 

  return { 
    phase, 
    phaseTimeLeft, 
    totalTimeLeft, 
    startSession, 
    stopSession, 
    cycles 
  };
};

====================
END FILE: src/features/breathing/hooks/useBreathingSession.ts
====================

====================
START FILE: src/features/breathing/data/patterns.ts
====================
export interface BreathLevel {
  id: number;
  name: string;
  inhale: number;
  hold: number;
  exhale: number;
}

export const BREATH_LEVELS: BreathLevel[] = [
  { id: 0, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 0 (ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)", inhale: 4, hold: 16, exhale: 8 },
  { id: 1, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 1", inhale: 5, hold: 20, exhale: 10 },
  { id: 2, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 2", inhale: 6, hold: 24, exhale: 12 },
  { id: 3, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 3", inhale: 7, hold: 28, exhale: 14 },
  { id: 4, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 4", inhale: 8, hold: 32, exhale: 16 },
  { id: 5, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 5", inhale: 9, hold: 36, exhale: 18 },
  { id: 6, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 6", inhale: 10, hold: 40, exhale: 20 },
  { id: 7, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 7", inhale: 12, hold: 48, exhale: 24 },
  { id: 8, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 8", inhale: 13, hold: 52, exhale: 26 },
  { id: 9, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 9", inhale: 15, hold: 60, exhale: 30 },
  { id: 10, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 10 (ĞœĞ°ÑÑ‚ĞµÑ€)", inhale: 20, hold: 80, exhale: 40 },
  { id: 11, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 11 (Ğ“ÑƒÑ€Ñƒ)", inhale: 24, hold: 96, exhale: 48 },
  { id: 12, name: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 12 (ĞĞ±ÑĞ¾Ğ»ÑÑ‚)", inhale: 36, hold: 144, exhale: 72 },
];

export const BREATH_INFO = {
  title: "Ğ“Ğ¸Ğ¿Ğ¾Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ğ¸Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ°",
  description: `Ğ”Ğ»Ñ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¸ - Ğ½Ğ¾Ğ·Ğ´Ñ€Ğ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¼Ğ¸. Ğ¢Ğ°Ğº Ğ¶Ğµ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¼ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¶ĞµĞ»ÑƒĞ´Ğ¾Ğº. ĞĞµ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°Ğ¹Ñ‚ĞµÑÑŒ, ĞµÑĞ»Ğ¸ Ğ²Ñ‹ Ğ¿Ñ€Ğ¾ÑÑ‚ÑƒĞ¶ĞµĞ½Ñ‹ Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾ Ğ´Ñ‹ÑˆĞ°Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ½Ğ¾Ñ. ĞĞµ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¸Ğ»Ñƒ, Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ² Ñ€Ğ°Ğ´Ğ¾ÑÑ‚ÑŒ. Ğ Ğ°ÑÑĞ»Ğ°Ğ±ÑŒÑ‚Ğµ Ğ²ÑĞµ Ğ¼Ñ‹ÑˆÑ†Ñ‹ Ñ‚ĞµĞ»Ğ°.

ĞŸÑ€Ğ°ĞºÑ‚Ğ¸ĞºĞ° Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¸ Ñ‚Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½ĞµÑ€Ğ²Ğ½ÑƒÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ. ĞĞ°Ğ²ĞµÑ€Ğ½Ğ¾Ğµ, Ğ½Ğ¸ Ğ¾Ğ´Ğ½Ğ° Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ‚Ğ°Ğº Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¿Ñ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ Ğ¸ ÑƒĞ¼Ğ° Ğ¾Ñ‚ Ğ±ĞµÑĞ¿Ğ¾ĞºĞ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğº ÑƒĞ¼Ğ¸Ñ€Ğ¾Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¸Ñ. Ğ’ÑĞµĞ³Ğ¾ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚ ÑĞ¾ÑÑ€ĞµĞ´Ğ¾Ñ‚Ğ¾Ñ‡ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¸, Ğ¸ Ğ²Ğ¾Ñ‚ Ğ²Ñ‹ ÑƒĞ¶Ğµ ÑĞ¾Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ğ¾ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº. Ğ˜ Ğ²ÑĞµ ÑÑ‚Ğ¾ Ğ±ĞµĞ· Ğ»ĞµĞºĞ°Ñ€ÑÑ‚Ğ² Ğ¸ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ… Ñ…Ğ¸Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ²Ğ¾Ğ·Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹.

ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾, Ğ¼Ğ¾Ñ‰Ğ½Ñ‹Ğ¹ ÑƒÑĞ¿Ğ¾ĞºĞ¾Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¸ ÑÑ‚Ğ¾ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹ Ğ¿Ğ»ÑÑ. ĞĞ¾ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¸ Ğ²Ğ¾Ğ·Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ½Ğ° ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ñ‡ĞµÑĞºÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ° Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ´Ğ¾ Ğ³Ğ»ÑƒĞ±Ğ¶Ğµ. ĞĞ°Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ³Ğ»ÑƒĞ±Ğ¶Ğµ, Ñ‡ĞµĞ¼ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑĞµĞ±Ğµ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ.

Ğ¢ĞµÑ…Ğ½Ğ¸ĞºĞ° Ğ´Ñ‹Ñ…Ğ°Ğ½Ğ¸Ñ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ Ğº Ğ³Ğ¸Ğ¿Ğ¾Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¼ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ°Ğ¼. Ğ¢Ğ¾ ĞµÑÑ‚ÑŒ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ±ÑŠÑ‘Ğ¼ Ğ²Ğ¾Ğ·Ğ´ÑƒÑ…Ğ°, Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· Ğ»Ñ‘Ğ³ĞºĞ¸Ğµ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞ°ĞµÑ‚ÑÑ Ğ¿Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¼ Ğ´Ñ‹Ñ…Ğ°Ğ½Ğ¸ĞµĞ¼. Ğ­Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğº Ğ³Ğ¸Ğ¿Ğ¾ĞºÑĞ¸Ğ¸ - Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚ĞºÑƒ ĞºĞ¸ÑĞ»Ğ¾Ñ€Ğ¾Ğ´Ğ° Ğ² Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼Ğµ. ĞœĞµĞ´Ğ¸Ñ†Ğ¸Ğ½Ğµ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾, Ñ‡Ñ‚Ğ¾ ĞºÑ€Ğ°Ñ‚ĞºĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ³Ğ¸Ğ¿Ğ¾ĞºÑĞ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞ°ĞµÑ‚ ÑĞ¾Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ»ÑĞµĞ¼Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼Ğ° Ğ±Ğ¾Ğ»ĞµĞ·Ğ½ÑĞ¼ Ğ¸ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğµ ÑĞ¸Ğ»Ñ‹ Ğ´Ğ»Ñ ÑĞ°Ğ¼Ğ¾Ğ¾Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ¸Ñ.`
};

====================
END FILE: src/features/breathing/data/patterns.ts
====================

====================
START FILE: src/features/fasting/FastingPage.tsx
====================
import { useState, useEffect, useRef, memo } from 'react';
import { useFastingTimerContext } from './context/TimerContext';
import { ProtocolSelector } from './components/ProtocolSelector';
import { FastingStartModal } from './components/FastingStartModal';
import { NativeDatePicker } from '../../components/ui/DatePicker';
import { Play, Square, ListFilter, Sunrise, Moon, Map } from 'lucide-react';
import { cn } from '../../utils/cn';
import dayjs from 'dayjs';
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';

// 1. ĞšĞ½Ğ¾Ğ¿ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹ (ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ)
const MapButton = memo(({ onClick }: { onClick: () => void }) => (
    <button 
        onClick={onClick}
        className="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center border border-slate-100 hover:bg-slate-100 transition-all active:scale-95 text-slate-400 hover:text-blue-500"
    >
        <Map className="w-5 h-5" />
    </button>
));

// 2. Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ° (ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ: ĞšĞ¾Ğ»ÑŒÑ†Ğ¾ + Ğ’Ñ€ĞµĞ¼Ñ)
const TimerVisual = memo(({ 
    progress, elapsedFormatted, totalHours, isFasting 
}: any) => {
    const size = 280;
    const stroke = 8;
    const center = size / 2;
    const radius = (size - stroke) / 2;
    const circumference = 2 * Math.PI * radius;
    const strokeDashoffset = circumference - (progress / 100) * circumference;

    return (
        <div className="flex flex-col items-center justify-center relative z-20 py-10 space-y-8 flex-1">
            <div className="relative shrink-0" style={{ width: size, height: size }}>
                {/* SVG ĞšĞ¾Ğ»ÑŒÑ†Ğ¾ */}
                <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="rotate-[-90deg] drop-shadow-2xl">
                    <circle cx={center} cy={center} r={radius} fill="none" stroke="#F1F5F9" strokeWidth={stroke} strokeLinecap="round" />
                    <circle 
                        cx={center} cy={center} r={radius} fill="none" 
                        stroke="currentColor" strokeWidth={stroke} 
                        strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round"
                        className={cn(
                            "transition-all duration-1000 ease-out", 
                            isFasting ? "text-blue-500" : "text-transparent"
                        )}
                    />
                </svg>

                {/* ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ¾Ğ»ÑŒÑ†Ğ° */}
                <div className="absolute inset-0 flex flex-col items-center justify-center">
                    
                    {/* Ğ’Ñ€ĞµĞ¼Ñ */}
                    <div className="flex items-baseline text-slate-800 translate-y-[-5px]">
                        <span className="text-[4.5rem] font-[850] font-mono tracking-tighter tabular-nums leading-none">
                            {isFasting ? elapsedFormatted.split(':')[0] : `${totalHours}`}
                            <span className="mx-1 opacity-20 relative -top-1">:</span>
                            {isFasting ? elapsedFormatted.split(':')[1] : `00`}
                        </span>
                    </div>
                    
                    {/* ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ */}
                    <span className="text-xs font-bold text-slate-400 uppercase tracking-[0.2em]">
                        {isFasting ? elapsedFormatted.split(':')[2] : 'Ğ§Ğ°ÑĞ¾Ğ²'}
                    </span>
                </div>
            </div>
        </div>
    );
});

export const FastingPage = () => {
  const { 
    isFasting, scheme, setSchemeId, progress, elapsedFormatted, 
    toggleFasting, startTime, setStartTime 
  } = useFastingTimerContext();

  const [isSelecting, setIsSelecting] = useState(false);
  const [isReadyToStart, setIsReadyToStart] = useState(false);
  const [showStartSuccess, setShowStartSuccess] = useState(false);
  
  const navigate = useNavigate();
  const buttonRef = useRef<HTMLDivElement>(null);

  // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
  useEffect(() => {
    if (isFasting) {
        setIsReadyToStart(true);
    }
  }, [isFasting]);

  // Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° (Ğ²Ğ½Ğ¸Ğ·Ñƒ ÑĞºÑ€Ğ°Ğ½Ğ°)
  const handleMainButtonClick = () => {
    if (isFasting) {
      // ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
      toggleFasting();
      setIsReadyToStart(false);
    } else if (isReadyToStart) {
      // Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ (ĞµÑĞ»Ğ¸ ÑÑ…ĞµĞ¼Ğ° ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ°)
      toggleFasting();
      setShowStartSuccess(true);
    } else {
      // ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ğ¾Ñ€ ÑÑ…ĞµĞ¼Ñ‹
      setIsSelecting(true);
    }
  };

  // Ğ¥ĞµĞ½Ğ´Ğ»ĞµÑ€ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¸Ğ· Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ¸
  const handleSelectScheme = (id: string) => {
    setSchemeId(id);       
    setIsSelecting(false); 
    
    // Ğ•ÑĞ»Ğ¸ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ ĞĞ• Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ â€” Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
    if (!isFasting) {
        toggleFasting();
        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ĞºĞ½Ğ¾ ÑƒÑĞ¿ĞµÑ…Ğ° Ñ Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
        setTimeout(() => setShowStartSuccess(true), 300);
    }
    
    setIsReadyToStart(true);
  };

  const currentStart = startTime || dayjs().toISOString();
  const currentEnd = dayjs(currentStart).add(scheme.hours, 'hour').toISOString();
  
  const handleChangeStart = (v: string) => setStartTime(v);
  const handleChangeEnd = (v: string) => {
    const newStart = dayjs(v).subtract(scheme.hours, 'hour').toISOString();
    setStartTime(newStart);
  };

  return (
    <>
        {/* ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»Ğ° */}
        {isSelecting && (
            <ProtocolSelector 
                onSelect={handleSelectScheme} 
                onClose={() => setIsSelecting(false)} 
                currentSchemeId={scheme.id}
            />
        )}

        {/* ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ ÑƒÑĞ¿ĞµÑ…Ğ° ÑÑ‚Ğ°Ñ€Ñ‚Ğ° */}
        <FastingStartModal 
            isOpen={showStartSuccess} 
            onClose={() => setShowStartSuccess(false)} 
        />

        <div className="min-h-full flex flex-col pb-6 relative z-0">
        
        <div className="bg-white rounded-[3rem] shadow-sm shadow-slate-200/50 flex-1 border border-white/60 relative flex flex-col">
            
            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')] opacity-[0.03] pointer-events-none rounded-[3rem]" />

            {/* HEADER */}
            <div className="px-8 pt-8 flex justify-between items-start relative z-20 shrink-0">
                <div>
                    <div className="flex items-center gap-2 mb-2">
                        <div className={cn("w-2 h-2 rounded-full", isFasting ? "bg-blue-500 animate-pulse" : "bg-slate-300")} />
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            {isFasting ? "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ" : "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ"}
                        </span>
                    </div>
                    <h1 className="text-3xl font-[900] text-slate-800 leading-tight">
                        {isFasting ? "Ğ“Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ" : "ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ"}
                    </h1>
                </div>
                <MapButton onClick={() => navigate('/')} />
            </div>

            {/* CONTENT */}
            <TimerVisual 
                progress={progress} 
                elapsedFormatted={elapsedFormatted}
                totalHours={scheme.hours}
                isFasting={isFasting}
            />

            <div className="flex justify-center gap-6 shrink-0 mt-2 mb-4 relative z-20">
                <NativeDatePicker label="ĞĞ°Ñ‡Ğ°Ğ»Ğ¾" icon={Sunrise} dateValue={currentStart} onChange={handleChangeStart} disabled={!isFasting} />
                <div className="w-px bg-slate-100 h-10 self-center" />
                <NativeDatePicker label="Ğ¤Ğ¸Ğ½Ğ¸Ñˆ" icon={Moon} dateValue={currentEnd} onChange={handleChangeEnd} disabled={!isFasting} />
            </div>

            {/* BUTTON */}
            <div ref={buttonRef} className="p-6 mt-auto shrink-0 bg-white/50 backdrop-blur-sm z-20 rounded-b-[3rem]">
                <motion.button 
                    whileTap={{ scale: 0.98 }}
                    onClick={handleMainButtonClick}
                    className={cn(
                        "w-full py-4 rounded-2xl flex items-center justify-between px-6 shadow-lg transition-all group relative overflow-hidden",
                        isFasting 
                            ? "bg-white border-2 border-red-100 text-red-500 hover:bg-red-50" 
                            : isReadyToStart 
                                ? "bg-slate-900 text-white shadow-slate-900/30" 
                                : "bg-white border border-slate-200 text-slate-600 hover:bg-slate-50"
                    )}
                >
                    <div className="flex flex-col items-start z-10">
                        <span className="text-[9px] font-bold uppercase tracking-wider opacity-60">
                            {isFasting ? "Ğ£Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ..." : isReadyToStart ? "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾" : "Ğ¨Ğ°Ğ³ 1"}
                        </span>
                        <span className="font-bold text-sm tracking-wide">
                            {isFasting ? "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ñ†Ğ¸ĞºĞ»" : isReadyToStart ? `ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ` : "Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»"}
                        </span>
                    </div>

                    <div className={cn(
                        "w-10 h-10 rounded-full flex items-center justify-center transition-colors z-10",
                        isFasting ? "bg-red-50" : isReadyToStart ? "bg-white/20" : "bg-slate-100 text-slate-400"
                    )}>
                        {isFasting ? <Square className="w-4 h-4 fill-current" /> : isReadyToStart ? <Play className="w-4 h-4 fill-current ml-0.5" /> : <ListFilter className="w-4 h-4" />}
                    </div>
                </motion.button>
            </div>

        </div>
        </div>
    </>
  );
};

====================
END FILE: src/features/fasting/FastingPage.tsx
====================

====================
START FILE: src/features/fasting/MetabolismMapPage.tsx
====================
import { useState, useEffect, useMemo } from 'react';
import { useFastingTimerContext } from './context/TimerContext';
import { FASTING_PHASES } from './data/stages';
import type { FastingStage } from './data/stages';
import { cn } from '../../utils/cn';
import { Check, Lock, Navigation, Sparkles } from 'lucide-react';
import { motion } from 'framer-motion';
import { PhaseSheet } from './components/PhaseSheet';
import { AnabolicState } from './components/AnabolicState';

const getZoneColor = (hours: number) => {
  if (hours < 12) return "text-orange-500";
  if (hours < 24) return "text-blue-500";
  if (hours < 72) return "text-violet-500";
  return "text-emerald-500";
};

export const MetabolismMapPage = () => {
  const { isFasting, elapsed, phaseToOpen, setPhaseToOpen } = useFastingTimerContext();
  const elapsedHours = elapsed / 3600;

  const [selectedPhase, setSelectedPhase] = useState<FastingStage | null>(null);

  // ğŸ‘‡ Ğ£Ğ‘Ğ ĞĞ› Ğ’Ğ¡Ğ® Ğ›ĞĞ“Ğ˜ĞšĞ£ ĞĞ’Ğ¢Ğ-Ğ¡ĞšĞ ĞĞ›Ğ›Ğ (activeRef, useEffect Ñ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğ¾Ğ¼)
  // Ğ­Ñ‚Ğ¾ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ ÑƒĞ±ĞµÑ€ĞµÑ‚ "Ğ´ĞµÑ€Ğ³Ğ°Ğ½Ğ¸Ğµ"

  // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ (Deep Link) - Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ÑˆÑ‚Ğ¾Ñ€ĞºĞ¸
  useEffect(() => {
      if (phaseToOpen !== null) {
          const targetPhase = FASTING_PHASES.find(p => p.id === phaseToOpen);
          if (targetPhase) {
              setSelectedPhase(targetPhase);
          }
          // Ğ¡Ğ±Ñ€Ğ¾Ñ Ñ„Ğ»Ğ°Ğ³Ğ°
          setPhaseToOpen(null);
      }
  }, [phaseToOpen, setPhaseToOpen]);

  const { activeIndex, phaseProgress } = useMemo(() => {
    let activeIndex = 0;
    let phaseProgress = 0;

    for (let i = 0; i < FASTING_PHASES.length; i++) {
      const phase = FASTING_PHASES[i];
      const nextPhase = FASTING_PHASES[i + 1];
      if (elapsedHours >= phase.hoursStart) {
        activeIndex = i;
        if (nextPhase) {
          const duration = nextPhase.hoursStart - phase.hoursStart;
          const passedInPhase = elapsedHours - phase.hoursStart;
          phaseProgress = Math.min((passedInPhase / duration) * 100, 100);
        } else {
          phaseProgress = 100;
        }
      }
    }
    return { activeIndex, phaseProgress };
  }, [elapsedHours]);

  const accentColor = getZoneColor(elapsedHours);

  if (!isFasting) return <AnabolicState />;

  return (
    <>
      <div className="min-h-full flex flex-col pb-6 relative z-0">
        
        <div className="bg-white rounded-[3rem] shadow-sm shadow-slate-200/50 relative flex-1 flex flex-col z-10 border border-white/60">
          
          <div className="px-8 pt-8 pb-6 flex justify-between items-start shrink-0 relative z-20 bg-white border-b border-gray-50 rounded-t-[3rem]">
              <div>
                  <div className="flex items-center gap-2 mb-2">
                      <Navigation className={cn("w-3 h-3", accentColor)} />
                      <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                          ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚
                      </span>
                  </div>
                  <div className="flex items-baseline gap-2">
                      <h1 className="text-3xl font-[900] text-slate-800 leading-none">
                      {Math.floor(elapsedHours)}
                      </h1>
                      <span className="text-sm font-bold text-slate-400">Ñ‡Ğ°ÑĞ¾Ğ²</span>
                  </div>
              </div>
              
              <div className="px-3 py-1.5 bg-slate-50 rounded-xl border border-slate-100 flex items-center gap-2">
                  <div className={cn("w-2 h-2 rounded-full bg-current", accentColor)} />
                  <span className="text-[10px] font-bold text-slate-600 uppercase tracking-wide">
                      {elapsedHours < 12 ? "ĞŸĞ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ" : elapsedHours < 24 ? "ĞšĞµÑ‚Ğ¾Ğ·" : "ĞÑƒÑ‚Ğ¾Ñ„Ğ°Ğ³Ğ¸Ñ"}
                  </span>
              </div>
          </div>

          <div className="px-4 py-6 relative z-10">
              <div className="absolute left-[35px] top-6 bottom-6 w-0.5 bg-slate-100 rounded-full" />

              {FASTING_PHASES.map((phase, index) => {
              const isActive = index === activeIndex;
              const isPassed = index < activeIndex;
              const isFuture = index > activeIndex;
              const iconColor = phase.color.replace(/bg-[\w-]+\s*/, '');

              return (
                  <div 
                      key={index} 
                      className={cn("relative z-10 flex gap-4 transition-all duration-500", isActive ? "mb-8 mt-2" : "mb-4")}
                  >
                  
                  <div className="flex flex-col items-center shrink-0 w-12 pt-2">
                      {isActive && (
                          <div className="absolute top-0 bottom-0 left-[23px] w-0.5 bg-slate-100 -z-10">
                              <motion.div 
                                  initial={{ height: 0 }}
                                  animate={{ height: `${phaseProgress}%` }}
                                  transition={{ duration: 1 }}
                                  className="w-full bg-blue-500"
                              />
                          </div>
                      )}

                      <div 
                          onClick={() => setSelectedPhase(phase)}
                          className={cn(
                              "w-10 h-10 rounded-full flex items-center justify-center transition-all duration-500 cursor-pointer border-[3px] z-20 bg-white",
                              isActive 
                                  ? "border-blue-500 scale-110 shadow-lg shadow-blue-500/20" 
                                  : isPassed 
                                      ? "border-slate-200 text-slate-300 scale-90" 
                                      : "border-slate-100 text-slate-200 scale-75"
                          )}
                      >
                          {isPassed ? <Check className="w-4 h-4" /> :
                          isActive ? <phase.icon className={cn("w-5 h-5", iconColor)} /> :
                          <span className="text-[10px] font-bold font-mono">{index + 1}</span>
                          }
                      </div>
                  </div>

                  <div className="flex-1 min-w-0">
                      {isActive && (
                          <motion.div 
                              initial={{ opacity: 0, x: 10 }}
                              animate={{ opacity: 1, x: 0 }}
                              onClick={() => setSelectedPhase(phase)}
                              className="bg-slate-50 rounded-[1.5rem] p-5 border border-slate-200 cursor-pointer active:scale-[0.98] transition-transform relative overflow-hidden"
                          >
                              <div className="flex justify-between items-start mb-2 relative z-10">
                                  <span className="text-[9px] font-bold text-blue-500 bg-white border border-blue-100 px-2 py-1 rounded-lg uppercase tracking-wide">
                                      Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ
                                  </span>
                                  <span className="text-xs font-mono font-bold text-slate-400">{Math.round(phaseProgress)}%</span>
                              </div>
                              
                              <h3 className="text-lg font-black text-slate-800 leading-tight mb-1 relative z-10">
                                  {phase.title}
                              </h3>
                              <p className="text-xs text-slate-500 line-clamp-2 leading-relaxed relative z-10">
                                  {phase.subtitle}
                              </p>

                              <div className="h-1.5 w-full bg-slate-200 rounded-full mt-4 overflow-hidden relative z-10">
                                  <motion.div 
                                      initial={{ width: 0 }}
                                      animate={{ width: `${phaseProgress}%` }}
                                      transition={{ duration: 1, delay: 0.2 }}
                                      className="h-full bg-blue-500 rounded-full"
                                  />
                              </div>
                          </motion.div>
                      )}

                      {isPassed && (
                          <div 
                              onClick={() => setSelectedPhase(phase)}
                              className="py-3 px-4 rounded-2xl transition-all cursor-pointer flex items-center justify-between group hover:bg-slate-50"
                          >
                              <span className="text-sm font-bold text-slate-400 group-hover:text-slate-600 transition-colors line-through decoration-slate-300">
                                  {phase.title}
                              </span>
                          </div>
                      )}

                      {isFuture && (
                          <div 
                              onClick={() => setSelectedPhase(phase)}
                              className="py-3 px-4 rounded-2xl border border-dashed border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition-all cursor-pointer flex items-center justify-between group mt-1"
                          >
                              <div>
                                  <span className="text-sm font-bold text-slate-400 group-hover:text-slate-600 transition-colors">
                                      {phase.title}
                                  </span>
                                  <div className="text-[10px] text-slate-300 font-mono mt-0.5">
                                      +{Math.max(0, Math.floor(phase.hoursStart - elapsedHours))}Ñ‡
                                  </div>
                              </div>
                              <Lock className="w-3 h-3 text-slate-200" />
                          </div>
                      )}

                  </div>
                  </div>
              );
              })}
              
              <div className="ml-[28px] mt-4 mb-10 pl-8 relative opacity-50 flex items-center gap-2">
                  <Sparkles className="w-4 h-4 text-emerald-500" />
                  <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                      Ğ¤Ğ¸Ğ½Ğ¸Ñˆ
                  </span>
              </div>

          </div>

        </div>

        {selectedPhase && (
            <PhaseSheet 
                phase={selectedPhase} 
                onClose={() => setSelectedPhase(null)} 
            />
        )}

      </div>
    </>
  );
};

====================
END FILE: src/features/fasting/MetabolismMapPage.tsx
====================

====================
START FILE: src/features/fasting/context/TimerContext.tsx
====================
// src/features/fasting/context/TimerContext.tsx
import React, { createContext, useContext, useState, useEffect, useRef, useCallback } from 'react';
import dayjs from 'dayjs';

import { FASTING_SCHEMES } from '../data/schemes';
import type { FastingScheme } from '../data/schemes';
import { FASTING_PHASES } from '../data/stages';

import { 
    storageGet, 
    storageSet, 
    storageRemove, 
    storageGetJSON,
    storageUpdateHistory
} from '../../../utils/storage'; // ğŸ‘ˆ NEW

import type { NotificationSettings, HistoryRecord } from '../../../utils/types';

interface TimerContextType {
    isFasting: boolean;
    scheme: FastingScheme;
    setSchemeId: (id: string) => void;
    progress: number;
    elapsedFormatted: string;
    elapsed: number;
    toggleFasting: () => void;
    startTime: string | null;
    setStartTime: (date: string | null) => void;
    notification: {title: string, message: string, phaseId?: number} | null;
    closeNotification: () => void;
    phaseToOpen: number | null;
    setPhaseToOpen: (id: number | null) => void;
    isLoading: boolean; // ğŸ‘ˆ NEW
}

const TimerContext = createContext<TimerContextType | null>(null);

export const TimerProvider = ({ children }: { children: React.ReactNode }) => {
    // ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ Ğ¸Ğ»Ğ¸ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğµ
    const [schemeId, setSchemeIdState] = useState<string>(FASTING_SCHEMES[0].id);
    const [startTime, setStartTimeState] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(true); // ğŸ‘ˆ Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
    
    const [elapsed, setElapsed] = useState(0);
    const [notification, setNotification] = useState<{title: string, message: string, phaseId?: number} | null>(null);
    const [phaseToOpen, setPhaseToOpen] = useState<number | null>(null);
    
    const lastPhaseIndexRef = useRef<number>(-1);

    const scheme = FASTING_SCHEMES.find((s) => s.id === schemeId) || FASTING_SCHEMES[0];
    const goalSeconds = scheme.hours * 3600;

    // 1. ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    useEffect(() => {
        const init = async () => {
            try {
                // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑÑ…ĞµĞ¼Ñƒ
                const savedSchemeId = await storageGet('fasting_scheme');
                if (savedSchemeId && FASTING_SCHEMES.find(s => s.id === savedSchemeId)) {
                    setSchemeIdState(savedSchemeId);
                }

                // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ ÑÑ‚Ğ°Ñ€Ñ‚Ğ°
                const savedStart = await storageGet('fasting_startTime');
                if (savedStart) {
                    setStartTimeState(savedStart);
                    
                    // Ğ¡Ñ€Ğ°Ğ·Ñƒ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ°Ğ·Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¶Ğ´Ğ°Ñ‚ÑŒ useEffect Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ°
                    const now = dayjs();
                    const diff = now.diff(dayjs(savedStart), 'second');
                    setElapsed(diff >= 0 ? diff : 0);
                    
                    const currentHours = now.diff(dayjs(savedStart), 'hour');
                    lastPhaseIndexRef.current = FASTING_PHASES.findIndex((p) => currentHours >= p.hoursStart);
                }
            } catch (e) {
                console.error("Timer init error:", e);
            } finally {
                setIsLoading(false);
            }
        };

        init();
    }, []);

    // 2. Ğ¡ĞµÑ‚Ñ‚ĞµÑ€ ÑÑ…ĞµĞ¼Ñ‹
    const setSchemeId = useCallback((id: string) => {
        setSchemeIdState(id);
        storageSet('fasting_scheme', id); // fire & forget
    }, []);

    // 3. Ğ¡ĞµÑ‚Ñ‚ĞµÑ€ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
    const setStartTime = useCallback((date: string | null) => {
        setStartTimeState(date);
        if (date) {
            storageSet('fasting_startTime', date);
            const now = dayjs();
            const diff = now.diff(dayjs(date), 'second');
            setElapsed(diff >= 0 ? diff : 0);
            
            const currentHours = now.diff(dayjs(date), 'hour');
            lastPhaseIndexRef.current = FASTING_PHASES.findIndex((p) => currentHours >= p.hoursStart);
        } else {
            storageRemove('fasting_startTime');
            setElapsed(0);
            lastPhaseIndexRef.current = -1;
        }
    }, []);

    // 4. Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€
    useEffect(() => {
        if (!startTime) {
            setElapsed(0);
            return;
        }
        
        const update = () => {
            const start = dayjs(startTime);
            const now = dayjs();
            const diff = now.diff(start, 'second');
            const safeDiff = diff >= 0 ? diff : 0;
            setElapsed(safeDiff);

            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ğ°Ğ·
            if (safeDiff % 60 === 0) {
                const currentHours = safeDiff / 3600;
                const newPhaseIndex = FASTING_PHASES.findIndex((p) => currentHours >= p.hoursStart && (!p.hoursEnd || currentHours < p.hoursEnd));
                
                if (newPhaseIndex !== -1 && newPhaseIndex !== lastPhaseIndexRef.current) {
                    if (lastPhaseIndexRef.current !== -1) {
                        // ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (Ñ‚ÑƒÑ‚ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¸Ñ, Ğ½Ğ¾ useEffect ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½ĞµĞ½)
                        storageGetJSON<NotificationSettings>('user_settings', { fasting: true }).then(settings => {
                            if (settings.fasting !== false) {
                                const phase = FASTING_PHASES[newPhaseIndex];
                                setNotification({
                                    title: `ĞĞ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ğ¿: ${phase.title}`,
                                    message: phase.subtitle,
                                    phaseId: phase.id
                                });
                                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                            }
                        });
                    }
                    lastPhaseIndexRef.current = newPhaseIndex;
                }
            }
        };

        update();
        const interval = setInterval(update, 1000);
        return () => clearInterval(interval);
    }, [startTime]);

    // 5. ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ (Ğ¡Ñ‚Ğ°Ñ€Ñ‚/Ğ¡Ñ‚Ğ¾Ğ¿)
    const toggleFasting = useCallback(() => {
        if (startTime) {
            // STOP
            const now = dayjs();
            const start = dayjs(startTime);
            const duration = now.diff(start, 'second');
            
            if (duration > 60) {
                const record: HistoryRecord = {
                    id: Date.now().toString(),
                    type: 'fasting',
                    scheme: scheme.title,
                    startTime: startTime,
                    endTime: now.toISOString(),
                    durationSeconds: duration
                };
                storageUpdateHistory('history_fasting', record);
            }
            setStartTime(null);
        } else {
            // START
            setStartTime(dayjs().toISOString());
            lastPhaseIndexRef.current = 0;
        }
    }, [startTime, scheme.title, setStartTime]);

    const progress = Math.min((elapsed / goalSeconds) * 100, 100);

    const formatTime = (totalSeconds: number) => {
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        const s = totalSeconds % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    };

    return (
        <TimerContext.Provider value={{
            isFasting: !!startTime,
            scheme,
            setSchemeId,
            progress,
            elapsedFormatted: formatTime(elapsed),
            elapsed,
            toggleFasting,
            startTime,
            setStartTime,
            notification,
            closeNotification: () => setNotification(null),
            phaseToOpen,
            setPhaseToOpen,
            isLoading // Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
        }}>
            {children}
        </TimerContext.Provider>
    );
};

export const useFastingTimerContext = () => {
    const context = useContext(TimerContext);
    if (!context) {
        throw new Error('useFastingTimerContext must be used within a TimerProvider');
    }
    return context;
};

====================
END FILE: src/features/fasting/context/TimerContext.tsx
====================

====================
START FILE: src/features/fasting/components/ProtocolDetails.tsx
====================
import { useState } from 'react';
import { motion } from 'framer-motion';
import { ChevronLeft, Play, Clock, Activity, ChevronDown, Zap, PartyPopper } from 'lucide-react';
import { FASTING_SCHEMES } from '../data/schemes';
import { FASTING_PHASES } from '../data/stages';
import { cn } from '../../../utils/cn';

interface Props {
  schemeId: string;
  onBack: () => void;
  onStart: () => void;
}

export const ProtocolDetails = ({ schemeId, onBack, onStart }: Props) => {
  const scheme = FASTING_SCHEMES.find(s => s.id === schemeId);
  const [expandedPhaseId, setExpandedPhaseId] = useState<number | null>(null);

  if (!scheme) return null;

  const relevantPhases = FASTING_PHASES.filter(p => p.hoursStart < scheme.hours);

  const togglePhase = (id: number) => {
      setExpandedPhaseId(current => current === id ? null : id);
  };

  const colorName = scheme.color.split('-')[1];

  return (
    <motion.div 
        initial={{ opacity: 0, x: 20 }}
        animate={{ opacity: 1, x: 0 }}
        exit={{ opacity: 0, x: 20 }}
        transition={{ duration: 0.3, ease: "easeOut" }}
        className="flex flex-col h-full bg-[#F2F2F7] relative"
    >
        {/* Ğ¥ĞµĞ´ĞµÑ€ */}
        <div className="px-6 pt-4 pb-2 flex items-center gap-4 shrink-0 bg-[#F2F2F7] z-20">
            <button 
                onClick={onBack}
                className="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-100 text-slate-500 active:scale-95 transition-transform"
            >
                <ChevronLeft className="w-6 h-6 ml-[-2px]" />
            </button>
            <span className="text-sm font-bold text-slate-400 uppercase tracking-widest">
                ĞĞ±Ğ·Ğ¾Ñ€
            </span>
        </div>

        {/* ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ */}
        <div className="flex-1 overflow-y-auto px-6 pb-10 scrollbar-hide"> {/* Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½ padding-bottom */}
            
            {/* HERO */}
            <div className="flex flex-col items-center text-center mt-6 mb-10">
                <div className={cn(
                    "w-20 h-20 rounded-3xl flex items-center justify-center mb-6 shadow-xl bg-white",
                    `shadow-${colorName}-200`
                )}>
                    <scheme.icon className={cn("w-10 h-10", scheme.color)} />
                </div>
                
                <h2 className="text-3xl font-[900] text-slate-800 leading-tight mb-2">
                    {scheme.title.split(':')[0]}
                </h2>
                <p className="text-base font-medium text-slate-500 max-w-[250px]">
                    {scheme.title.split(':')[1]?.trim() || scheme.title}
                </p>

                {/* Info Badges */}
                <div className="flex gap-2 mt-6">
                    <div className="bg-white px-3 py-1.5 rounded-xl border border-slate-100 flex items-center gap-2 shadow-sm">
                        <Clock className="w-3.5 h-3.5 text-slate-400" />
                        <span className="text-xs font-bold text-slate-600">~{Math.round(scheme.hours / 24 * 10) / 10} Ğ´Ğ½.</span>
                    </div>
                    <div className="bg-white px-3 py-1.5 rounded-xl border border-slate-100 flex items-center gap-2 shadow-sm">
                        <Activity className="w-3.5 h-3.5 text-slate-400" />
                        <span className="text-xs font-bold text-slate-600">{relevantPhases.length} ÑÑ‚Ğ°Ğ¿Ğ¾Ğ²</span>
                    </div>
                </div>
            </div>

            {/* TIMELINE */}
            <div className="relative">
                <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 pl-2">
                    ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚
                </h4>
                
                <div className="relative pl-4 space-y-4">
                    {/* Ğ›Ğ¸Ğ½Ğ¸Ñ (Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ·Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‡ÑƒÑ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ñ„Ğ¸Ğ½Ğ¸ÑˆĞ°) */}
                    <div className="absolute left-[23px] top-2 bottom-8 w-[2px] bg-slate-200 rounded-full" />

                    {relevantPhases.map((phase) => {
                        const isExpanded = expandedPhaseId === phase.id;
                        const iconColorClass = phase.color.replace('bg-', 'text-').replace('100', '500');

                        return (
                            <div key={phase.id} className="relative z-10 flex gap-5">
                                {/* ĞœĞ°Ñ€ĞºĞµÑ€ */}
                                <div className={cn(
                                    "w-5 h-5 rounded-full border-[3px] shadow-sm flex items-center justify-center shrink-0 z-20 mt-4 transition-colors bg-white",
                                    isExpanded ? "border-slate-800" : "border-slate-200"
                                )}>
                                    {isExpanded && <div className="w-1.5 h-1.5 bg-slate-800 rounded-full" />}
                                </div>
                                
                                {/* ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° */}
                                <div 
                                    onClick={() => togglePhase(phase.id)}
                                    className={cn(
                                        "flex-1 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden transition-all active:scale-[0.99] cursor-pointer group",
                                        isExpanded ? "ring-1 ring-slate-800 border-slate-800" : "hover:border-slate-300"
                                    )}
                                >
                                    <div className="p-4 flex items-center gap-4">
                                        <div className={cn(
                                            "w-10 h-10 rounded-xl flex items-center justify-center shrink-0 transition-colors",
                                            isExpanded ? "bg-slate-100" : "bg-slate-50 group-hover:bg-slate-100"
                                        )}>
                                            <phase.icon className={cn("w-5 h-5", iconColorClass)} />
                                        </div>

                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center justify-between mb-0.5">
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wide">
                                                    {phase.hoursStart}Ñ‡+
                                                </span>
                                                <ChevronDown className={cn("w-4 h-4 text-slate-300 transition-transform", isExpanded && "rotate-180")} />
                                            </div>
                                            <h5 className="font-bold text-sm text-slate-800 truncate">
                                                {phase.title}
                                            </h5>
                                        </div>
                                    </div>

                                    {isExpanded && (
                                        <div className="px-4 pb-4 pt-0 animate-in fade-in slide-in-from-top-1 duration-200">
                                            <div className="border-t border-slate-50 pt-3 space-y-3">
                                                <p className="text-xs text-slate-500 leading-relaxed">
                                                    {phase.subtitle}
                                                </p>
                                                
                                                <div className="bg-blue-50/50 p-3 rounded-xl border border-blue-50/50 flex gap-3">
                                                    <div className="mt-0.5 p-1 bg-blue-100 rounded text-blue-600 shrink-0 h-fit">
                                                        <Zap className="w-3 h-3" />
                                                    </div>
                                                    <div>
                                                        <h6 className="text-[10px] font-bold text-blue-500 uppercase mb-0.5">Ğ¤Ğ¸Ğ·Ğ¸Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ</h6>
                                                        <p className="text-[11px] text-slate-600 leading-relaxed">
                                                            {phase.details.physiology}
                                                        </p>
                                                    </div>
                                                </div>

                                                <div>
                                                    <h6 className="text-[10px] font-bold text-slate-400 uppercase mb-1.5">ĞÑ‰ÑƒÑ‰ĞµĞ½Ğ¸Ñ</h6>
                                                    <ul className="space-y-1">
                                                        {phase.details.sensations.map((s, i) => (
                                                            <li key={i} className="text-[11px] text-slate-500 flex gap-2 items-baseline">
                                                                <span className="w-1 h-1 rounded-full bg-slate-300 shrink-0" />
                                                                {s}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                    
                    {/* Ğ¤Ğ¸Ğ½Ğ¸Ñˆ Ñ ĞºĞ¾Ğ½Ñ„ĞµÑ‚Ñ‚Ğ¸ (Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾) */}
                    <div className="relative z-10 flex gap-5 pt-4 pb-6">
                        {/* Ğ‘ĞµĞ»Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ»Ğ¾Ğ¶ĞºĞ° z-20 Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚ÑŒ Ğ»Ğ¸Ğ½Ğ¸Ñ */}
                        <div className="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center shrink-0 border-[3px] border-white shadow-sm z-20 animate-pulse">
                            <PartyPopper className="w-3 h-3 text-emerald-600" />
                        </div>
                        <div className="pt-0.5 opacity-60">
                            <span className="text-xs font-bold text-emerald-600 uppercase tracking-wide">
                                Ğ¦ĞµĞ»ÑŒ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚Ğ°
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‚Ğ° (Ğ¡ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ğ¾Ğ¼) */}
            <div className="mt-8 mb-8"> {/* Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ°Ñ€Ğ´Ğ¶Ğ¸Ğ½ */}
                <button 
                    onClick={onStart}
                    className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-lg shadow-slate-900/10 flex items-center justify-center gap-2 active:scale-95 transition-transform"
                >
                    <span>ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ</span>
                    <Play className="w-4 h-4 fill-current" />
                </button>
            </div>

        </div>
    </motion.div>
  );
};

====================
END FILE: src/features/fasting/components/ProtocolDetails.tsx
====================

====================
START FILE: src/features/fasting/components/SovietProtocolSheet.tsx
====================
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, BookOpen, Droplets, Feather, ShieldCheck, Scroll } from 'lucide-react';

interface Props {
  isOpen: boolean;
  onClose: () => void;
}

export const SovietProtocolSheet = ({ isOpen, onClose }: Props) => {
  const content = (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/30 backdrop-blur-sm z-[100]"
          />

          {/* Sheet */}
          <motion.div
            initial={{ y: "100%" }}
            animate={{ y: 0 }}
            exit={{ y: "100%" }}
            transition={{ type: "spring", damping: 25, stiffness: 300 }}
            className="fixed bottom-0 left-0 right-0 z-[101] bg-[#F2F2F7] rounded-t-[2.5rem] h-[90vh] shadow-2xl flex flex-col overflow-hidden max-w-md mx-auto"
          >
            {/* Handle */}
            <div className="w-full flex justify-center pt-3 pb-2 bg-[#F2F2F7] shrink-0" onClick={onClose}>
              <div className="w-12 h-1.5 bg-gray-300 rounded-full" />
            </div>

            {/* Close Button */}
            <button 
                onClick={onClose}
                className="absolute top-4 right-4 p-2 bg-gray-200/50 hover:bg-gray-200 rounded-full transition-colors z-50"
            >
                <X className="w-5 h-5 text-gray-500" />
            </button>

            {/* Content */}
            <div className="flex-1 overflow-y-auto pb-safe px-4 pt-2">
              
              {/* HEADER */}
              <div className="text-center mb-8 px-4 pt-4">
                <div className="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm border border-red-100 rotate-3">
                    <BookOpen className="w-8 h-8 text-red-600" />
                </div>
                <h2 className="text-2xl font-[900] text-slate-800 leading-tight">
                    ĞœĞµÑ‚Ğ¾Ğ´ Ğ Ğ”Ğ¢
                </h2>
                <p className="text-xs font-bold text-slate-400 mt-1 uppercase tracking-widest">
                    ĞŸĞ¾ Ğ®.Ğ¡. ĞĞ¸ĞºĞ¾Ğ»Ğ°ĞµĞ²Ñƒ
                </p>
              </div>

              <div className="space-y-4 pb-10">
                
                {/* Ğ¦Ğ¸Ñ‚Ğ°Ñ‚Ğ° */}
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-1 h-full bg-red-500" />
                    <Scroll className="w-12 h-12 text-slate-100 absolute -right-2 -bottom-2 rotate-[-15deg]" />
                    <p className="text-sm font-serif italic text-slate-600 leading-relaxed relative z-10">
                        Â«Ğ“Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ â€” ÑÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¿Ğ¸Ñ‰Ğ¸. Ğ­Ñ‚Ğ¾ ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ğ±Ğ¸Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ±ĞµĞ· Ğ½Ğ¾Ğ¶Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€ÑƒÑ Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ ÑĞ°Ğ¼Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾Ğ´Ğ°.Â»
                    </p>
                </div>

                {/* 1. ĞŸĞ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾ */}
                <div className="bg-white rounded-2xl p-5 shadow-sm">
                    <div className="flex items-center gap-3 mb-3 border-b border-gray-100 pb-2">
                        <div className="p-1.5 bg-green-50 rounded-lg text-green-600">
                            <Feather className="w-4 h-4" />
                        </div>
                        <h3 className="font-bold text-slate-800">Ğ’Ñ…Ğ¾Ğ´ Ğ² Ğ³Ğ¾Ğ»Ğ¾Ğ´</h3>
                    </div>
                    <ul className="space-y-3">
                        <li className="flex gap-3 text-sm text-slate-600">
                            <span className="text-green-500 font-bold">â€¢</span>
                            <span>
                                <strong>Ğ—Ğ° 3 Ğ´Ğ½Ñ:</strong> Ğ˜ÑĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ğµ Ğ±ĞµĞ»ĞºĞ¸ (Ğ¼ÑÑĞ¾, ÑĞ¹Ñ†Ğ°, Ğ¼Ğ¾Ğ»Ğ¾Ñ‡Ğ½Ğ¾Ğµ). ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ½Ğ° Ñ€Ğ°ÑÑ‚Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾-Ğ¼Ğ¾Ğ»Ğ¾Ñ‡Ğ½ÑƒÑ Ğ´Ğ¸ĞµÑ‚Ñƒ.
                            </span>
                        </li>
                        <li className="flex gap-3 text-sm text-slate-600">
                            <span className="text-green-500 font-bold">â€¢</span>
                            <span>
                                <strong>ĞĞ°ĞºĞ°Ğ½ÑƒĞ½Ğµ:</strong> Ğ›ĞµĞ³ĞºĞ¸Ğ¹ ÑƒĞ¶Ğ¸Ğ½. ĞšĞ°ÑˆĞ¸ Ğ½Ğ° Ğ²Ğ¾Ğ´Ğµ, Ñ‚ÑƒÑˆĞµĞ½Ñ‹Ğµ Ğ¾Ğ²Ğ¾Ñ‰Ğ¸ Ğ¸Ğ»Ğ¸ ĞºĞµÑ„Ğ¸Ñ€.
                            </span>
                        </li>
                    </ul>
                </div>

                {/* 2. ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ¸Ğµ (Ğ¡Ğ¿Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚, Ğ½Ğ¾ Ğ¿Ğ¾ ĞºĞ½Ğ¸Ğ³Ğµ) */}
                <div className="bg-blue-50 rounded-2xl p-5 border border-blue-100">
                    <div className="flex items-center gap-3 mb-3 border-b border-blue-100 pb-2">
                        <div className="p-1.5 bg-white rounded-lg text-blue-600 shadow-sm">
                            <Droplets className="w-4 h-4" />
                        </div>
                        <h3 className="font-bold text-blue-900">ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ¸Ğµ (ĞœĞ°Ğ³Ğ½ĞµĞ·Ğ¸Ñ)</h3>
                    </div>
                    <p className="text-sm text-blue-800 leading-relaxed mb-2">
                        Ğ¡Ğ¾Ğ²ĞµÑ‚ÑĞºĞ°Ñ ÑˆĞºĞ¾Ğ»Ğ° Ğ½Ğ°ÑÑ‚Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° Ğ¿Ñ€Ğ¸ĞµĞ¼Ğµ ÑĞ¾Ğ»ĞµĞ²Ğ¾Ğ³Ğ¾ ÑĞ»Ğ°Ğ±Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ (ÑÑƒĞ»ÑŒÑ„Ğ°Ñ‚ Ğ¼Ğ°Ğ³Ğ½Ğ¸Ñ) Ğ¿ĞµÑ€ĞµĞ´ ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ¼.
                    </p>
                    <div className="bg-white/60 p-3 rounded-xl text-xs text-blue-700 font-medium">
                        Ğ­Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Â«Ğ²Ñ‹ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚Â» Ğ¿Ğ¸Ñ‰ĞµĞ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ñ€Ğ°ĞºÑ‚ Ğ¸ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ° Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ´Ğ½Ğ¸.
                    </div>
                </div>

                {/* 3. ĞŸÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ */}
                <div className="bg-white rounded-2xl p-5 shadow-sm">
                    <div className="flex items-center gap-3 mb-3 border-b border-gray-100 pb-2">
                        <div className="p-1.5 bg-slate-50 rounded-lg text-slate-600">
                            <ShieldCheck className="w-4 h-4" />
                        </div>
                        <h3 className="font-bold text-slate-800">ĞŸÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹</h3>
                    </div>
                    <p className="text-sm text-slate-600 leading-relaxed">
                        ĞĞ¸ĞºĞ¾Ğ»Ğ°ĞµĞ² Ğ¿Ğ¾Ğ´Ñ‡ĞµÑ€ĞºĞ¸Ğ²Ğ°Ğ»: Ğ²Ñ‹ Ğ½Ğµ Â«Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°ĞµÑ‚ĞµÂ» (ÑÑ‚Ñ€Ğ°Ğ´Ğ°ĞµÑ‚Ğµ), Ğ²Ñ‹ Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚Ğµ <strong>Ğ»ĞµÑ‡ĞµĞ±Ğ½ÑƒÑ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ñƒ</strong>. Ğ’Ğ¾ÑĞ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ¹Ñ‚Ğµ ÑÑ‚Ğ¾ ĞºĞ°Ğº Ğ¾Ñ‚Ğ´Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‚Ñ€ÑƒĞ´Ğ¸Ğ»Ğ¸ÑÑŒ Ğ±ĞµĞ· Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ²ÑÑ Ğ²Ğ°ÑˆÑƒ Ğ¶Ğ¸Ğ·Ğ½ÑŒ.
                    </p>
                </div>

                {/* Footer Note */}
                <div className="text-center px-6">
                    <p className="text-[10px] text-slate-400 font-medium leading-relaxed">
                        ĞÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ½Ğ° ĞºĞ½Ğ¸Ğ³Ğµ Â«Ğ“Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ´Ğ¸ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑÂ» (1988).<br/>
                        ĞœĞµÑ‚Ğ¾Ğ´Ğ¸ĞºĞ° Ñ€Ğ°Ğ·Ğ³Ñ€ÑƒĞ·Ğ¾Ñ‡Ğ½Ğ¾-Ğ´Ğ¸ĞµÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸ (Ğ Ğ”Ğ¢).
                    </p>
                </div>

              </div>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};

====================
END FILE: src/features/fasting/components/SovietProtocolSheet.tsx
====================

====================
START FILE: src/features/fasting/components/AnabolicState.tsx
====================
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ChevronRight, Play, BookOpen, ArrowLeft, CheckCircle2, Circle } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { cn } from '../../../utils/cn';
import { SovietProtocolSheet } from './SovietProtocolSheet';
import { PREP_STEPS } from '../data/preparationSteps';

// --- ART COMPONENTS (Ğ¢Ğµ Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ¸ Ğ±Ñ‹Ğ»Ğ¸, Ğ´Ğ»Ñ Ğ°Ñ‚Ğ¼Ğ¾ÑÑ„ĞµÑ€Ñ‹) ---
// (Ğ¯ ÑĞ¾ĞºÑ€Ğ°Ñ‚Ğ¸Ğ» Ğ¸Ñ… ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸, Ğ²ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°)
const MindArt = () => <div className="absolute inset-0 flex items-center justify-center opacity-60"><motion.div animate={{ rotate: 360 }} transition={{ duration: 40, repeat: Infinity, ease: "linear" }} className="w-56 h-56 border-2 border-dashed border-violet-300 rounded-full" /></div>;
const NatureArt = () => <div className="absolute inset-0 flex items-center justify-center opacity-50"><motion.div animate={{ scale: [1, 1.1, 1] }} transition={{ duration: 5, repeat: Infinity }} className="w-48 h-48 bg-emerald-400/20 rounded-full blur-3xl" /></div>;
const GrainsArt = () => <div className="absolute inset-0 opacity-30"><div className="w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]" /></div>;
const ChemistryArt = () => <div className="absolute inset-0 flex items-center justify-center opacity-40"><div className="grid grid-cols-3 gap-6 rotate-12">{[...Array(9)].map((_, i) => <div key={i} className="w-2 h-2 bg-blue-500 rounded-full" />)}</div></div>;
const WaterArt = () => <div className="absolute inset-0 overflow-hidden opacity-50">{[...Array(5)].map((_, i) => <motion.div key={i} animate={{ y: -100 }} transition={{ duration: 3 + i, repeat: Infinity, ease: "linear" }} className="absolute w-3 h-3 bg-cyan-400/40 rounded-full blur-sm" style={{ top: '100%', left: `${i * 20}%` }} />)}</div>;
const MovementArt = () => <div className="absolute inset-0 flex items-center justify-center opacity-40"><motion.div animate={{ rotate: [0, 10, 0] }} transition={{ duration: 4, repeat: Infinity }} className="w-64 h-2 bg-orange-300/50 rounded-full" /></div>;
const MedicalArt = () => <div className="absolute inset-0 flex items-center justify-center opacity-30"><div className="text-6xl text-rose-300 font-black">+</div></div>;

const getArt = (theme: string) => {
    switch (theme) {
        case 'mind': return <MindArt />;
        case 'nature': case 'grains': return <NatureArt />; // ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸Ğ» Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ñ‹
        case 'chemistry': return <ChemistryArt />;
        case 'water': return <WaterArt />;
        case 'movement': return <MovementArt />;
        case 'medical': return <MedicalArt />;
        default: return <GrainsArt />;
    }
};

// --- ĞšĞĞœĞŸĞĞĞ•ĞĞ¢ ---

export const AnabolicState = () => {
  const navigate = useNavigate();
  const [activeStep, setActiveStep] = useState(0);
  const [showSovietSheet, setShowSovietSheet] = useState(false);
  
  // Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ¾Ğ²: { "stepId-itemIndex": boolean }
  const [checkedItems, setCheckedItems] = useState<Record<string, boolean>>({});

  const step = PREP_STEPS[activeStep];
  const isLastStep = activeStep === PREP_STEPS.length - 1;

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: Ğ²ÑĞµ Ğ»Ğ¸ Ğ¿ÑƒĞ½ĞºÑ‚Ñ‹ Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ ÑˆĞ°Ğ³Ğµ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ñ‹?
  const allChecked = step.checklist.every((_, idx) => checkedItems[`${activeStep}-${idx}`]);

  const toggleCheck = (idx: number) => {
      const key = `${activeStep}-${idx}`;
      const newVal = !checkedItems[key];
      setCheckedItems(prev => ({ ...prev, [key]: newVal }));
      
      // Ğ’Ğ¸Ğ±Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğ¸ (ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ)
      if (newVal && navigator.vibrate) navigator.vibrate(10);
  };

  const handleNext = () => {
    if (isLastStep) {
      navigate('/timer');
    } else {
      setActiveStep(s => s + 1);
    }
  };

  const handlePrev = () => {
    if (activeStep > 0) setActiveStep(s => s - 1);
  };

  return (
    <>
        <SovietProtocolSheet 
            isOpen={showSovietSheet} 
            onClose={() => setShowSovietSheet(false)} 
        />

        <div className="min-h-full flex flex-col pb-6 relative z-0">
        
        <div className="bg-white rounded-[3rem] shadow-sm shadow-slate-200/50 relative flex-1 flex flex-col z-10 border border-white/60 overflow-hidden">
            
            {/* Ğ¥Ğ•Ğ”Ğ•Ğ  (ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ) */}
            <div className="px-8 pt-8 pb-2 shrink-0 z-20">
                <div className="flex justify-between items-center mb-6">
                    <div className="flex gap-1">
                        {PREP_STEPS.map((_, i) => (
                            <motion.div
                                key={i}
                                animate={{ 
                                    width: i === activeStep ? 20 : 6,
                                    height: 6,
                                    backgroundColor: i <= activeStep ? (step.color.includes('violet') ? '#7c3aed' : step.color.includes('emerald') ? '#059669' : '#334155') : '#e2e8f0'
                                }}
                                className="rounded-full"
                            />
                        ))}
                    </div>
                    <button 
                        onClick={() => setShowSovietSheet(true)}
                        className="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-400 hover:text-slate-600 active:scale-95 transition-transform"
                    >
                        <BookOpen className="w-5 h-5" />
                    </button>
                </div>
            </div>

            {/* ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞšĞĞĞ¢Ğ•ĞĞ¢ */}
            <div className="flex-1 overflow-y-auto scrollbar-hide px-6 pb-28">
                <AnimatePresence mode="wait">
                    <motion.div
                        key={step.id}
                        initial={{ opacity: 0, x: 20 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -20 }}
                        transition={{ duration: 0.3, ease: "easeOut" }}
                    >
                        {/* 1. Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ¬ĞĞĞ¯ ĞšĞĞ Ğ¢ĞĞ§ĞšĞ */}
                        <div className="relative w-full aspect-[16/9] rounded-[2rem] overflow-hidden mb-8 shadow-sm border border-slate-100 bg-white">
                            <div className={cn("absolute inset-0 bg-gradient-to-br opacity-40", step.gradient)} />
                            <div className="absolute inset-0">{getArt(step.theme)}</div>
                            
                            <div className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10">
                                <div className="w-16 h-16 bg-white/80 backdrop-blur-md rounded-2xl flex items-center justify-center shadow-lg mb-3">
                                    <step.icon className={cn("w-8 h-8", step.color)} />
                                </div>
                                <h2 className="text-2xl font-[900] text-slate-800 leading-none mb-1">
                                    {step.title}
                                </h2>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">
                                    {step.subtitle}
                                </p>
                            </div>
                        </div>

                        {/* 2. Ğ¦Ğ˜Ğ¢ĞĞ¢Ğ */}
                        <div className="mb-8 relative pl-4 border-l-4 border-slate-200">
                            <p className="text-sm italic font-medium text-slate-500 leading-relaxed">
                                {step.quote}
                            </p>
                        </div>

                        {/* 3. Ğ˜ĞĞ¢Ğ•Ğ ĞĞšĞ¢Ğ˜Ğ’ĞĞ«Ğ™ Ğ§Ğ•Ğš-Ğ›Ğ˜Ğ¡Ğ¢ */}
                        <div className="space-y-3">
                            <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1 mb-2">
                                Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸
                            </h3>
                            {step.checklist.map((item, idx) => {
                                const isChecked = checkedItems[`${activeStep}-${idx}`];
                                return (
                                    <div 
                                        key={idx}
                                        onClick={() => toggleCheck(idx)}
                                        className={cn(
                                            "p-4 rounded-2xl border transition-all duration-200 flex items-center gap-4 cursor-pointer active:scale-[0.98]",
                                            isChecked 
                                                ? "bg-slate-50 border-slate-200" 
                                                : "bg-white border-slate-100 shadow-sm hover:border-blue-200"
                                        )}
                                    >
                                        <div className={cn(
                                            "w-6 h-6 rounded-full flex items-center justify-center shrink-0 transition-colors",
                                            isChecked ? "bg-slate-800 text-white" : "bg-slate-100 text-slate-300"
                                        )}>
                                            {isChecked ? <CheckCircle2 className="w-4 h-4" /> : <Circle className="w-4 h-4" />}
                                        </div>
                                        <span className={cn(
                                            "text-sm font-medium transition-all",
                                            isChecked ? "text-slate-400 line-through" : "text-slate-700"
                                        )}>
                                            {item}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>

                    </motion.div>
                </AnimatePresence>
            </div>

            {/* Ğ¤Ğ£Ğ¢Ğ•Ğ  (ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸) */}
            <div className="absolute bottom-0 left-0 right-0 p-6 pt-8 bg-gradient-to-t from-white via-white/90 to-transparent z-30 flex gap-3">
                {activeStep > 0 && (
                    <button 
                        onClick={handlePrev}
                        className="w-14 h-14 rounded-2xl flex items-center justify-center bg-white border border-slate-200 text-slate-400 active:scale-95 transition-transform shrink-0 shadow-sm"
                    >
                        <ArrowLeft className="w-5 h-5" />
                    </button>
                )}
                
                <button 
                    onClick={handleNext}
                    className={cn(
                        "flex-1 h-14 rounded-2xl flex items-center justify-between px-6 shadow-xl transition-all duration-300 group active:scale-95",
                        // Ğ•ÑĞ»Ğ¸ Ğ²ÑĞµ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ¾ - ĞºĞ½Ğ¾Ğ¿ĞºĞ° ÑÑ€ĞºĞ°Ñ, ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ - Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ°Ñ
                        allChecked 
                            ? "bg-slate-900 text-white shadow-slate-900/20" 
                            : "bg-white text-slate-400 border border-slate-200"
                    )}
                >
                    <span className={cn("font-bold text-sm tracking-wide pl-2", !allChecked && "font-medium")}>
                        {isLastStep ? "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ" : allChecked ? "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ" : "ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"}
                    </span>
                    
                    <div className={cn(
                        "w-8 h-8 rounded-xl flex items-center justify-center transition-colors",
                        allChecked ? "bg-white/20" : "bg-slate-50"
                    )}>
                        {isLastStep ? (
                            <Play className="w-4 h-4 fill-current" />
                        ) : (
                            <ChevronRight className="w-5 h-5" />
                        )}
                    </div>
                </button>
            </div>

        </div>
        </div>
    </>
  );
};

====================
END FILE: src/features/fasting/components/AnabolicState.tsx
====================

====================
START FILE: src/features/fasting/components/TimerRing.tsx
====================
import { cn } from '../../../utils/cn';
import { motion } from 'framer-motion';

interface Props {
  progress: number;
  time: string;
  isFasting: boolean;
  color: string;
  label?: string;
}

export const TimerRing = ({ progress, time, isFasting, label }: Props) => {
  const size = 280;
  const center = size / 2;
  const strokeWidth = 16; // Ğ¡Ğ´ĞµĞ»Ğ°ĞµĞ¼ Ğ»Ğ¸Ğ½Ğ¸Ñ Ñ‡ÑƒÑ‚ÑŒ Ñ‚Ğ¾Ğ»Ñ‰Ğµ Ğ´Ğ»Ñ ÑĞ¾Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸
  const radius = 120;
  
  const circumference = 2 * Math.PI * radius;
  const strokeDashoffset = circumference - (progress / 100) * circumference;

  return (
    <div className="relative flex items-center justify-center">
      
      <div className="relative" style={{ width: size, height: size }}>
        
        {/* Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ²ĞµÑ‡ĞµĞ½Ğ¸Ğµ */}
        {isFasting && (
            <div className="absolute inset-0 bg-blue-500/5 blur-3xl rounded-full animate-pulse" />
        )}

        <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="rotate-[-90deg]">
          
          {/* 1. Ğ¤ĞĞ Ğ¨ĞšĞĞ›Ğ« (Ğ¡ĞµÑ€Ñ‹Ğ¹ ĞºÑ€ÑƒĞ³) */}
          <circle
            cx={center}
            cy={center}
            r={radius}
            fill="transparent"
            stroke="#f1f5f9" // slate-100
            strokeWidth={strokeWidth}
            strokeLinecap="round"
          />

          {/* 2. Ğ›Ğ˜ĞĞ˜Ğ¯ ĞŸĞ ĞĞ“Ğ Ğ•Ğ¡Ğ¡Ğ (Ğ¦Ğ²ĞµÑ‚Ğ½Ğ°Ñ) */}
          <circle
            cx={center}
            cy={center}
            r={radius}
            fill="transparent"
            stroke="currentColor"
            strokeWidth={strokeWidth}
            strokeDasharray={circumference}
            strokeDashoffset={strokeDashoffset}
            strokeLinecap="round"
            className={cn(
              "transition-all duration-1000 ease-out",
              isFasting ? "text-blue-500" : "text-transparent"
            )}
          />
        </svg>

        {/* Ğ¦Ğ•ĞĞ¢Ğ ĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•ĞšĞ¡Ğ¢ */}
        <div className="absolute inset-0 flex flex-col items-center justify-center z-10 pointer-events-none">
            
            {/* Ğ›ĞµĞ¹Ğ±Ğ» (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "24Ñ‡ Ğ‘Ğ°Ğ·Ğ°") */}
            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 bg-white px-2 py-1 rounded-md border border-slate-100 shadow-sm">
                {label || (isFasting ? "Ğ“Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ" : "ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ")}
            </span>

            {/* Ğ’Ğ Ğ•ĞœĞ¯ */}
            <div className="flex items-baseline text-slate-800">
                <span className="text-6xl font-[800] font-mono tracking-tighter tabular-nums leading-none">
                    {time.split(':')[0]}:{time.split(':')[1]}
                </span>
                <span className="text-xl font-medium text-slate-300 ml-1">
                    {time.split(':')[2]}
                </span>
            </div>

            {/* ĞŸĞ ĞĞ¦Ğ•ĞĞ¢ */}
            {isFasting && (
                <motion.div 
                    initial={{ scale: 0.8, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    className="mt-3 px-3 py-1 bg-blue-50 rounded-full border border-blue-100 flex items-center gap-1.5"
                >
                    <div className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse" />
                    <span className="text-xs font-bold text-blue-600 tabular-nums">
                        {progress.toFixed(1)}%
                    </span>
                </motion.div>
            )}
        </div>
      </div>
    </div>
  );
};

====================
END FILE: src/features/fasting/components/TimerRing.tsx
====================

====================
START FILE: src/features/fasting/components/ProtocolSelector.tsx
====================
import { useState } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { ChevronRight, ChevronDown, Check } from 'lucide-react';
import { FASTING_SCHEMES } from '../data/schemes';
import { cn } from '../../../utils/cn';
import { ProtocolDetails } from './ProtocolDetails';

interface Props {
  onSelect: (id: string) => void;
  onClose: () => void;
  currentSchemeId?: string;
}

export const ProtocolSelector = ({ onSelect, onClose, currentSchemeId }: Props) => {
  const [selectedPreviewId, setSelectedPreviewId] = useState<string | null>(null);

  const handlePreview = (id: string) => {
    setSelectedPreviewId(id);
  };

  const handleStart = () => {
    if (selectedPreviewId) {
        onSelect(selectedPreviewId);
        onClose();
    }
  };

  const ModalContent = (
    <>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        onClick={onClose}
        className="fixed inset-0 z-[100] bg-black/5 backdrop-blur-[2px]"
      />

      <motion.div
        initial={{ y: "100%" }}
        animate={{ y: 0 }}
        exit={{ y: "100%" }}
        transition={{ type: "spring", damping: 25, stiffness: 300 }}
        className="fixed bottom-0 left-0 right-0 z-[101] bg-[#F2F2F7] rounded-t-[2.5rem] h-[85vh] shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] flex flex-col overflow-hidden max-w-md mx-auto border-t border-white/50"
      >
        
        <div className="w-full flex justify-center pt-3 pb-2 bg-[#F2F2F7] shrink-0 cursor-pointer" onClick={onClose}>
          <div className="w-12 h-1.5 bg-gray-300 rounded-full" />
        </div>

        <AnimatePresence mode="wait">
            
            {/* Ğ­ĞšĞ ĞĞ Ğ”Ğ•Ğ¢ĞĞ›Ğ•Ğ™ */}
            {selectedPreviewId ? (
                <ProtocolDetails 
                    key="details"
                    schemeId={selectedPreviewId} 
                    onBack={() => setSelectedPreviewId(null)}
                    onStart={handleStart}
                />
            ) : (
                /* Ğ­ĞšĞ ĞĞ Ğ¡ĞŸĞ˜Ğ¡ĞšĞ (ĞĞ‘Ğ›Ğ•Ğ“Ğ§Ğ•ĞĞĞ«Ğ™) */
                <motion.div 
                    key="list"
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: -20 }}
                    transition={{ duration: 0.2 }}
                    className="flex flex-col h-full"
                >
                    <div className="px-6 pt-2 pb-6 flex justify-between items-end bg-[#F2F2F7] shrink-0">
                        <div>
                            <h2 className="text-2xl font-[900] text-slate-800 leading-none">
                                ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»
                            </h2>
                            <p className="text-xs font-bold text-slate-400 mt-1.5 uppercase tracking-wide">
                                Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»ÑŒ
                            </p>
                        </div>
                        
                        <button 
                            onClick={onClose}
                            className="w-9 h-9 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-100 text-slate-400 hover:text-slate-600 active:scale-95 transition-transform"
                        >
                            <ChevronDown className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto px-4 pb-10 space-y-2 pt-0 scrollbar-hide">
                        {FASTING_SCHEMES.map((s) => {
                            const isSelected = currentSchemeId === s.id;
                            // "24Ñ‡: Ğ‘Ğ°Ğ·Ğ°" -> "Ğ‘Ğ°Ğ·Ğ°"
                            const titleClean = s.title.split(':')[1]?.trim() || s.title;
                            
                            return (
                                <motion.button
                                    key={s.id}
                                    whileTap={{ scale: 0.98 }}
                                    onClick={() => handlePreview(s.id)}
                                    className={cn(
                                        "w-full flex items-center gap-4 p-3 rounded-[1.5rem] border text-left transition-all relative overflow-hidden group",
                                        isSelected 
                                            ? "bg-white border-blue-200 shadow-md ring-1 ring-blue-100" 
                                            : "bg-white border-slate-100/50 shadow-sm hover:border-slate-200"
                                    )}
                                >
                                    {/* Ğ˜ĞºĞ¾Ğ½ĞºĞ°: ĞœĞµĞ½ÑŒÑˆĞµ Ğ¸ Ğ°ĞºĞºÑƒÑ€Ğ°Ñ‚Ğ½ĞµĞµ */}
                                    <div className={cn(
                                        "w-10 h-10 rounded-xl flex items-center justify-center shrink-0 transition-colors",
                                        "bg-slate-50 group-hover:bg-slate-100"
                                    )}>
                                        <s.icon className={cn("w-5 h-5 opacity-80", s.color)} />
                                    </div>

                                    {/* Ğ˜Ğ½Ñ„Ğ¾: Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ */}
                                    <div className="flex-1 min-w-0 flex flex-col justify-center">
                                        <h3 className="font-bold text-[15px] text-slate-800 leading-tight">
                                            {titleClean}
                                        </h3>
                                        <p className="text-[11px] font-medium text-slate-400 mt-0.5">
                                            {s.hours} Ñ‡Ğ°ÑĞ¾Ğ²
                                        </p>
                                    </div>

                                    {/* Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€: ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ ÑÑ‚Ñ€ĞµĞ»ĞºĞ° Ğ¸Ğ»Ğ¸ Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºĞ° */}
                                    <div className="pr-1">
                                        {isSelected ? (
                                            <div className="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-sm">
                                                <Check className="w-3 h-3" />
                                            </div>
                                        ) : (
                                            <ChevronRight className="w-4 h-4 text-slate-300" />
                                        )}
                                    </div>

                                </motion.button>
                            );
                        })}
                        <div className="h-8" />
                    </div>
                </motion.div>
            )}
        </AnimatePresence>

      </motion.div>
    </>
  );

  return createPortal(
    <AnimatePresence>
        {ModalContent}
    </AnimatePresence>, 
    document.body
  );
};

====================
END FILE: src/features/fasting/components/ProtocolSelector.tsx
====================
