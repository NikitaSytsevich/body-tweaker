CODE AUDIT FOR BODY TWEAKER PROJECT - PART 2
Generated: 2026-01-29T04:54:25.476Z
================================================================================


================================================================================
FILE: src/features/biorhythm/components/StatsGrid.tsx (78 lines)
================================================================================

import { Activity, Heart, Brain } from 'lucide-react';
import { cn } from '../../../utils/cn';

interface Props {
  stats: {
    physical: number;
    emotional: number;
    intellectual: number;
  };
}

// üëá –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–¥–µ—Å—å –Ω–∞–ø–∏—Å–∞–Ω–æ "export const"
export const StatsGrid = ({ stats }: Props) => {
  const cards = [
    {
      id: 'phys',
      label: '–§–∏–∑–∏–∫–∞',
      value: stats.physical,
      icon: Activity,
      color: 'text-red-500 dark:text-red-400',
      bg: 'bg-red-50 dark:bg-red-900/30',
      bar: 'bg-red-500 dark:bg-red-400',
      desc: '–°–∏–ª–∞, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å'
    },
    {
      id: 'emo',
      label: '–≠–º–æ—Ü–∏–∏',
      value: stats.emotional,
      icon: Heart,
      color: 'text-green-500 dark:text-green-400',
      bg: 'bg-green-50 dark:bg-green-900/30',
      bar: 'bg-green-500 dark:bg-green-400',
      desc: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ'
    },
    {
      id: 'intel',
      label: '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç',
      value: stats.intellectual,
      icon: Brain,
      color: 'text-blue-500 dark:text-blue-400',
      bg: 'bg-blue-50 dark:bg-blue-900/30',
      bar: 'bg-blue-500 dark:bg-blue-400',
      desc: '–õ–æ–≥–∏–∫–∞, —Ä–µ–∞–∫—Ü–∏—è'
    }
  ];

  return (
    <div className="grid grid-cols-1 gap-3 mt-6">
      {cards.map((card) => (
        <div key={card.id} className="bg-white dark:bg-[#2C2C2E] p-4 rounded-2xl border border-slate-100 dark:border-white/10 shadow-sm flex items-center gap-4">

          <div className={cn("w-12 h-12 rounded-xl flex items-center justify-center shrink-0", card.bg)}>
            <card.icon className={cn("w-6 h-6", card.color)} />
          </div>

          <div className="flex-1">
            <div className="flex justify-between items-center mb-1">
              <h3 className="font-bold text-slate-700 dark:text-slate-200">{card.label}</h3>
              <span className={cn("font-black text-lg", card.color)}>{card.value}%</span>
            </div>

            {/* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */}
            <div className="w-full h-2 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden relative">
               <div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-white dark:bg-[#2C2C2E] z-10" />
               <div
                  className={cn("h-full transition-all duration-1000", card.bar)}
                  style={{ width: `${Math.abs(card.value)}%` }}
               />
            </div>

            <p className="text-xs text-slate-400 dark:text-slate-500 mt-1.5">{card.desc}</p>
          </div>
        </div>
      ))}
    </div>
  );
};



================================================================================
FILE: src/features/history/HistoryPage.tsx (251 lines)
================================================================================

// src/features/history/HistoryPage.tsx
import { useState, useEffect, useMemo } from 'react';
import { History, Calendar, Clock, Wind, Flame, ChevronRight, Loader2, Info, Settings } from 'lucide-react';
import { motion } from 'framer-motion';
import dayjs from 'dayjs';
import 'dayjs/locale/ru';
import { RecordDetails } from './components/RecordDetails';
import { SegmentedControl } from '../../components/ui/SegmentedControl';
import {
  storageGetHistory, // üëà CHANGED
  storageSaveHistory // üëà CHANGED
} from '../../utils/storage';
import type { HistoryRecord } from '../../utils/types';
import { SettingsModal } from '../../app/modals/SettingsModal';
import { InfoModal } from '../../app/modals/InfoModal';

dayjs.locale('ru');

export const HistoryPage = () => {
  const [activeTab, setActiveTab] = useState<'fasting' | 'breathing'>('fasting');
  const [records, setRecords] = useState<HistoryRecord[]>([]);
  const [selectedRecord, setSelectedRecord] = useState<HistoryRecord | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–æ–¥–∞–ª–æ–∫
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [isInfoOpen, setIsInfoOpen] = useState(false);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  useEffect(() => {
    const loadHistory = async () => {
      setIsLoading(true);
      try {
        // üëá –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —á–∞–Ω–∫–æ–≤
        const saved = await storageGetHistory<HistoryRecord>('history_fasting');
        const validRecords = saved.filter((r): r is HistoryRecord => 
          r && 
          typeof r.id === 'string' &&
          (r.type === 'fasting' || r.type === 'breathing')
        );
        setRecords(validRecords);
      } catch (e) {
        console.error('Failed to load history', e);
      } finally {
        setIsLoading(false);
      }
    };
    loadHistory();
  }, []);

  // –£–¥–∞–ª–µ–Ω–∏–µ (–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ)
  const handleDelete = async (id: string) => {
    const newRecords = records.filter(r => r.id !== id);
    setRecords(newRecords); // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    setSelectedRecord(null);
    // üëá –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    await storageSaveHistory('history_fasting', newRecords);
  };

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ)
  const handleUpdate = async (updatedRecord: HistoryRecord) => {
    const newRecords = records.map(r => r.id === updatedRecord.id ? updatedRecord : r);
    setRecords(newRecords); // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    setSelectedRecord(updatedRecord);
    // üëá –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    await storageSaveHistory('history_fasting', newRecords);
  };
  
  // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
  const filteredRecords = useMemo(() => 
    records.filter(r => r.type === activeTab),
    [records, activeTab]
  );
  // ... (–≤–µ—Å—å UI –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ)
  
  const totalHours = useMemo(() => 
    Math.round(filteredRecords.reduce((acc, r) => acc + r.durationSeconds, 0) / 3600),
    [filteredRecords]
  );

  const groupedRecords = useMemo(() => {
      const groups: Record<string, HistoryRecord[]> = {};
      filteredRecords.forEach(r => {
          const key = dayjs(r.endTime).format('MMMM YYYY');
          if (!groups[key]) groups[key] = [];
          groups[key].push(r);
      });
      return groups;
  }, [filteredRecords]);

  const tabs = [
    { value: 'fasting', label: '–ì–æ–ª–æ–¥', icon: Flame },
    { value: 'breathing', label: '–î—ã—Ö–∞–Ω–∏–µ', icon: Wind }
  ];

  return (
    <div className="min-h-full flex flex-col pb-6 relative z-0">
      <div className="bg-white dark:bg-[#2C2C2E] rounded-[3rem] shadow-sm shadow-slate-200/50 dark:shadow-black/20 relative overflow-hidden flex-1 flex flex-col z-10 border border-white/60 dark:border-white/10">

        {/* –•–ï–î–ï–† */}
        <div className="px-8 pt-8 pb-4 shrink-0 relative z-20 bg-white dark:bg-[#2C2C2E] border-b border-gray-50 dark:border-white/5 rounded-t-[3rem]">
          <div className="flex justify-between items-start mb-6">
            <div>
              <div className="flex items-center gap-2 mb-2">
                <History className="w-3 h-3 text-slate-400 dark:text-slate-500" />
                <span className="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">
                  –ñ—É—Ä–Ω–∞–ª
                </span>
              </div>
              <h1 className="text-3xl font-[900] text-slate-800 dark:text-white leading-tight">
                {activeTab === 'fasting' ? "–ì–æ–ª–æ–¥–∞–Ω–∏–µ" : "–î—ã—Ö–∞–Ω–∏–µ"}
              </h1>
            </div>

            <div className="flex items-center gap-2">
              {/* –ö–Ω–æ–ø–∫–∞ Info */}
              <motion.button
                whileTap={{ scale: 0.9 }}
                onClick={() => setIsInfoOpen(true)}
                className="p-2.5 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-400 bg-white dark:bg-[#2C2C2E] rounded-full shadow-sm border border-slate-100 dark:border-white/10"
              >
                <Info className="w-5 h-5" />
              </motion.button>

              {/* –ö–Ω–æ–ø–∫–∞ Settings */}
              <motion.button
                whileTap={{ scale: 0.9 }}
                onClick={() => setIsSettingsOpen(true)}
                className="p-2.5 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-400 bg-white dark:bg-[#2C2C2E] rounded-full shadow-sm border border-slate-100 dark:border-white/10"
              >
                <Settings className="w-5 h-5" />
              </motion.button>
            </div>
          </div>

          <div className="flex justify-between items-end mb-2">
            <div>
              <span className="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">
                –í—Å–µ–≥–æ
              </span>
              <div className="text-2xl font-black text-slate-800 dark:text-white leading-none mt-1">
                {activeTab === 'fasting' ? totalHours : filteredRecords.length}
                <span className="text-sm font-bold text-slate-400 dark:text-slate-500 ml-1">
                  {activeTab === 'fasting' ? '—á' : ''}
                </span>
              </div>
            </div>
          </div>

          <div className="mb-2">
            <SegmentedControl
              options={tabs}
              value={activeTab}
              onChange={(val) => setActiveTab(val as 'fasting' | 'breathing')}
            />
          </div>
        </div>

        {/* –°–ü–ò–°–û–ö */}
        <div className="flex-1 overflow-y-auto px-4 pt-4 pb-10 scrollbar-hide relative z-10">
          
          {isLoading ? (
             <div className="flex flex-col items-center justify-center h-full pb-20">
                <Loader2 className="w-8 h-8 text-blue-600 dark:text-blue-400 animate-spin" />
             </div>
          ) : filteredRecords.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-full text-center pb-20 opacity-50">
              <div className="w-20 h-20 bg-slate-50 dark:bg-[#3A3A3C] rounded-full flex items-center justify-center mb-4">
                <Calendar className="w-8 h-8 text-slate-300 dark:text-slate-600" />
              </div>
              <h3 className="font-bold text-slate-700 dark:text-slate-300 text-lg">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
              <p className="text-xs text-slate-400 dark:text-slate-500 max-w-[200px] mt-1">
                –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é —Å–µ—Å—Å–∏—é, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ—ë –∑–¥–µ—Å—å.
              </p>
            </div>
          ) : (
            // –†–µ–Ω–¥–µ—Ä –≥—Ä—É–ø–ø
            Object.entries(groupedRecords).map(([month, recordsInGroup]) => (
                <div key={month} className="mb-8 last:mb-0">
                    <h3 className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest px-4 mb-3 sticky top-0 bg-white/95 dark:bg-[#2C2C2E]/95 backdrop-blur-sm py-2 z-10">
                        {month}
                    </h3>

                    <div className="space-y-3">
                        {recordsInGroup.map((record) => (
                            <motion.div
                                layoutId={record.id}
                                key={record.id}
                                onClick={() => setSelectedRecord(record)}
                                className="bg-slate-50/50 dark:bg-[#3A3A3C]/50 hover:bg-slate-100 dark:hover:bg-[#4A4A4C] p-4 rounded-[1.5rem] flex items-center gap-4 group cursor-pointer transition-colors relative overflow-hidden"
                            >
                                {/* –î–∞—Ç–∞ */}
                                <div className="flex flex-col items-center justify-center w-12 shrink-0 border-r border-slate-200 dark:border-white/10 pr-4">
                                    <span className="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase">
                                        {dayjs(record.endTime).format('ddd')}
                                    </span>
                                    <span className="text-xl font-black text-slate-800 dark:text-white leading-none mt-0.5">
                                        {dayjs(record.endTime).format('D')}
                                    </span>
                                </div>

                                {/* –ò–Ω—Ñ–æ */}
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-2 mb-1">
                                        <h4 className="font-bold text-slate-700 dark:text-slate-200 truncate text-sm">
                                            {record.scheme}
                                        </h4>
                                        {record.type === 'fasting' && (
                                            <span className="text-[9px] font-bold bg-white dark:bg-[#2C2C2E] px-1.5 py-0.5 rounded text-slate-400 dark:text-slate-500 shadow-sm">
                                                {Math.floor(record.durationSeconds / 3600)}—á
                                            </span>
                                        )}
                                    </div>

                                    <div className="flex items-center gap-2 text-[10px] text-slate-400 dark:text-slate-500 font-medium">
                                        <Clock className="w-3 h-3" />
                                        {dayjs(record.startTime).format('HH:mm')} ‚Äî {dayjs(record.endTime).format('HH:mm')}
                                    </div>
                                </div>

                                {/* –°—Ç—Ä–µ–ª–∫–∞ */}
                                <div className="w-8 h-8 rounded-full bg-white dark:bg-[#2C2C2E] flex items-center justify-center text-slate-300 dark:text-slate-600 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:translate-x-0 translate-x-2">
                                    <ChevronRight className="w-4 h-4" />
                                </div>

                            </motion.div>
                        ))}
                    </div>
                </div>
            ))
          )}
        </div>
      </div>

      {/* –®–¢–û–†–ö–ê –î–ï–¢–ê–õ–ï–ô */}
      {selectedRecord && (
        <RecordDetails
          record={selectedRecord}
          onClose={() => setSelectedRecord(null)}
          onDelete={handleDelete}
          onUpdate={(updated) => handleUpdate(updated as HistoryRecord)}
        />
      )}

      {/* –ú–æ–¥–∞–ª–∫–∏ */}
      {isSettingsOpen && <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} />}
      {isInfoOpen && <InfoModal isOpen={isInfoOpen} onClose={() => setIsInfoOpen(false)} />}
    </div>
  );
};



================================================================================
FILE: src/features/history/components/RecordDetails.tsx (237 lines)
================================================================================

import { useState } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Calendar, Trash2, Edit3, Check, Sunrise, Moon, Clock, Trophy } from 'lucide-react';
import { FASTING_PHASES } from '../../fasting/data/stages';
import { NativeDatePicker } from '../../../components/ui/DatePicker';
import dayjs from 'dayjs';
import { cn } from '../../../utils/cn';
import type { HistoryRecord } from '../../../utils/types';

interface Props {
  record: HistoryRecord | null;
  onClose: () => void;
  onDelete: (id: string) => void;
  onUpdate: (updatedRecord: HistoryRecord) => void;
}

export const RecordDetails = ({ record, onClose, onDelete, onUpdate }: Props) => {
  // –•—É–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω—ã –≤—Å–µ–≥–¥–∞
  const [isEditing, setIsEditing] = useState(false);
  const [editedStart, setEditedStart] = useState(record?.startTime || '');
  const [editedEnd, setEditedEnd] = useState(record?.endTime || '');

  if (!record) return null;

  const durationSeconds = dayjs(editedEnd).diff(dayjs(editedStart), 'second');
  const hours = Math.floor(durationSeconds / 3600);
  const minutes = Math.floor((durationSeconds % 3600) / 60);
  
  const passedPhases = FASTING_PHASES.filter(p => (durationSeconds / 3600) >= p.hoursStart);

  const handleSave = () => {
    onUpdate({
        ...record,
        startTime: editedStart,
        endTime: editedEnd,
        durationSeconds
    });
    setIsEditing(false);
  };

  const isFasting = record.type === 'fasting';

  const content = (
    <AnimatePresence>
      <>
        {/* Backdrop */}
        <motion.div
          initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
          onClick={onClose}
          className="fixed inset-0 bg-black/40 backdrop-blur-md z-[100]"
        />

        {/* Modal Sheet */}
        <motion.div
          initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }}
          transition={{ type: "spring", damping: 25, stiffness: 300 }}
          className="fixed bottom-0 left-0 right-0 z-[101] bg-[#F2F2F7] dark:bg-[#1C1C1E] rounded-t-[2.5rem] h-[90vh] shadow-2xl flex flex-col overflow-hidden max-w-md mx-auto"
        >
          {/* Handle */}
          <div className="w-full flex justify-center pt-3 pb-2 bg-[#F2F2F7] dark:bg-[#1C1C1E] shrink-0" onClick={onClose}>
            <div className="w-12 h-1.5 bg-gray-300 dark:bg-white/20 rounded-full" />
          </div>

          {/* HEADER */}
          <div className="px-6 pt-2 pb-4 flex justify-between items-center bg-[#F2F2F7] dark:bg-[#1C1C1E] shrink-0">
              <button
                onClick={() => { onDelete(record.id); onClose(); }}
                className="w-10 h-10 bg-white dark:bg-[#2C2C2E] rounded-full flex items-center justify-center text-red-400 dark:text-red-500 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors shadow-sm"
              >
                  <Trash2 className="w-5 h-5" />
              </button>

              <div className="flex gap-3">
                  {isEditing ? (
                      <button onClick={handleSave} className="w-10 h-10 bg-blue-600 dark:bg-blue-500 text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-500/30 transition-all active:scale-95">
                          <Check className="w-5 h-5" />
                      </button>
                  ) : (
                      <button onClick={() => setIsEditing(true)} className="w-10 h-10 bg-white dark:bg-[#2C2C2E] text-blue-600 dark:text-blue-500 rounded-full flex items-center justify-center shadow-sm border border-transparent hover:border-blue-100 dark:hover:border-blue-500/30 active:scale-95 transition-all">
                          <Edit3 className="w-5 h-5" />
                      </button>
                  )}

                  <button onClick={onClose} className="w-10 h-10 bg-gray-200/50 dark:bg-white/10 text-gray-500 dark:text-slate-400 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-white/20 transition-colors">
                      <X className="w-5 h-5" />
                  </button>
              </div>
          </div>

          {/* CONTENT */}
          <div className="flex-1 overflow-y-auto pb-safe px-4 space-y-4">

              {/* HERO CARD */}
              <div className="bg-white dark:bg-[#2C2C2E] rounded-[2.5rem] p-8 shadow-sm flex flex-col items-center text-center relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-b from-blue-50/50 dark:from-blue-900/20 to-white dark:to-[#2C2C2E] pointer-events-none" />

                  {/* –ò–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞ –∑–∞–ø–∏—Å–∏ */}
                  <div className={cn(
                      "w-16 h-16 rounded-3xl flex items-center justify-center mb-4 shadow-lg rotate-3 relative z-10",
                      isFasting ? "bg-blue-600 dark:bg-blue-500 text-white" : "bg-purple-600 dark:bg-purple-500 text-white"
                  )}>
                      {isFasting ? <Trophy className="w-8 h-8" /> : <Clock className="w-8 h-8" />}
                  </div>

                  <h2 className="text-xl font-[900] text-slate-800 dark:text-white leading-tight relative z-10 max-w-[200px]">
                      {record.scheme}
                  </h2>
                  <div className="flex items-center gap-2 text-slate-400 dark:text-slate-500 text-xs font-bold uppercase tracking-wider mt-2 relative z-10 bg-white/50 dark:bg-white/10 px-3 py-1 rounded-full backdrop-blur-sm">
                      <Calendar className="w-3 h-3" />
                      {dayjs(editedEnd).format('D MMMM YYYY')}
                  </div>

                  {/* –û–≥—Ä–æ–º–Ω–∞—è —Ü–∏—Ñ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ */}
                  <div className="mt-8 mb-2 relative z-10">
                      <div className="flex items-baseline justify-center text-slate-800 dark:text-white">
                          <span className="text-7xl font-[900] tracking-tighter tabular-nums leading-none">
                              {hours}
                          </span>
                          <span className="text-lg font-bold text-slate-400 dark:text-slate-500 ml-1">—á</span>
                          {minutes > 0 && (
                              <>
                                  <span className="text-4xl font-[900] tracking-tighter tabular-nums leading-none ml-3 text-slate-300 dark:text-slate-600">
                                      {minutes}
                                  </span>
                                  <span className="text-lg font-bold text-slate-300 dark:text-slate-600 ml-1">–º</span>
                              </>
                          )}
                      </div>
                  </div>
              </div>

              {/* TIMELINE / EDITING */}
              <div className="bg-white dark:bg-[#2C2C2E] rounded-[2rem] p-6 shadow-sm">
                  <h3 className="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-6 pl-1">
                      –í—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                  </h3>

                  <div className="relative pl-4 space-y-8">
                      {/* –õ–∏–Ω–∏—è */}
                      <div className="absolute left-[23px] top-2 bottom-2 w-0.5 bg-slate-100 dark:bg-white/10 rounded-full" />

                      {/* –ù–∞—á–∞–ª–æ */}
                      <div className="relative z-10 flex items-center gap-4">
                          <div className="w-4 h-4 rounded-full bg-white dark:bg-[#2C2C2E] border-4 border-emerald-400 shadow-sm shrink-0" />
                          <div className="flex-1">
                              {isEditing ? (
                                  <NativeDatePicker
                                      label="–ù–∞—á–∞–ª–æ" icon={Sunrise}
                                      dateValue={editedStart} onChange={setEditedStart}
                                      disabled={false}
                                  />
                              ) : (
                                  <div className="flex justify-between items-center">
                                      <div>
                                          <p className="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase">–ù–∞—á–∞–ª–æ</p>
                                          <p className="text-lg font-bold text-slate-700 dark:text-slate-200">{dayjs(editedStart).format('HH:mm')}</p>
                                      </div>
                                      <span className="text-xs text-slate-400 dark:text-slate-500 font-medium bg-slate-50 dark:bg-[#3A3A3C] px-2 py-1 rounded-lg">
                                          {dayjs(editedStart).format('D MMM')}
                                      </span>
                                  </div>
                              )}
                          </div>
                      </div>

                      {/* –ö–æ–Ω–µ—Ü */}
                      <div className="relative z-10 flex items-center gap-4">
                          <div className="w-4 h-4 rounded-full bg-slate-800 dark:bg-slate-100 shadow-sm shrink-0" />
                          <div className="flex-1">
                              {isEditing ? (
                                  <NativeDatePicker
                                      label="–ö–æ–Ω–µ—Ü" icon={Moon}
                                      dateValue={editedEnd} onChange={setEditedEnd}
                                      disabled={false}
                                  />
                              ) : (
                                  <div className="flex justify-between items-center">
                                      <div>
                                          <p className="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</p>
                                          <p className="text-lg font-bold text-slate-700 dark:text-slate-200">{dayjs(editedEnd).format('HH:mm')}</p>
                                      </div>
                                      <span className="text-xs text-slate-400 dark:text-slate-500 font-medium bg-slate-50 dark:bg-[#3A3A3C] px-2 py-1 rounded-lg">
                                          {dayjs(editedEnd).format('D MMM')}
                                      </span>
                                  </div>
                              )}
                          </div>
                      </div>
                  </div>
              </div>

              {/* ACHIEVEMENTS (PHASES) */}
              {isFasting && passedPhases.length > 0 && (
                  <div className="bg-white dark:bg-[#2C2C2E] rounded-[2rem] p-6 shadow-sm mb-8">
                      <h3 className="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-4 pl-1">
                          –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —ç—Ç–∞–ø—ã
                      </h3>
                      <div className="space-y-3">
                          {passedPhases.map((phase) => {
                              // Extract the text color from phase.color (e.g., "text-blue-600" from "bg-blue-100 text-blue-600")
                              const textColor = phase.color.split(' ').find(c => c.startsWith('text-')) || 'text-slate-600';
                              // Extract the bg color for the icon container (e.g., "bg-blue-50" from "bg-blue-100 text-blue-600")
                              const bgColor = phase.color.split(' ').find(c => c.startsWith('bg-'))?.replace('100', '50').replace('600', '50') || 'bg-slate-50';

                              const IconComponent = phase.icon;

                              return (
                                  <div key={phase.id} className="flex items-center gap-4 group">
                                      <div className={cn(
                                          "w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 transition-colors",
                                          bgColor
                                      )}>
                                          <IconComponent className={cn("w-5 h-5", textColor)} />
                                      </div>
                                      <div className="flex-1 border-b border-slate-50 dark:border-white/10 pb-3 group-last:border-0 group-last:pb-0">
                                          <h4 className="text-sm font-bold text-slate-700 dark:text-slate-200">{phase.title}</h4>
                                          <p className="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wide mt-0.5">
                                              {phase.hoursStart} —á–∞—Å–æ–≤
                                          </p>
                                      </div>
                                  </div>
                              );
                          })}
                      </div>
                  </div>
              )}

          </div>
        </motion.div>
      </>
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};



================================================================================
FILE: src/features/articles/pages/ArticlesPage.tsx (26 lines)
================================================================================

import { BookOpen } from 'lucide-react';
import { articles } from '../content';
import { ArticleCard } from '../components/ArticleCard';

export const ArticlesPage = () => {
  return (
    <div className="animate-in fade-in duration-500">
      <div className="mb-8 text-center pt-8">
        <div className="inline-block p-4 bg-white dark:bg-[#2C2C2E] rounded-2xl shadow-sm border border-slate-100 dark:border-white/10 mb-4">
            <BookOpen className="w-8 h-8 text-blue-600 dark:text-blue-500" />
        </div>
        <h1 className="text-3xl font-[900] text-slate-800 dark:text-white">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h1>
        <p className="text-sm text-slate-500 dark:text-slate-400 mt-2 px-6">
            –ü–æ–ª–µ–∑–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ –≥–æ–ª–æ–¥–∞–Ω–∏–∏, –ø–∏—Ç–∞–Ω–∏–∏ –∏ –æ–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–º–∞.
        </p>
      </div>

      <div className="space-y-4 px-4 pb-24">
        {articles.map(article => (
          <ArticleCard key={article.id} article={article} />
        ))}
      </div>
    </div>
  );
};



================================================================================
FILE: src/features/articles/pages/ArticleDetailPage.tsx (74 lines)
================================================================================

import { useLocation, useNavigate } from 'react-router-dom';
import { X } from 'lucide-react';
import { getArticleById } from '../content';
import { motion } from 'framer-motion';

export const ArticleDetailPage = () => {
  const location = useLocation();
  // –ü–∞—Ä—Å–∏–º ID –∏–∑ URL
  const articleId = location.pathname.split('/articles/')[1];
  const navigate = useNavigate();
  const article = articleId ? getArticleById(articleId) : undefined;

  if (!article) return null;

  return (
    <>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        transition={{ duration: 0.3 }}
        className="fixed inset-0 bg-black/40 z-[100] backdrop-blur-sm"
        onClick={() => navigate('/')}
      />

      <motion.div
        initial={{ y: '100%' }}
        animate={{ y: '40px' }}
        exit={{ y: '100%' }}
        transition={{ type: "spring", damping: 25, stiffness: 200 }}
        className="fixed inset-x-0 bottom-0 top-0 z-[101] bg-white dark:bg-[#2C2C2E] rounded-t-[2rem] overflow-hidden flex flex-col shadow-2xl"
      >
        <button
          onClick={() => navigate('/')}
          className="absolute top-5 right-5 z-50 w-8 h-8 bg-black/20 dark:bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white/90 dark:text-slate-900/90 hover:bg-black/30 dark:hover:bg-white/30 transition-colors"
        >
          <X className="w-5 h-5" />
        </button>

        <div className="flex-1 overflow-y-auto">
            <div className="relative w-full h-[45vh] bg-slate-100 dark:bg-[#3A3A3C]">
                {article.imageUrl && (
                    <img
                        src={article.imageUrl}
                        alt={article.title}
                        className="w-full h-full object-cover"
                    />
                )}
                <div className="absolute top-0 left-0 right-0 h-32 bg-gradient-to-b from-black/60 to-transparent pointer-events-none" />
                <div className="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-white dark:from-[#2C2C2E] via-white/80 dark:via-[#2C2C2E]/80 to-transparent pointer-events-none" />

                <div className="absolute top-6 left-6 right-16">
                    <span className="text-xs font-bold text-white/95 uppercase tracking-widest drop-shadow-sm">
                        –°—Ç–∞—Ç—å—è: {article.category.toLowerCase()}
                    </span>
                </div>
            </div>

            <div className="relative px-6 -mt-6 pb-24">
                <div className="mb-6">
                    <h1 className="text-3xl font-[900] text-slate-900 dark:text-white leading-[1.1] tracking-tight">
                        {article.title}
                    </h1>
                </div>
                <div className="prose prose-lg prose-slate dark:prose-invert max-w-none font-medium text-slate-700 dark:text-slate-300 leading-relaxed">
                    {article.content}
                </div>
            </div>
        </div>
      </motion.div>
    </>
  );
};



================================================================================
FILE: src/features/articles/components/ArticleCard.tsx (51 lines)
================================================================================

import { motion } from 'framer-motion';
import { Link } from 'react-router-dom';
import type { Article } from '../types';

interface Props {
  article: Article;
}

export const ArticleCard = ({ article }: Props) => {
  return (
    <motion.div
      whileHover={{ scale: 0.98 }}
      whileTap={{ scale: 0.95 }}
      className="w-full mb-6 last:mb-24"
    >
      <Link to={`/articles/${article.id}`} className="block bg-white dark:bg-[#2C2C2E] rounded-[2rem] shadow-sm border border-slate-100 dark:border-white/10 overflow-hidden relative group">

        {/* –ö–∞—Ä—Ç–∏–Ω–∫–∞ (Aspect Ratio ~ 3:2 –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ) */}
        <div className="aspect-[3/2] w-full bg-slate-100 dark:bg-[#3A3A3C] relative overflow-hidden">
            {article.imageUrl ? (
                <img
                    src={article.imageUrl}
                    alt={article.title}
                    className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                />
            ) : (
                // –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç
                <div className="w-full h-full bg-gradient-to-br from-blue-50 dark:from-blue-900/20 to-indigo-50 dark:to-indigo-900/20 flex items-center justify-center text-slate-300 dark:text-slate-600">
                    –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                </div>
            )}
        </div>

        {/* –¢–µ–∫—Å—Ç */}
        <div className="p-6">
          <span className="text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-2 block">
            {article.category}
          </span>
          <h3 className="text-2xl font-[900] text-slate-900 dark:text-white leading-tight mb-3">
            {article.title}
          </h3>
          <p className="text-sm font-medium text-slate-500 dark:text-slate-400 line-clamp-3 leading-relaxed">
            {article.summary}
          </p>
        </div>

      </Link>
    </motion.div>
  );
};



================================================================================
FILE: src/features/articles/types.ts (13 lines)
================================================================================

import type { LucideIcon } from 'lucide-react';
import type { ReactNode } from 'react';

export interface Article {
  id: string;
  title: string;
  category: string; // –ù–∞–ø—Ä–∏–º–µ—Ä "–ó–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–¥—Ü–∞" –∏–ª–∏ "–£–∑–Ω–∞–π—Ç–µ"
  summary: string;
  imageUrl: string; // üëà –ù–æ–≤–æ–µ –ø–æ–ª–µ
  Icon?: LucideIcon; // –î–µ–ª–∞–µ–º –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –≥–ª–∞–≤–Ω–∞—è - –∫–∞—Ä—Ç–∏–Ω–∫–∞
  content: ReactNode;
}



================================================================================
FILE: src/components/ui/Modal.tsx (45 lines)
================================================================================

import { X } from 'lucide-react';
import { useEffect } from 'react';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
}

export const Modal = ({ isOpen, onClose, title, children }: ModalProps) => {
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
  }, [isOpen]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div
        className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
        onClick={onClose}
      />
      <div className="relative w-full max-w-sm bg-white dark:bg-[#2C2C2E] rounded-2xl shadow-2xl transform transition-all animate-in fade-in zoom-in-95 duration-200 border border-slate-100 dark:border-white/10">
        <div className="flex items-center justify-between p-4 border-b border-slate-100 dark:border-white/10">
          <h3 className="text-lg font-bold text-slate-800 dark:text-white">{title}</h3>
          <button
            onClick={onClose}
            className="p-1 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-400 rounded-full hover:bg-slate-50 dark:hover:bg-white/10 transition-colors"
          >
            <X className="w-5 h-5" />
          </button>
        </div>
        <div className="p-4 max-h-[70vh] overflow-y-auto">
          {children}
        </div>
      </div>
    </div>
  );
};



================================================================================
FILE: src/components/ui/ConfirmModal.tsx (98 lines)
================================================================================

import { motion, AnimatePresence } from 'framer-motion';
import { AlertTriangle } from 'lucide-react';
import { createPortal } from 'react-dom';
import { cn } from '../../utils/cn';

interface ConfirmModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title: string;
  message: string;
  confirmText?: string;
  cancelText?: string;
  variant?: 'danger' | 'warning' | 'info';
}

export const ConfirmModal = ({
  isOpen,
  onClose,
  onConfirm,
  title,
  message,
  confirmText = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
  cancelText = '–û—Ç–º–µ–Ω–∞',
  variant = 'warning',
}: ConfirmModalProps) => {
  
  const handleConfirm = () => {
    onConfirm();
    onClose();
  };

  const variantStyles = {
    danger: { button: 'bg-red-500 hover:bg-red-600 text-white', icon: 'text-red-500' },
    warning: { button: 'bg-orange-500 hover:bg-orange-600 text-white', icon: 'text-orange-500' },
    info: { button: 'bg-blue-600 dark:bg-blue-500 hover:bg-blue-600 text-white', icon: 'text-blue-500' },
  };

  const styles = variantStyles[variant];

  const content = (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[9998]"
          />

          {/* Wrapper –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */}
          <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 pointer-events-none">

            <motion.div
              initial={{ opacity: 0, scale: 0.95, y: 10 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 10 }}
              className="bg-white dark:bg-[#2C2C2E] rounded-[2rem] shadow-2xl max-w-sm w-full pointer-events-auto overflow-hidden"
            >
              <div className="p-6">
                <div className="flex items-start gap-4 mb-4">
                  <div className={cn('p-3 rounded-2xl bg-slate-50 dark:bg-[#3A3A3C] shrink-0', styles.icon)}>
                    <AlertTriangle className={cn('w-6 h-6', styles.icon)} />
                  </div>
                  <div className="flex-1 pt-1">
                    <h3 className="text-lg font-[900] text-slate-800 dark:text-white leading-tight mb-1">{title}</h3>
                    <p className="text-sm font-medium text-slate-500 dark:text-slate-400 leading-snug">{message}</p>
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button
                    onClick={onClose}
                    className="flex-1 px-4 py-3.5 bg-slate-100 dark:bg-[#3A3A3C] hover:bg-slate-200 dark:hover:bg-[#4A4A4C] text-slate-700 dark:text-slate-300 rounded-xl font-bold text-sm transition-colors active:scale-95"
                  >
                    {cancelText}
                  </button>
                  <button
                    onClick={handleConfirm}
                    className={cn('flex-1 px-4 py-3.5 rounded-xl font-bold text-sm transition-colors active:scale-95 shadow-lg', styles.button)}
                  >
                    {confirmText}
                  </button>
                </div>
              </div>
            </motion.div>
          </div>
        </>
      )}
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};



================================================================================
FILE: src/components/ui/ToastNotification.tsx (64 lines)
================================================================================

import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { Sparkles } from 'lucide-react';
import { useEffect } from 'react';

interface ToastProps {
  isVisible: boolean;
  title: string;
  message: string;
  onClose: () => void;
  onPress?: () => void; // üëà –ù–æ–≤—ã–π –ø—Ä–æ–ø
}

export const ToastNotification = ({ isVisible, title, message, onClose, onPress }: ToastProps) => {
  
  useEffect(() => {
    if (isVisible) {
      const timer = setTimeout(onClose, 5000);
      return () => clearTimeout(timer);
    }
  }, [isVisible, onClose]);

  const handleClick = () => {
      if (onPress) {
          onPress();
      }
      onClose(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
  };

  const content = (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          initial={{ y: -100, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          exit={{ y: -100, opacity: 0 }}
          transition={{ type: "spring", stiffness: 400, damping: 25 }}
          className="fixed top-4 left-4 right-4 z-[10001] flex justify-center pointer-events-none"
        >
          <div
            onClick={handleClick}
            className="bg-white/95 dark:bg-[#2C2C2E]/95 backdrop-blur-xl border border-white/50 dark:border-white/10 shadow-2xl shadow-blue-900/20 dark:shadow-black/40 rounded-[2rem] p-4 pr-6 flex items-center gap-4 max-w-sm w-full pointer-events-auto cursor-pointer active:scale-95 transition-transform"
          >
            <div className="w-12 h-12 bg-blue-500 dark:bg-blue-600 rounded-full flex items-center justify-center shrink-0 shadow-lg shadow-blue-500/30">
                <Sparkles className="w-6 h-6 text-white fill-current animate-pulse" />
            </div>

            <div className="flex-1 min-w-0 text-left">
                <h4 className="text-sm font-bold text-slate-800 dark:text-white leading-tight">
                    {title}
                </h4>
                <p className="text-xs text-slate-500 dark:text-slate-400 leading-tight mt-1 line-clamp-2 font-medium">
                    {message}
                </p>
            </div>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );

  return createPortal(content, document.body);
};



================================================================================
FILE: src/components/ui/DatePicker.tsx (53 lines)
================================================================================

import dayjs from 'dayjs';
import { Edit3 } from 'lucide-react';
import type { LucideIcon } from 'lucide-react'; // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç —Ç–∏–ø–∞
import { cn } from '../../utils/cn';

interface Props {
  label: string;
  dateValue: string;
  icon: LucideIcon;
  onChange: (val: string) => void;
  disabled: boolean;
}

export const NativeDatePicker = ({ 
  label, 
  dateValue, 
  icon: Icon, 
  onChange,
  disabled 
}: Props) => {
  const inputValue = dayjs(dateValue).format('YYYY-MM-DDTHH:mm');

  return (
    <div className={cn("text-center relative group", disabled && "opacity-50 grayscale cursor-not-allowed")}>
      <div className="flex items-center gap-1 text-slate-400 dark:text-slate-500 justify-center mb-1 opacity-70">
        <Icon className="w-3 h-3" />
        <span className="text-[9px] font-bold uppercase">{label}</span>
        {!disabled && <Edit3 className="w-2 h-2 ml-0.5 opacity-0 group-hover:opacity-50 transition-opacity" />}
      </div>

      <p className={cn(
        "text-sm font-bold text-slate-700 dark:text-slate-300 px-2 py-1 rounded-lg border border-transparent transition-all",
        !disabled && "group-hover:bg-slate-50 dark:group-hover:bg-[#3A3A3C] group-active:border-blue-200 dark:group-active:border-blue-500/30 group-active:bg-blue-50 dark:group-active:bg-blue-500/10"
      )}>
        {dayjs(dateValue).format('HH:mm')}
      </p>

      {!disabled && (
        <input
          type="datetime-local"
          value={inputValue}
          onChange={(e) => {
             if (!e.target.value) return;
             const newDate = dayjs(e.target.value).toISOString();
             onChange(newDate);
          }}
          className="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer"
        />
      )}
    </div>
  );
};



================================================================================
FILE: src/components/ui/SegmentedControl.tsx (128 lines)
================================================================================

import { useState, useRef, useEffect } from 'react';
import { motion, useSpring, useMotionValue, useTransform } from 'framer-motion';
import { cn } from '../../utils/cn';
import type { SegmentedControlOption } from '../../utils/types';

interface Props<T extends string = string> {
  options: SegmentedControlOption<T>[];
  value: T;
  onChange: (value: T) => void;
}

export function SegmentedControl<T extends string = string>({ options, value, onChange }: Props<T>) {
  const containerRef = useRef<HTMLDivElement>(null);
  const [isDragging, setIsDragging] = useState(false);
  
  const activeIndex = options.findIndex(o => o.value === value);
  
  const xPercent = useMotionValue(0);
  const springPercent = useSpring(xPercent, { 
      stiffness: isDragging ? 2000 : 500, 
      damping: isDragging ? 50 : 35 
  });

  useEffect(() => {
    if (!isDragging) {
        const step = 100 / options.length;
        xPercent.set(activeIndex * step);
    }
  }, [value, isDragging, options.length]);

  const handlePointerDown = (e: React.PointerEvent) => {
    e.preventDefault();
    setIsDragging(true);
    updatePosition(e.clientX);

    const onMove = (e: PointerEvent) => updatePosition(e.clientX);
    const onUp = (e: PointerEvent) => handlePointerUp(e.clientX);

    window.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', onUp);
    
    function handlePointerUp(clientX: number) {
        setIsDragging(false);
        window.removeEventListener('pointermove', onMove);
        window.removeEventListener('pointerup', onUp);
        
        if (!containerRef.current) return;
        const rect = containerRef.current.getBoundingClientRect();
        const padding = 4;
        const width = rect.width - (padding * 2);
        const itemWidth = width / options.length;
        
        const relativeX = clientX - rect.left - padding;
        let index = Math.floor(relativeX / itemWidth);
        index = Math.max(0, Math.min(index, options.length - 1));
        
        onChange(options[index].value);
    }
  };

  const updatePosition = (clientX: number) => {
      if (!containerRef.current) return;
      const rect = containerRef.current.getBoundingClientRect();
      const padding = 4;
      const width = rect.width - (padding * 2);
      const itemWidth = width / options.length;

      const relativeX = clientX - rect.left - padding - (itemWidth / 2);
      let percent = (relativeX / width) * 100;
      
      if (percent < 0) percent = percent / 4;
      if (percent > (100 - (100 / options.length))) {
          // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∞
      }
      
      xPercent.set(percent);
  };

  const widthPercent = 100 / options.length;
  
  // üëá –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: useTransform –≤—ã–Ω–µ—Å–µ–Ω –Ω–∞–≤–µ—Ä—Ö
  const leftStyle = useTransform(springPercent, v => `calc(${v}% + 4px)`);

  return (
    <div
        ref={containerRef}
        onPointerDown={handlePointerDown}
        className="bg-slate-100 dark:bg-[#2C2C2E] p-1 rounded-2xl flex relative cursor-pointer touch-none select-none"
    >
        {/* –ü–õ–ê–®–ö–ê (DRAG) */}
        {/* –û—Å—Ç–∞–≤–ª—è–µ–º —É—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–∞–º–æ–≥–æ div, –Ω–æ —Ö—É–∫ leftStyle —É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω –≤—ã—à–µ */}
        {isDragging && (
            <motion.div
                className="absolute top-1 bottom-1 bg-white dark:bg-[#3A3A3C] rounded-xl shadow-sm border border-black/5 dark:border-white/10 z-10 pointer-events-none"
                style={{
                    left: leftStyle, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    width: `calc(${widthPercent}% - 8px)`
                }}
            />
        )}

        {options.map((option) => {
            const isActive = option.value === value;
            return (
                <div
                    key={option.value}
                    className={cn(
                        "flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-xs font-bold relative z-20 transition-colors pointer-events-none",
                        isActive ? "text-slate-800 dark:text-white" : "text-slate-500 dark:text-slate-400"
                    )}
                >
                    {!isDragging && isActive && (
                        <motion.div
                            layoutId="segment-pill"
                            className="absolute inset-0 bg-white dark:bg-[#3A3A3C] rounded-xl shadow-sm border border-black/5 dark:border-white/10 -z-10"
                            transition={{ type: "spring", stiffness: 500, damping: 30 }}
                        />
                    )}

                    <option.icon className="w-3.5 h-3.5" />
                    {option.label}
                </div>
            );
        })}
    </div>
  );
};



================================================================================
FILE: src/hooks/useStorage.ts (55 lines)
================================================================================

// src/hooks/useStorage.ts
import { useState, useEffect, useCallback } from 'react';
import { storageGetJSON, storageSetJSON } from '../utils/storage';

export function useStorage<T>(key: string, initialValue: T) {
  const [storedValue, setStoredValue] = useState<T>(initialValue);
  const [isLoading, setIsLoading] = useState(true);

  // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
  useEffect(() => {
    let isMounted = true;

    const load = async () => {
      try {
        const value = await storageGetJSON<T>(key, initialValue);
        if (isMounted) {
          setStoredValue(value);
        }
      } catch (error) {
        console.error(`[useStorage] Error loading key "${key}":`, error);
      } finally {
        if (isMounted) {
          setIsLoading(false);
        }
      }
    };

    load();

    return () => {
      isMounted = false;
    };
  }, [key]); // initialValue –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–æ–≤

  // 2. –°–µ—Ç—Ç–µ—Ä (–æ–±–Ω–æ–≤–ª—è–µ—Ç UI –º–≥–Ω–æ–≤–µ–Ω–Ω–æ + —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –æ–±–ª–∞–∫–æ)
  const setValue = useCallback(
    async (value: T | ((val: T) => T)) => {
      try {
        const valueToStore = value instanceof Function ? value(storedValue) : value;
        
        // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (UI —Ä–µ–∞–≥–∏—Ä—É–µ—Ç —Å—Ä–∞–∑—É)
        setStoredValue(valueToStore);
        
        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å
        await storageSetJSON(key, valueToStore);
      } catch (error) {
        console.error(`[useStorage] Error saving key "${key}":`, error);
      }
    },
    [key, storedValue]
  );

  return { value: storedValue, setValue, isLoading };
}



================================================================================
FILE: src/hooks/useAddToHomeScreen.ts (52 lines)
================================================================================

import { useState, useEffect } from 'react';

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export const useAddToHomeScreen = () => {
  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [isIOS, setIsIOS] = useState(false);
  const [isStandalone, setIsStandalone] = useState(false);

  useEffect(() => {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ?
    const isStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || 
                             (window.navigator as any).standalone === true;
    setIsStandalone(isStandaloneMode);

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞: —ç—Ç–æ iOS?
    const userAgent = window.navigator.userAgent.toLowerCase();
    const isIosDevice = /iphone|ipad|ipod/.test(userAgent);
    setIsIOS(isIosDevice);

    // 3. –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ Android Chrome
    const handler = (e: Event) => {
      e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º –∞–≤—Ç–æ-–ø–æ–∫–∞–∑ (—á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ –∫–Ω–æ–ø–∫–µ)
      setDeferredPrompt(e as BeforeInstallPromptEvent);
    };

    window.addEventListener('beforeinstallprompt', handler);

    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);

  const promptInstall = async () => {
    if (deferredPrompt) {
      await deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if (choice.outcome === 'accepted') {
        setDeferredPrompt(null);
      }
    }
  };

  return { 
    deferredPrompt, 
    isIOS, 
    isStandalone, 
    promptInstall 
  };
};



================================================================================
FILE: src/utils/storage.ts (220 lines)
================================================================================

import WebApp from '@twa-dev/sdk';
import AES from 'crypto-js/aes';
import encUtf8 from 'crypto-js/enc-utf8';

// –ë–µ—Ä–µ–º –∫–ª—é—á –∏–∑ .env —Ñ–∞–π–ª–∞
const STORAGE_KEY = import.meta.env.VITE_STORAGE_KEY || 'dev-key-change-in-prod-build';

// –ü—Ä–µ—Ñ–∏–∫—Å, —á—Ç–æ–±—ã –∫–ª—é—á–∏ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–ª–∏—Å—å —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏
const KEY_PREFIX = 'bt_app_';

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —á–∞–Ω–∫–∏–Ω–≥–∞ (8 –∑–∞–ø–∏—Å–µ–π * ~400 –±–∞–π—Ç < 4096 –±–∞–π—Ç)
const HISTORY_CHUNK_SIZE = 8;
const HISTORY_MAX_CHUNKS = 50; // –•–≤–∞—Ç–∏—Ç –Ω–∞ 400 –∑–∞–ø–∏—Å–µ–π

const getKey = (key: string) => `${KEY_PREFIX}${key}`;

// –ü—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ—Å—Ç—É–ø–Ω—ã –ª–∏ –æ–±–ª–∞—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (Telegram Environment)
const isCloudAvailable = () => {
  return typeof WebApp !== 'undefined' && 
         WebApp.CloudStorage && 
         WebApp.isVersionAtLeast('6.9');
};

/**
 * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
 */
const encrypt = (value: string): string => {
  try {
    return AES.encrypt(value, STORAGE_KEY).toString();
  } catch (e) {
    console.error('Encryption error:', e);
    return value;
  }
};

/**
 * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏
 */
const decrypt = (value: string): string | null => {
  if (!value) return null;
  try {
    const bytes = AES.decrypt(value, STORAGE_KEY);
    const decryptedData = bytes.toString(encUtf8);
    
    if (!decryptedData && value.length > 0) {
      return value.startsWith('{') || value.startsWith('[') ? value : null;
    }
    return decryptedData;
  } catch {
    return value;
  }
};

// ================= API =================

/**
 * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
 */
export async function storageGet(key: string): Promise<string | null> {
  const namespacedKey = getKey(key);

  if (isCloudAvailable()) {
    try {
      return new Promise((resolve) => {
        WebApp.CloudStorage.getItem(namespacedKey, (err, value) => {
          if (err) {
            console.warn('[Cloud] Get Error, falling back to local:', err);
            resolve(decrypt(localStorage.getItem(namespacedKey) || ''));
          } else {
            resolve(decrypt(value || ''));
          }
        });
      });
    } catch (e) {
      console.warn('[Cloud] Read failed, falling back to local', e);
    }
  }

  return decrypt(localStorage.getItem(namespacedKey) || '');
}

/**
 * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
 */
export async function storageSet(key: string, value: string): Promise<boolean> {
  const namespacedKey = getKey(key);
  const encrypted = encrypt(value);

  try {
    localStorage.setItem(namespacedKey, encrypted);
  } catch (e) { /* ignore quota */ }

  if (isCloudAvailable()) {
    return new Promise((resolve) => {
      WebApp.CloudStorage.setItem(namespacedKey, encrypted, (err, stored) => {
        if (err) {
            console.error('[Cloud] Set Error:', err);
            resolve(false);
        } else {
            resolve(stored || false);
        }
      });
    });
  }

  return true;
}

/**
 * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
 */
export async function storageRemove(key: string): Promise<boolean> {
  const namespacedKey = getKey(key);
  
  try {
    localStorage.removeItem(namespacedKey);
  } catch { /* ignore */ }
  
  if (isCloudAvailable()) {
    return new Promise((resolve) => {
      WebApp.CloudStorage.removeItem(namespacedKey, (err, deleted) => {
         resolve(!err && (deleted || false));
      });
    });
  }
  return true;
}

/**
 * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ JSON
 */
export async function storageGetJSON<T>(key: string, defaultValue: T): Promise<T> {
  const value = await storageGet(key);
  if (!value) return defaultValue;
  try {
    return JSON.parse(value) as T;
  } catch {
    return defaultValue;
  }
}

/**
 * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JSON
 */
export async function storageSetJSON<T>(key: string, value: T): Promise<boolean> {
  try {
    const serialized = JSON.stringify(value);
    return await storageSet(key, serialized);
  } catch (e) {
    console.warn(`[Storage] JSON serialize error for "${key}":`, e);
    return false;
  }
}

// ================= NEW HISTORY API =================

/**
 * –ß—Ç–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —á–∞–Ω–∫–æ–≤ –∏ –º–∏–≥—Ä–∞—Ü–∏–µ–π
 */
export async function storageGetHistory<T>(baseKey: string): Promise<T[]> {
  // 1. –ü–æ–ø—ã—Ç–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç–∞—Ä–æ–º –∫–ª—é—á–µ)
  const legacyData = await storageGetJSON<T[] | null>(baseKey, null);
  if (legacyData && Array.isArray(legacyData) && legacyData.length > 0) {
    console.log('[Storage] Migrating legacy history to chunks...');
    await storageSaveHistory(baseKey, legacyData);
    await storageRemove(baseKey);
    return legacyData;
  }

  // 2. –ß—Ç–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤
  const chunks = await Promise.all(
    Array.from({ length: HISTORY_MAX_CHUNKS }, (_, i) => 
      storageGetJSON<T[]>(`${baseKey}_${i}`, [])
    )
  );

  return chunks.flat();
}

/**
 * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —á–∞–Ω–∫–∏
 */
export async function storageSaveHistory<T>(baseKey: string, list: T[]): Promise<boolean> {
  let success = true;
  
  for (let i = 0; i < HISTORY_MAX_CHUNKS; i++) {
    const chunk = list.slice(i * HISTORY_CHUNK_SIZE, (i + 1) * HISTORY_CHUNK_SIZE);
    const key = `${baseKey}_${i}`;
    
    if (chunk.length > 0) {
      const res = await storageSetJSON(key, chunk);
      if (!res) success = false;
    } else {
      // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∫–ª—é—á–∏, —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞—Ç—å –∫–≤–æ—Ç—É
      await storageRemove(key);
    }
  }
  return success;
}

/**
 * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ)
 */
export async function storageUpdateHistory<T>(
  key: string, 
  newItem: T, 
  maxItems: number = 1000
): Promise<T[]> {
  try {
    const currentList = await storageGetHistory<T>(key);
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –∏ –æ–±—Ä–µ–∑–∞–µ–º
    const newList = [newItem, ...currentList].slice(0, maxItems);
    await storageSaveHistory(key, newList);
    return newList;
  } catch (e) {
    console.error(`[Storage] Failed to update history for "${key}"`, e);
    return [];
  }
}



================================================================================
FILE: src/utils/sounds.ts (259 lines)
================================================================================

// src/utils/sounds.ts
// –ü–æ–ª–Ω–∞—è, API-—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –∞—É–¥–∏–æ-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

export interface AmbientTrack {
  id: string;
  name: string;
  icon: 'fire' | 'wind' | 'rain' | 'space';
}

const BASE_PATH = '/sounds';

export const AMBIENT_TRACKS: AmbientTrack[] = [
  { id: 'fire', name: '–û–≥–æ–Ω—å', icon: 'fire' },
  { id: 'rain', name: '–î–æ–∂–¥—å', icon: 'rain' },
  { id: 'wind', name: '–í–µ—Ç–µ—Ä', icon: 'wind' },
  { id: 'space', name: '–ö–æ—Å–º–æ—Å', icon: 'space' },
];

const SFX_PATHS: Record<string, string> = {
  inhale: `${BASE_PATH}/inhale.mp3`,
  hold: `${BASE_PATH}/hold.mp3`,
  exhale: `${BASE_PATH}/exhale.mp3`,
  finish: `${BASE_PATH}/finish.mp3`,
};

class SoundManager {
  /* ================= CORE ================= */

  private ctx: AudioContext | null = null;
  private buffers: Record<string, AudioBuffer> = {};

  private ambientSource: AudioBufferSourceNode | null = null;
  private ambientGain: GainNode | null = null;

  private readonly MIN_GAIN = 0.0001;
  private readonly SMOOTH = 0.08;

  /* ================= STATE ================= */

  public isMusicEnabled = true;
  public isSfxEnabled = true;

  public musicVolume = 0.5;
  public sfxVolume = 0.7;

  private isSessionActive = false;
  private currentTrackId = 'fire';

  constructor() {
    this.initCtx();
    this.preload();
  }

  /* ================= INIT ================= */

  private initCtx() {
    if (this.ctx || typeof window === 'undefined') return;

    const Ctx =
      window.AudioContext ||
      (window as any).webkitAudioContext;

    if (Ctx) this.ctx = new Ctx();
  }

  /** –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ –ø–æ user-gesture (Telegram / iOS) */
  unlock() {
    this.initCtx();
    if (!this.ctx) return;

    if (this.ctx.state === 'suspended') {
      this.ctx.resume();
    }

    // iOS WebView audio unlock
    const osc = this.ctx.createOscillator();
    osc.connect(this.ctx.destination);
    osc.start();
    osc.stop(this.ctx.currentTime + 0.001);
  }

  /* ================= LOADING ================= */

  private async preload() {
    await this.loadTrack(this.currentTrackId);
    await this.loadSfx();
  }

  private async loadBuffer(key: string, url: string) {
    if (!this.ctx || this.buffers[key]) return;

    try {
      const res = await fetch(url);
      const buf = await res.arrayBuffer();
      this.buffers[key] = await this.ctx.decodeAudioData(buf);
    } catch (e) {
      console.warn('Sound load failed:', url);
    }
  }

  private async loadTrack(id: string) {
    await this.loadBuffer(id, `${BASE_PATH}/${id}.mp3`);
  }

  private async loadSfx() {
    for (const [key, url] of Object.entries(SFX_PATHS)) {
      await this.loadBuffer(key, url);
    }
  }

  /* ================= HELPERS ================= */

  private uiToGain(x: number) {
    return Math.max(this.MIN_GAIN, Math.pow(x, 2.2));
  }

  private smoothGain(gain: GainNode, value: number) {
    if (!this.ctx) return;
    const now = this.ctx.currentTime;
    gain.gain.cancelScheduledValues(now);
    gain.gain.setTargetAtTime(value, now, this.SMOOTH);
  }

  /* ================= MUSIC ================= */

  getCurrentTrackId() {
    return this.currentTrackId;
  }

  async setTrack(id: string) {
    if (id === this.currentTrackId) return;

    this.currentTrackId = id;
    await this.loadTrack(id);

    if (this.isSessionActive && this.isMusicEnabled) {
      this.stopAmbient();
      setTimeout(() => this.playAmbient(), 150);
    }
  }

  setMusicVolume(vol: number) {
    this.musicVolume = vol;
    if (this.ambientGain) {
      this.smoothGain(
        this.ambientGain,
        this.uiToGain(vol)
      );
    }
  }

  setMusicEnabled(enabled: boolean) {
    this.isMusicEnabled = enabled;
    if (enabled && this.isSessionActive) this.playAmbient();
    else this.stopAmbient();
  }

  startSession() {
    this.isSessionActive = true;
    if (this.isMusicEnabled) this.playAmbient();
  }

  stopSession() {
    this.isSessionActive = false;
    this.stopAmbient();
  }

  private playAmbient() {
    if (!this.ctx) return;

    const buffer = this.buffers[this.currentTrackId];
    if (!buffer) return;

    if (this.ambientSource) {
      try { this.ambientSource.stop(); } catch {}
    }

    const source = this.ctx.createBufferSource();
    const gain = this.ctx.createGain();

    source.buffer = buffer;
    source.loop = true;

    gain.gain.value = this.MIN_GAIN;

    source.connect(gain);
    gain.connect(this.ctx.destination);
    source.start();

    this.smoothGain(gain, this.uiToGain(this.musicVolume));

    this.ambientSource = source;
    this.ambientGain = gain;
  }

  private stopAmbient() {
    if (!this.ctx || !this.ambientSource || !this.ambientGain) return;

    const now = this.ctx.currentTime;

    this.ambientGain.gain.cancelScheduledValues(now);
    this.ambientGain.gain.setTargetAtTime(
      this.MIN_GAIN,
      now,
      0.12
    );

    const src = this.ambientSource;
    setTimeout(() => {
      try { src.stop(); } catch {}
    }, 300);

    this.ambientSource = null;
    this.ambientGain = null;
  }

  /* ================= SFX ================= */

  setSfxVolume(vol: number) {
    this.sfxVolume = vol;
  }

  setSfxEnabled(enabled: boolean) {
    this.isSfxEnabled = enabled;
  }

  private playSfx(key: string) {
    if (!this.ctx || !this.buffers[key] || !this.isSfxEnabled) return;

    const source = this.ctx.createBufferSource();
    const gain = this.ctx.createGain();

    source.buffer = this.buffers[key];
    gain.gain.value = this.uiToGain(this.sfxVolume);

    source.connect(gain);
    gain.connect(this.ctx.destination);
    source.start();
  }

  playInhale() { this.playSfx('inhale'); }
  playHold() { this.playSfx('hold'); }
  playExhale() { this.playSfx('exhale'); }
  playFinish() {
    this.stopSession();
    this.playSfx('finish');
  }

  /* ================= API COMPAT ================= */

  /** üî• –ö–†–ò–¢–ò–ß–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ useBreathingSession */
  stopAll() {
    this.isSessionActive = false;
    this.stopAmbient();
  }
}

export const soundManager = new SoundManager();



================================================================================
FILE: src/utils/cn.ts (7 lines)
================================================================================

import { clsx, type ClassValue } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}



================================================================================
FILE: src/utils/types.ts (56 lines)
================================================================================

/**
 * –û–±—â–∏–µ —Ç–∏–ø—ã –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */

import type { ComponentType, SVGProps } from 'react';

/**
 * –¢–∏–ø –¥–ª—è –∏–∫–æ–Ω–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏–∑ lucide-react
 * –ò–∫–æ–Ω–∫–∏ lucide-react - —ç—Ç–æ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–µ SVG –ø—Ä–æ–ø—Å—ã
 */
export type IconType = ComponentType<SVGProps<SVGSVGElement>>;

/**
 * –¢–∏–ø –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
 */
export interface NotificationSettings {
  fasting: boolean;
}

/**
 * –¢–∏–ø –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏—Å—Ç–æ—Ä–∏–∏
 */
export interface HistoryRecord {
  id: string;
  type: 'fasting' | 'breathing';
  scheme: string;
  startTime: string;
  endTime: string;
  durationSeconds: number;
}

/**
 * –¢–∏–ø –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏–∫–æ–Ω–æ–∫
 */
export interface IconAnimation {
  scaleX?: number | number[];
  rotate?: number | number[];
  x?: number | number[];
  y?: number | number[];
  scale?: number | number[];
  transition?: {
    duration?: number;
    ease?: string;
    times?: number[];
  };
}

/**
 * –¢–∏–ø –¥–ª—è –æ–ø—Ü–∏–π —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–∞
 */
export interface SegmentedControlOption<T extends string = string> {
  value: T;
  label: string;
  icon: IconType;
}



================================================================================
FILE: package.json (53 lines)
================================================================================

{
  "name": "body-tweaker",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview",
    "generate-icons": "node generate-icons.js",
    "audit": "node scripts/generate-audit.js"
  },
  "dependencies": {
    "@twa-dev/sdk": "^8.0.2",
    "@types/crypto-js": "^4.2.2",
    "@vercel/analytics": "^1.6.1",
    "clsx": "^2.1.1",
    "crypto-js": "^4.2.0",
    "dayjs": "^1.11.19",
    "framer-motion": "^12.27.0",
    "lucide-react": "^0.562.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.12.0",
    "recharts": "^3.6.0",
    "tailwind-merge": "^3.4.0",
    "use-sound": "^5.0.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vercel/node": "^5.5.23",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.17",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.4.35",
    "rollup-plugin-visualizer": "^6.0.5",
    "sharp": "^0.34.5",
    "tailwindcss": "^3.4.1",
    "terser": "^5.46.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4",
    "vite-plugin-pwa": "^1.2.0"
  }
}



================================================================================
FILE: vite.config.ts (180 lines)
================================================================================

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { visualizer } from 'rollup-plugin-visualizer'
import { VitePWA } from 'vite-plugin-pwa'

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    react(),
    // –ê–Ω–∞–ª–∏–∑ –±–∞–Ω–¥–ª–∞ - —Å–æ–∑–¥–∞–µ—Ç dist/stats.html –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏
    visualizer({
      filename: 'dist/stats.html',
      open: false,
      gzipSize: true,
      brotliSize: true,
    }),
    // PWA (Progressive Web App)
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['*.png', '*.svg', '*.jpg'],
      manifest: {
        name: 'Body Tweaker',
        short_name: 'Body Tweaker',
        description: 'Scientific Biohacking - Track fasting, breathing, and health',
        theme_color: '#F2F2F7',
        background_color: '#F2F2F7',
        display: 'standalone',
        orientation: 'portrait',
        scope: '/',
        start_url: '/',
        icons: [
          {
            src: '/icon-192.png',
            sizes: '192x192',
            type: 'image/png',
            purpose: 'any maskable'
          },
          {
            src: '/icon-512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable'
          }
        ],
        categories: ['health', 'fitness', 'lifestyle'],
        shortcuts: [
          {
            name: 'Start Fasting',
            short_name: 'Fasting',
            description: 'Start a new fasting session',
            url: '/timer',
            icons: [{ src: '/icon-192.png', sizes: '192x192' }]
          },
          {
            name: 'Metabolism Map',
            short_name: 'Map',
            description: 'View your metabolism map',
            url: '/',
            icons: [{ src: '/icon-192.png', sizes: '192x192' }]
          }
        ]
      },
      workbox: {
        // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'google-fonts-cache',
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24 * 365 // 1 year
              },
              cacheableResponse: {
                statuses: [0, 200]
              }
            }
          },
          {
            urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp|ico)$/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'images-cache',
              expiration: {
                maxEntries: 60,
                maxAgeSeconds: 60 * 60 * 24 * 30 // 30 days
              }
            }
          },
          {
            urlPattern: /^https:\/\/cdn\.telegram\.org\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'telegram-assets',
              expiration: {
                maxEntries: 20,
                maxAgeSeconds: 60 * 60 * 24 * 7 // 7 days
              }
            }
          }
        ],
        // –ù–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å API –∑–∞–ø—Ä–æ—Å—ã
        navigateFallback: null,
      },
      devOptions: {
        enabled: true // –í–∫–ª—é—á–∏—Ç—å PWA –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      }
    })
  ],
  build: {
    // –£–ª—É—á—à–µ–Ω–Ω–∞—è –º–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è
    minify: 'terser',
    terserOptions: {
      compress: {
        // –£–¥–∞–ª–∏—Ç—å console.log –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
        drop_console: true,
        drop_debugger: true,
        // –£–¥–∞–ª–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º—ã–π –∫–æ–¥
        dead_code: true,
        // –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        unused: true,
      },
      format: {
        // –£–±—Ä–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        comments: false,
      },
    },
    rollupOptions: {
      output: {
        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤
        manualChunks: (id) => {
          // React ecosystem
          if (id.includes('react') || id.includes('react-dom') || id.includes('react-router')) {
            return 'react-vendor'
          }

          // Framer Motion (—Ä–∞–∑–¥–µ–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Å–∞–º—ã–π —Ç—è–∂—ë–ª—ã–π)
          if (id.includes('framer-motion')) {
            return 'motion-vendor'
          }

          // UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
          if (id.includes('lucide-react')) {
            return 'icons-vendor'
          }

          // Charts
          if (id.includes('recharts')) {
            return 'charts-vendor'
          }

          // Telegram SDK
          if (id.includes('@twa-dev/sdk')) {
            return 'telegram-vendor'
          }

          // Utils
          if (id.includes('dayjs') || id.includes('clsx') || id.includes('tailwind-merge') || id.includes('crypto-js')) {
            return 'utils-vendor'
          }

          // Node modules (–æ—Å—Ç–∞–ª—å–Ω–æ–µ)
          if (id.includes('node_modules')) {
            return 'vendor'
          }
        },
        // –ò–º–µ–Ω–∞ —á–∞–Ω–∫–æ–≤
        chunkFileNames: 'assets/[name]-[hash].js',
        entryFileNames: 'assets/[name]-[hash].js',
        assetFileNames: 'assets/[name]-[hash].[ext]',
      }
    },
    // –õ–∏–º–∏—Ç—ã –¥–ª—è chunks
    chunkSizeWarningLimit: 500,
    // Source maps (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
    sourcemap: false,
  }
})



================================================================================
FILE: tsconfig.json (8 lines)
================================================================================

{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}



================================================================================
FILE: tailwind.config.js (17 lines)
================================================================================

/** @type {import('tailwindcss').Config} */
export default {
  darkMode: 'class',
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      padding: {
        'safe': 'env(safe-area-inset-bottom)',
      }
    },
  },
  plugins: [],
}



================================================================================
FILE: CLAUDE.md (194 lines)
================================================================================

# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Body Tweaker is a Telegram Mini Web App for scientific biohacking. It helps users track intermittent fasting, breathing exercises, biorhythms, and provides educational articles.

**Technology Stack:**
- React 19 + TypeScript + Vite
- Telegram Web App SDK (@twa-dev/sdk)
- Framer Motion (animations)
- React Router v7
- Tailwind CSS
- Recharts (charts)
- Day.js (date/time)
- Crypto-js (encryption)

## Commands

```bash
# Development
npm run dev          # Start dev server (http://localhost:5173)

# Build & Type Check
npm run build        # Run TypeScript check + Vite build
tsc -b              # TypeScript check only (without build)

# Code Quality
npm run lint         # Run ESLint

# Preview & Analysis
npm run preview      # Preview production build locally
# After build, open dist/stats.html for bundle analysis

# Assets
npm run generate-icons  # Generate PWA icons from source SVG
```

## Architecture

### App Structure

```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Layout.tsx           # Main layout with draggable navigation
‚îÇ   ‚îú‚îÄ‚îÄ WelcomeScreen.tsx    # First-run terms screen
‚îÇ   ‚îî‚îÄ‚îÄ modals/              # Settings, Info, InstallGuide modals
‚îú‚îÄ‚îÄ features/
‚îÇ   ‚îú‚îÄ‚îÄ fasting/             # Fasting timer & metabolism map
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context/TimerContext.tsx    # Global timer state
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/useFastingTimer.ts    # Timer hook
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data/schemes.ts             # Protocol definitions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data/stages.ts              # Metabolic phases
‚îÇ   ‚îú‚îÄ‚îÄ breathing/           # Breathing exercises
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data/patterns.ts            # Exercise patterns
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hooks/useBreathingSession.ts
‚îÇ   ‚îú‚îÄ‚îÄ biorhythm/          # Biorhythm charts
‚îÇ   ‚îú‚îÄ‚îÄ history/            # Activity history
‚îÇ   ‚îî‚îÄ‚îÄ articles/           # Educational articles
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îî‚îÄ‚îÄ ThemeContext.tsx    # Dark mode theme management
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useStorage.ts       # React hook for persistent storage
‚îÇ   ‚îî‚îÄ‚îÄ useAddToHomeScreen.ts
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ storage.ts          # Cloud + local storage with encryption
‚îÇ   ‚îú‚îÄ‚îÄ sounds.ts           # Audio utilities
‚îÇ   ‚îî‚îÄ‚îÄ cn.ts               # clsx + tailwind-merge
‚îî‚îÄ‚îÄ main.tsx                # Entry point (Telegram SDK init)
```

### Key Architectural Patterns

**1. Telegram Cloud Storage with Fallback**

The app uses Telegram CloudStorage with automatic fallback to localStorage. All data is encrypted using AES with a key from `VITE_STORAGE_KEY`. Storage utilities are in `src/utils/storage.ts`:
- `storageGet/ storageSet` - Basic string storage
- `storageGetJSON/ storageSetJSON` - JSON storage
- `storageGetHistory/ storageSaveHistory/ storageUpdateHistory` - Chunked history storage (bypasses 4096 byte limit)

**2. Feature-Based Organization**

Each feature (fasting, breathing, biorhythm, articles) is self-contained with:
- `components/` - Feature-specific UI components
- `hooks/` - Feature-specific hooks
- `data/` - Static data (schemes, patterns, content)
- `*.tsx` page files

**3. Global State with Context**

`TimerContext.tsx` provides global fasting timer state across the app. It handles:
- Timer state and persistence
- Phase change detection and notifications
- History recording on completion

**4. Custom Navigation (Draggable Dock)**

The app uses a custom draggable bottom navigation implemented in `Layout.tsx`. Key implementation details:
- Not using standard React Router navigation - instead manages page visibility with the `PageView` component
- Navigation state is controlled by dragging a floating dock with spring animations (Framer Motion)
- All four main pages (Map, Timer, Breathing, History) are mounted simultaneously, with visibility toggled via CSS
- Article detail pages (`/articles/*`) are handled differently and hide the main navigation
- Navigation position persists across page reloads via storage

**5. First-Run Flow**

`App.tsx` checks for `has_accepted_terms` storage key. If not present, shows `WelcomeScreen.tsx` before the main app.

### Important Details

- **Environment Variable**: `VITE_STORAGE_KEY` is used for encryption. Must be set in production builds.
- **History Chunking**: History records are split into chunks of 8 items to bypass Telegram's 4096 byte storage limit.
- **Telegram SDK**: Initialized in `main.tsx` with header/background color configuration. Always call `WebApp.ready()` and `WebApp.expand()` to ensure proper Telegram integration.
- **Route Handling**: Special handling for article detail pages (`/articles/*`) which hide the main navigation and header.
- **Notifications**: Phase change notifications are handled through `TimerContext` and displayed via `ToastNotification` component.
- **No Test Suite**: This project does not currently have automated tests.

### Data Flow

1. **Fasting Timer**: TimerContext ‚Üí storage (encrypted) ‚Üí persisted across sessions
2. **History Records**: On timer stop ‚Üí record created ‚Üí chunked storage ‚Üí displayed in HistoryPage
3. **Settings**: Stored in `user_settings` key, retrieved for notification preferences

### UI Components

Common UI components in `src/components/ui/`:
- `Modal.tsx` - Base modal with Framer Motion animations
- `ConfirmModal.tsx` - Confirmation dialogs
- `DatePicker.tsx` - Date selection
- `SegmentedControl.tsx` - Segmented control
- `ToastNotification.tsx` - Toast notifications

### Theme System

The app uses a custom `ThemeProvider` (ThemeContext.tsx) that:
- Auto-detects Telegram's theme (light/dark)
- Syncs with Telegram's theme changes via `WebApp.onEvent('themeChanged')`
- Updates Telegram header/background colors to match
- Applies `dark` class to document root

### Build Configuration

The Vite config (`vite.config.ts`) includes:
- **Bundle Splitting**: Separates React, Framer Motion, icons, charts, Telegram SDK, and utilities into separate chunks for optimal caching
- **PWA Support**: Service worker with caching for fonts, images, and Telegram assets
- **Terser Optimization**: Removes console.log, debugger, dead code, and comments in production
- **Bundle Analysis**: Generates `dist/stats.html` after build - open this file to inspect bundle size and composition

### Storage Implementation Details

**Encryption:**
- All data is encrypted using AES-256 before storage via crypto-js
- Keys are namespaced with `bt_app_` prefix
- Automatic fallback from Telegram Cloud to localStorage

**History Chunking:**
- Each chunk holds 8 records (~400 bytes each, under 4096 byte limit)
- Supports up to 400 history records (50 chunks)
- Automatic migration from legacy non-chunked format
- Empty chunks are automatically deleted to save space

**Working with Storage:**
```typescript
// Always use the storage utilities, never direct localStorage/WebAPI calls
import { storageGet, storageSet, storageGetJSON, storageSetJSON } from '@/utils/storage';

// For history records
import { storageSaveHistory, storageGetHistory } from '@/utils/storage';
```

## Common Patterns & Gotchas

**Telegram SDK Integration:**
- The app runs both inside Telegram (via Mini App) and standalone as PWA
- Always check `WebApp.initDataUnsafe?.user` before accessing user data
- Theme colors must be synced with Telegram using `WebApp.setHeaderColor()` and `WebApp.setBackgroundColor()`

**Navigation Gotchas:**
- Do not use `<Link>` or `useNavigate()` for main page navigation - it won't work with the custom dock
- Use `useNavigate()` only for article detail pages and modal routes
- Main pages are switched via visibility toggling in `Layout.tsx`

**Styling:**
- Use the `cn()` utility (from `src/utils/cn.ts`) for conditional className merging
- Tailwind classes are available - prefer utility classes over custom CSS
- Dark mode is handled automatically via ThemeContext - use `dark:` prefix for dark mode styles

**Component Organization:**
- Feature components should be co-located with their feature in `src/features/*/`
- Reusable UI components go in `src/components/ui/`
- Keep components small and focused - extract complex logic into custom hooks


